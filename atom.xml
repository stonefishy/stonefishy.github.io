<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Andrewsy&#39;s Space</title>
  
  
  <link href="https://stonefishy.github.io/atom.xml" rel="self"/>
  
  <link href="https://stonefishy.github.io/"/>
  <updated>2025-02-07T03:24:32.614Z</updated>
  <id>https://stonefishy.github.io/</id>
  
  <author>
    <name>Andrewsy</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Running DeepSeek-R1 locally for free</title>
    <link href="https://stonefishy.github.io/2025/02/07/running-deepseek-r1-locally-for-free/"/>
    <id>https://stonefishy.github.io/2025/02/07/running-deepseek-r1-locally-for-free/</id>
    <published>2025-02-07T10:16:27.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/deepseek-logo.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/deepseek-logo.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" style="width:800px;"/></div></div><p>The <code>DeepSeek</code> recently is very popular. The application download is on topest of the app store globally. The deepseek has several models, like <code>deepseek-r1</code>, <code>deepseek-coder</code> and <code>deepseek-v3</code> models etc. It‚Äôs all open source and free to use.</p><ul><li><code>deepseek-r1</code>: DeepSeek‚Äôs first-generation of reasoning models with comparable performance to OpenAI-o1, including six dense models distilled from DeepSeek-R1 based on Llama and Qwen.</li><li><code>deepseek-coder</code>: It is a capable coding model trained on two trillion code and natural language tokens.</li><li><code>deepseek-v3</code>: A strong Mixture-of-Experts (MoE) language model with 671B total parameters with 37B activated for each token.</li></ul><p>Here we will run the <code>deepseek-r1</code> model locally. It‚Äôs very easy and setup it quickly. Let‚Äôs get started.</p><h2 id="Ollama-download-and-installation"><a href="#Ollama-download-and-installation" class="headerlink" title="Ollama download and installation"></a>Ollama download and installation</h2><p>The first step is to download the <code>Ollama</code> and install it on your local machine. It supports Windows, Linux and MacOS. You can download the latest version from the official website. <a href="https://ollama.com/">https://ollama.com/</a></p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/ollama.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/ollama.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Ollama" style="width:600px;"/></div><span class="image-caption">Ollama</span></div><p>After download and install it, you can check the version or commands from terminal or command-line.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Check the version of Ollama</span></span><br><span class="line">ollama --version</span><br><span class="line"></span><br><span class="line"><span class="comment">## Check the commands of Ollama</span></span><br><span class="line">ollama --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/ollama-version-commands.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/ollama-version-commands.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Ollama version and commands"/></div><span class="image-caption">Ollama version and commands</span></div><h2 id="Running-the-deepseek-r1-model"><a href="#Running-the-deepseek-r1-model" class="headerlink" title="Running the deepseek-r1 model"></a>Running the deepseek-r1 model</h2><p>Now, we can run the <code>deepseek-r1</code> model using Ollama. We need to download this model by using ollama. The <code>deepseek-r1</code> model contains serveral models, 1.5b, 7b, 8b, 14b, 32b, 70b and even 671b. For general computer performance, suggestion to use 1.5b model. I tried the 8b model on my local. It can run but the response is slowlly and memory is up to 90%. The 1.5b model running smoothly and response is fast. My local machine has 16GB RAM and i7 processor.</p><p>We can use the following command to download the <code>deepseek-r1</code> model.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama pull deepseek-r1:1.5b</span><br></pre></td></tr></table></figure><p>we also can run this model directly, if the model not exist, it will download automatically.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ollama run deepseek-r1:1.5b</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/ollama-run-deepseek-r1.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/ollama-run-deepseek-r1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Ollama run deepseek-r1"/></div><span class="image-caption">Ollama run deepseek-r1</span></div><h2 id="Ask-anything-in-deepseek"><a href="#Ask-anything-in-deepseek" class="headerlink" title="Ask anything in deepseek"></a>Ask anything in deepseek</h2><p>Now, we can ask anything in deepseek. Just type the question and press enter. The model will answer the question. See below screenshot</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/ollama-deepseek-answer-1.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/ollama-deepseek-answer-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="DeepSeek-R1 Answer"/></div><span class="image-caption">DeepSeek-R1 Answer</span></div><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/ollama-deepseek-answer-2.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/ollama-deepseek-answer-2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="DeepSeek-R1 Answer"/></div><span class="image-caption">DeepSeek-R1 Answer</span></div><p>See, it‚Äôs easy to run the <code>deepseek-r1</code> model locally. You can also run other models like <code>deepseek-coder</code> and <code>deepseek-v3</code> models, or <code>llama</code> model. The <code>Ollama</code> models contains many open source models, you can use it for free.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;img-wrap&quot;&gt;&lt;div class=&quot;img-bg&quot;&gt;&lt;img class=&quot;img lazyload placeholder&quot; src=&quot;/assets/images/ai-ml/deepseek-logo.png&quot; class=&quot;lazyload</summary>
      
    
    
    
    <category term="AI/ML" scheme="https://stonefishy.github.io/categories/AI-ML/"/>
    
    
    <category term="AI" scheme="https://stonefishy.github.io/tags/AI/"/>
    
    <category term="Ollama" scheme="https://stonefishy.github.io/tags/Ollama/"/>
    
    <category term="DeepSeek" scheme="https://stonefishy.github.io/tags/DeepSeek/"/>
    
  </entry>
  
  <entry>
    <title>A RAG Chatbot base on Azure OpenAI</title>
    <link href="https://stonefishy.github.io/2025/01/23/rag-chatbot-base-on-azure-openai/"/>
    <id>https://stonefishy.github.io/2025/01/23/rag-chatbot-base-on-azure-openai/</id>
    <published>2025-01-23T11:31:28.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In this article, we will build a <code>RAG (Retrieval-Augmented Generation)</code> chatbot using Azure OpenAI‚Äôs GPT-4 language model. We will use <code>Python</code>, <code>LangChain</code> and the <code>Streamlit</code> library to build the chatbot interface. Vector store will use <code>FAISS</code> library to store the text chunks and metadata.</p><h2 id="What-is-RAG"><a href="#What-is-RAG" class="headerlink" title="What is RAG?"></a>What is RAG?</h2><p><code>RAG</code> is a technique that combines retrieval-based methods with generative models to enhance the quality and relevance of the information produced by AI systems. Here‚Äôs a breakdown of the two components:</p><ol><li><p><strong>Retrieval</strong>: The model first retrieves relevant documents, text, or data from a knowledge base, database, or external source using information retrieval techniques. This allows the model to access specialized or domain-specific knowledge, which it might not have inherently learned during training.</p></li><li><p><strong>Generation</strong>: After retrieving relevant information, the model then uses a generative language model (like GPT-3 or GPT-4) to create a response that is coherent, contextually appropriate, and informed by the retrieved content. This allows the AI to answer questions, generate text, or assist in decision-making with enhanced accuracy and knowledge.</p></li></ol><h2 id="Technical-Stack"><a href="#Technical-Stack" class="headerlink" title="Technical Stack"></a>Technical Stack</h2><p>To build the chatbot, we will use the following techiniques:</p><ul><li><strong>Azure OpenAI GPT-4</strong>: We will use the GPT-4 language model from Azure OpenAI to generate responses. GPT-4 is a transformer-based language model that is capable of generating coherent and diverse text.</li><li><strong>LangChain</strong>: LangChain is a Python library that allows us to use the GPT-4 model from Azure OpenAI in our chatbot. LangChain provides a simple interface for building chatbots using GPT-4.</li><li><strong>Streamlit</strong>: We will use Streamlit to build the chatbot interface. Streamlit is a framework for building web applications in Python. It allows us to create a user-friendly interface for our chatbot.</li><li><strong>FAISS</strong>: FAISS (Facebook AI Similarity Search) is an open-source library developed by Facebook AI Research. It‚Äôs designed for efficient similarity search and clustering of high-dimensional data, such as vectors. The primary use case for FAISS is in applications where you need to search for the most similar items to a given query item in large datasets of vectors</li></ul><h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><p>Before we start, make sure you have the following prerequisites:</p><ul><li>An Azure account</li><li>Python 3.6 or higher</li><li>An IDE or text editor</li><li>A knowledge base or dataset of relevant information</li></ul><h2 id="Setting-up-the-Environment"><a href="#Setting-up-the-Environment" class="headerlink" title="Setting up the Environment"></a>Setting up the Environment</h2><p>To set up the environment, we will need to install the following important libraries:</p><ul><li>LangChain</li><li>Streamlit</li><li>Azure OpenAI GPT-4</li></ul><p>And also include the <code>FAISS</code> and <code>PyPDF2</code> libraries. The <code>FAISS</code> library is used for efficient similarity search, and the <code>PyPDF2</code> library is used to extract text from PDF files.</p><p>Below is the entire python libraries:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">streamlit==1.40.0</span><br><span class="line">PyPDF2==3.0.1</span><br><span class="line">faiss-cpu==1.9.0</span><br><span class="line">openai==1.59.6</span><br><span class="line">tiktoken==0.8.0</span><br><span class="line">langchain==0.3.14</span><br><span class="line">langchain-community==0.3.14</span><br><span class="line">langchain-core==0.3.29</span><br><span class="line">langchain-openai==0.3.0</span><br><span class="line">langchain-text-splitters==0.3.5</span><br></pre></td></tr></table></figure><h2 id="Process-PDFs"><a href="#Process-PDFs" class="headerlink" title="Process PDFs"></a>Process PDFs</h2><p>Here we will read the PDF files and extract the text from them. We will use the <code>PyPDF2</code> library to extract the text from the PDF files. And then save it into local vector store which can be used for similarity search by FAISS. The entire code is below:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> PyPDF2 <span class="keyword">import</span> PdfReader</span><br><span class="line"><span class="keyword">from</span> langchain.text_splitter <span class="keyword">import</span> RecursiveCharacterTextSplitter</span><br><span class="line"><span class="keyword">from</span> langchain_community.vectorstores <span class="keyword">import</span> FAISS</span><br><span class="line"><span class="keyword">from</span> langchain_openai <span class="keyword">import</span> AzureOpenAIEmbeddings</span><br><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line"><span class="keyword">import</span> config</span><br><span class="line"></span><br><span class="line">load_dotenv()</span><br><span class="line"></span><br><span class="line">azure_endpoint = os.getenv(<span class="string">&quot;AZURE_OPENAI_ENDPOINT&quot;</span>)</span><br><span class="line">api_version = os.getenv(<span class="string">&quot;AZURE_OPENAI_API_VERSION&quot;</span>)</span><br><span class="line">api_key = os.getenv(<span class="string">&quot;OPENAI_API_KEY&quot;</span>)</span><br><span class="line">embedding_deployment = os.getenv(<span class="string">&quot;AZURE_OPENAI_EMBEDDING_DEPLOYMENT&quot;</span>)</span><br><span class="line">chat_deployment = os.getenv(<span class="string">&quot;AZURE_OPENAI_CHAT_DEPLOYMENT&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">embeddings</span>():</span><br><span class="line">    <span class="comment"># generating embedding</span></span><br><span class="line">    <span class="keyword">return</span> AzureOpenAIEmbeddings(</span><br><span class="line">        azure_deployment=embedding_deployment,</span><br><span class="line">        api_version=api_version,</span><br><span class="line">        api_key=api_key,</span><br><span class="line">        azure_endpoint=azure_endpoint)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_files</span>(<span class="params">directory</span>):</span><br><span class="line">    path = Path(os.path.join(os.getcwd(), directory))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> path.exists():</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">f&quot;Directory <span class="subst">&#123;path.absolute()&#125;</span> does not exist&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">str</span>(file) <span class="keyword">for</span> file <span class="keyword">in</span> path.rglob(<span class="string">&quot;*&quot;</span>) <span class="keyword">if</span> file.is_file()]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_pdfs</span>(<span class="params">pdfs_directory, vector_store_folder_path, vector_store_index_name</span>):</span><br><span class="line">    pdf_files = get_all_files(pdfs_directory)</span><br><span class="line">    text = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> pdf_file <span class="keyword">in</span> pdf_files:</span><br><span class="line">        <span class="comment"># Read pdf file</span></span><br><span class="line">        pdf_reader = PdfReader(pdf_file)</span><br><span class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> pdf_reader.pages:</span><br><span class="line">            text += page.extract_text()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Break it into chunks</span></span><br><span class="line">    text_splitter = RecursiveCharacterTextSplitter(</span><br><span class="line">        separators=<span class="string">&quot;\n&quot;</span>,</span><br><span class="line">        chunk_size=<span class="number">1000</span>,</span><br><span class="line">        chunk_overlap=<span class="number">150</span>,</span><br><span class="line">        length_function=<span class="built_in">len</span></span><br><span class="line">    )</span><br><span class="line">    chunks = text_splitter.split_text(text)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Creating vector store - FAISS</span></span><br><span class="line">    vector_store = FAISS.from_texts(chunks, embeddings())</span><br><span class="line">    vector_store.save_local(vector_store_folder_path, vector_store_index_name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Processed PDF documents to vector store path `<span class="subst">&#123;vector_store_folder_path&#125;</span>`&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    process_pdfs(config.pdfs_directory, config.vector_store_folder_path, config.vector_store_index_name)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>In above code, we are reading the PDF files and extracting the text from them. We are using the <code>RecursiveCharacterTextSplitter</code> to break the text into chunks of 1000 characters with 150 characters overlap. And then using the <code>FAISS</code> library to create a vector store of the text chunks. The vector store is saved in the local file system. The vector store files contains two files (<code>*.faiss</code> and <code>*.pkl</code>) which can be used for similarity search.</p><p>The <code>*.faiss</code> file contains the vector representation of the text chunks. The <code>*.pkl</code> file contains the metadata of the text chunks.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/rag-chatbot-vector-store.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/rag-chatbot-vector-store.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="RAG Chatbot Vector Store"/></div><span class="image-caption">RAG Chatbot Vector Store</span></div><p>You may noticing that we are using the <code>dotenv</code> library to load the environment variables. You can create a <code>.env</code> file in the root directory of your project and add the following variables:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AZURE_OPENAI_ENDPOINT=&lt;your_endpoint_url&gt;</span><br><span class="line">AZURE_OPENAI_API_VERSION=&lt;your_api_version&gt;</span><br><span class="line">OPENAI_API_KEY=&lt;your_api_key?</span><br><span class="line">AZURE_OPENAI_CHAT_DEPLOYMENT=gpt-4o # we are using gpt-4o model, you can use any other model which you deployed in your endpoint.</span><br><span class="line">AZURE_OPENAI_EMBEDDING_DEPLOYMENT=text-embedding-ada-002 # we are using text-embedding-ada-002 model.</span><br></pre></td></tr></table></figure><h2 id="Building-the-Chatbot"><a href="#Building-the-Chatbot" class="headerlink" title="Building the Chatbot"></a>Building the Chatbot</h2><p>After we have processed the PDF files and created the vector store, we can now build the chatbot using LangChain.</p><p>First, we will create a <code>LangChain</code> instance and load the vector store. Using <code>FAISS.load_local</code> method, we can load the vector store from the local file system with the same embeddings model.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">embeddings</span>():</span><br><span class="line">    <span class="comment"># generating embedding</span></span><br><span class="line">    <span class="keyword">return</span> AzureOpenAIEmbeddings(</span><br><span class="line">        azure_deployment=embedding_deployment,</span><br><span class="line">        api_version=api_version,</span><br><span class="line">        api_key=api_key,</span><br><span class="line">        azure_endpoint=azure_endpoint)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_vector_store</span>(<span class="params">vector_store_folder_path, vectore_store_name</span>):</span><br><span class="line">    vector_store = FAISS.load_local(</span><br><span class="line">        folder_path=vector_store_folder_path, </span><br><span class="line">        embeddings=embeddings(), </span><br><span class="line">        index_name=vectore_store_name,</span><br><span class="line">        allow_dangerous_deserialization=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> vector_store </span><br></pre></td></tr></table></figure><p>Then, we will create a <code>AzureChatOpenAI</code> instance and load the chatbot model. We will use the <code>AzureChatOpenAI</code> class to interact with the GPT-4 model from Azure OpenAI. Using <code>load_qa_chain</code> method which is provided by <code>LangChain</code>, we can load the chatbot model from the Azure OpenAI.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generateChain</span>():</span><br><span class="line">    llm =  AzureChatOpenAI(</span><br><span class="line">        azure_endpoint=azure_endpoint,</span><br><span class="line">        api_key=api_key,</span><br><span class="line">        api_version=api_version,</span><br><span class="line">        azure_deployment=chat_deployment,</span><br><span class="line">        temperature=<span class="number">0</span>,</span><br><span class="line">        max_tokens=<span class="number">1000</span>,</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># chain -&gt; take the question, get relevant document, pass it to the LLM, generate the output</span></span><br><span class="line">    chain = load_qa_chain(llm, chain_type=<span class="string">&quot;stuff&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> chain</span><br></pre></td></tr></table></figure><p>After the chain and the vector store are loaded, we can use FAISS vector store to similarity search the user input and retrieve the most relevant document. Passing the retrieved document to the LangChain chain which loads the AzureChatOpenAI to generate the response. Below is core code:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vector_store = load_vector_store(config.vector_store_folder_path, config.vector_store_index_name)</span><br><span class="line">chain = generateChain()</span><br><span class="line">match_documents = vector_store.similarity_search(prompt)</span><br><span class="line">response = chain.run(input_documents = match_documents, question = prompt)</span><br></pre></td></tr></table></figure><p>The <code>chain.run</code> method takes the input documents and the question as input and returns the generated response. The <code>match_documents</code> variable contains the most relevant documents retrieved from the vector store. The <code>response</code> variable contains the generated response from the chatbot.</p><p>Finally, we will create a Streamlit interface to interact with the chatbot. We will use the <code>streamlit</code> library to create a user-friendly interface for our chatbot. For the <code>streamlit</code> library usage, you can refer to the official documentation. <a href="https://docs.streamlit.io/">https://docs.streamlit.io/</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    st.set_page_config(</span><br><span class="line">        page_title=<span class="string">&quot;JBL Products Chatbot&quot;</span>,</span><br><span class="line">        page_icon=<span class="string">&quot;üßä&quot;</span>,</span><br><span class="line">        layout=<span class="string">&quot;centered&quot;</span>,</span><br><span class="line">        initial_sidebar_state=<span class="string">&quot;expanded&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    st.header(<span class="string">&quot;JBL Products Chatbot&quot;</span>)</span><br><span class="line">    vector_store = load_vector_store(config.vector_store_folder_path, config.vector_store_index_name)</span><br><span class="line">    chain = generateChain()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> st.chat_message(<span class="string">&quot;assistant&quot;</span>):</span><br><span class="line">        st.markdown(<span class="string">&quot;Ask me anything about JBL devices (JBL Pulse 5, JBL Clip 5, JBL Bar 500)&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;messages&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> st.session_state:</span><br><span class="line">        st.session_state.messages = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> message <span class="keyword">in</span> st.session_state.messages:</span><br><span class="line">        <span class="keyword">with</span> st.chat_message(message[<span class="string">&quot;role&quot;</span>]):</span><br><span class="line">            st.markdown(message[<span class="string">&quot;content&quot;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> prompt := st.chat_input(<span class="string">&quot;Ask me something&quot;</span>):</span><br><span class="line">        st.chat_message(<span class="string">&quot;user&quot;</span>).markdown(prompt)</span><br><span class="line">        st.session_state.messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;)</span><br><span class="line"></span><br><span class="line">        response = <span class="string">&quot;I am thinking...&quot;</span></span><br><span class="line">        <span class="keyword">with</span> st.spinner(response):</span><br><span class="line">            match_documents = vector_store.similarity_search(prompt)</span><br><span class="line">            response = chain.run(input_documents = match_documents, question = prompt)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> st.chat_message(<span class="string">&quot;assistant&quot;</span>):</span><br><span class="line">            st.write_stream(generate_stream(response))</span><br><span class="line">        st.session_state.messages.append(&#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;assistant&quot;</span>, <span class="string">&quot;content&quot;</span>: response&#125;)</span><br></pre></td></tr></table></figure><p>In above code, we are using the <code>st.chat_message</code> method to create a chat message with a specific role, using the <code>st.chat_input</code> method to get the user input. And using the <code>st.spinner</code> method to show a loading spinner while the chatbot is generating the response. Finally using the <code>st.write_stream</code> method to write the response to the chat message.</p><p>For the stream response, actually we mock it by using the <code>generate_stream</code> method. This method is used to generate the stream response. We can use the <code>st.write_stream</code> method to write the stream response to the chat message. This will let the chatbot to print word one by one in the chat message.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">generate_stream</span>(<span class="params">response</span>):</span><br><span class="line">    <span class="comment"># generate the stream of messages</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> response.split(<span class="string">&quot; &quot;</span>):</span><br><span class="line">        <span class="keyword">yield</span> word + <span class="string">&quot; &quot;</span></span><br><span class="line">        time.sleep(<span class="number">0.05</span>)</span><br></pre></td></tr></table></figure><p>Below is chatbot conversational interface:</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/rag-chatbot-streamlit-interface.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/rag-chatbot-streamlit-interface.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="RAG Chatbot Streamlit Interface"/></div><span class="image-caption">RAG Chatbot Streamlit Interface</span></div><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this article, we have built a <code>RAG (Retrieval-Augmented Generation)</code> chatbot using Azure OpenAI‚Äôs GPT-4 language model. We have used Python, LangChain and the Streamlit library to build the chatbot interface. We have also processed the PDF files and created the vector store using FAISS library. The pdf files is crawled from the website <a href="https://www.manua.ls/">https://www.manua.ls</a></p><p>For the entire code, you can refer to the Github repository: <a href="https://github.com/stonefishy/rag-chatbot">https://github.com/stonefishy/rag-chatbot</a>. Please don‚Äôt forget to star the repository if you find it useful. Thank you for reading.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;&lt;p&gt;In this article, we will build</summary>
      
    
    
    
    <category term="AI/ML" scheme="https://stonefishy.github.io/categories/AI-ML/"/>
    
    
    <category term="AI" scheme="https://stonefishy.github.io/tags/AI/"/>
    
    <category term="Python" scheme="https://stonefishy.github.io/tags/Python/"/>
    
    <category term="OpenAI" scheme="https://stonefishy.github.io/tags/OpenAI/"/>
    
    <category term="LangChain" scheme="https://stonefishy.github.io/tags/LangChain/"/>
    
    <category term="Chatbot" scheme="https://stonefishy.github.io/tags/Chatbot/"/>
    
    <category term="Streamlit" scheme="https://stonefishy.github.io/tags/Streamlit/"/>
    
    <category term="FAISS" scheme="https://stonefishy.github.io/tags/FAISS/"/>
    
  </entry>
  
  <entry>
    <title>How to use Paho MQTT Client Lib in Python3</title>
    <link href="https://stonefishy.github.io/2025/01/06/how-to-use-paho-mqtt-client-lib-in-python3/"/>
    <id>https://stonefishy.github.io/2025/01/06/how-to-use-paho-mqtt-client-lib-in-python3/</id>
    <published>2025-01-06T14:57:57.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<p>The <code>Paho MQTT client</code> library for Python is a popular choice for building MQTT applications in Python. Here‚Äôs how to use it in Python3. <code>Paho MQTT Client</code> provides a simple and easy-to-use API for publishing and subscribing to MQTT topics. It supports MQTT 5.0, 3.1.1, and 3.1 protocols.</p><h2 id="Install-Paho-MQTT-Client"><a href="#Install-Paho-MQTT-Client" class="headerlink" title="Install Paho MQTT Client"></a>Install Paho MQTT Client</h2><p>To install <code>Paho MQTT Client</code> library, you can use the following command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install paho-mqtt</span><br></pre></td></tr></table></figure><h2 id="Prepare-the-MQTT-Broker"><a href="#Prepare-the-MQTT-Broker" class="headerlink" title="Prepare the MQTT Broker"></a>Prepare the MQTT Broker</h2><p>Before using the <code>Paho MQTT Client</code> library, we need to prepare the MQTT broker. We can use any MQTT broker that supports the MQTT 5.0, 3.1.1, or 3.1 protocols. Here we use the public free MQTT broker: <code>EMQX</code>, below is broker information.</p><blockquote><p>ServerÔºöbroker.emqx.io<br>TCP PortÔºö1883<br>WebSocket PortÔºö8083<br>SSL&#x2F;TLS PortÔºö8883<br>Secure WebSocket PortÔºö8084</p></blockquote><h2 id="Import-Paho-MQTT-Client"><a href="#Import-Paho-MQTT-Client" class="headerlink" title="Import Paho MQTT Client"></a>Import Paho MQTT Client</h2><p>To use the <code>Paho MQTT Client</code> library in the Python code, need to import it first.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> paho.mqtt <span class="keyword">import</span> client <span class="keyword">as</span> mqtt_client</span><br></pre></td></tr></table></figure><h2 id="Create-a-MQTT-Connection"><a href="#Create-a-MQTT-Connection" class="headerlink" title="Create a MQTT Connection"></a>Create a MQTT Connection</h2><p>Before create a MQTT connection, specify the MQTT client id, MQTT broker address, port and mesage topic. We can use the python <code>random.randint()</code> function to generate a random client id.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">broker = <span class="string">&quot;broker.emqx.io&quot;</span></span><br><span class="line">port = <span class="number">1883</span></span><br><span class="line">topic = <span class="string">&quot;paho/mqtt/test&quot;</span></span><br><span class="line">client_id = <span class="string">f&quot;client_<span class="subst">&#123;random.randint(<span class="number">0</span>, <span class="number">1000</span>)&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><p>Next, we need to write the <code>on_connect</code> callback function in order to connect to the proxy. This function is called after the client successfully connects, we can use the <code>rc</code> parameter to check the connection status. Typically, we also create a client object that is also connected to ‚Äúbroker.emqx.io‚Äù.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">connect_mqtt</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_connect</span>(<span class="params">client, userdata, flags, reason_code, properties</span>):</span><br><span class="line">        <span class="keyword">if</span> reason_code == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Connected to MQTT Broker!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to connect, return code %d\n&quot;</span>, reason_code)</span><br><span class="line">    client = mqtt_client.Client(client_id=client_id, callback_api_version=mqtt_client.CallbackAPIVersion.VERSION2)</span><br><span class="line"></span><br><span class="line">    client.on_connect = on_connect</span><br><span class="line">    client.connect(broker, port)</span><br><span class="line">    <span class="keyword">return</span> client</span><br></pre></td></tr></table></figure><p>When execute the <code>connect_mqtt()</code> function, it will return a <code>Client</code> instance that is connected to the MQTT broker, and printed the connection status.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/mqtt/mqtt-connected.png" class="lazyload placeholder" data-srcset="/assets/images/mqtt/mqtt-connected.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="MQTT Connected to Broker"/></div><span class="image-caption">MQTT Connected to Broker</span></div><h2 id="Publish-Messages-to-MQTT-Topics"><a href="#Publish-Messages-to-MQTT-Topics" class="headerlink" title="Publish Messages to MQTT Topics"></a>Publish Messages to MQTT Topics</h2><p>publish messages to MQTT topics, let‚Äôs create a <code>publish()</code> function that will publish a message to the specified topic every second. Using <code>client.publish()</code> method, we can publish a message to the specified topic.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">publish</span>(<span class="params">client</span>):</span><br><span class="line">    msg_count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        msg = <span class="string">f&quot;messages: test <span class="subst">&#123;msg_count&#125;</span>&quot;</span></span><br><span class="line">        result = client.publish(topic, msg)</span><br><span class="line">        status = result[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Send `<span class="subst">&#123;msg&#125;</span>` to topic `<span class="subst">&#123;topic&#125;</span>`&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to send message to topic <span class="subst">&#123;topic&#125;</span>&quot;</span>)</span><br><span class="line">        msg_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> msg_count &gt; <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/mqtt/mqtt-publish.png" class="lazyload placeholder" data-srcset="/assets/images/mqtt/mqtt-publish.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="MQTT Publish Message"/></div><span class="image-caption">MQTT Publish Message</span></div><h2 id="Subscribe-to-MQTT-Topics"><a href="#Subscribe-to-MQTT-Topics" class="headerlink" title="Subscribe to MQTT Topics"></a>Subscribe to MQTT Topics</h2><p>To subscribe to MQTT topics, we can call the <code>subscribe()</code> method of the <code>Client</code> instance. We can define a callback function that will be called when a message is received on a subscribed topic. The callback function <code>on_message()</code> will be called when a message is received on the subscribed topic.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">subscribe</span>(<span class="params">client: mqtt_client</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">client, userdata, msg</span>):</span><br><span class="line">        <span class="built_in">print</span>(msg)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Received `<span class="subst">&#123;msg.payload.decode()&#125;</span>` which sent by `<span class="subst">&#123;client._client_id&#125;</span>` from `<span class="subst">&#123;msg.topic&#125;</span>` topic&quot;</span>)</span><br><span class="line"></span><br><span class="line">    client.subscribe(topic)</span><br><span class="line">    client.on_message = on_message</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/mqtt/mqtt-subscribe.png" class="lazyload placeholder" data-srcset="/assets/images/mqtt/mqtt-subscribe.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="MQTT Subscribe Message"/></div><span class="image-caption">MQTT Subscribe Message</span></div><h2 id="Run-the-MQTT-Client"><a href="#Run-the-MQTT-Client" class="headerlink" title="Run the MQTT Client"></a>Run the MQTT Client</h2><p>To run the MQTT client, we can use <code>loop_start()</code> method to run the client in a separate thread, <code>loop_stop()</code> method to stop the client loop. We also can call the <code>loop_forever()</code> method of the <code>Client</code> instance. This method will block the current thread and run the client indefinitely. </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">client.loop_start() <span class="comment"># start the client loop</span></span><br><span class="line">client.loop_stop() <span class="comment"># stop the client loop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">client.loop_forever() <span class="comment"># block the current thread and run the client indefinitely</span></span><br></pre></td></tr></table></figure><h2 id="Full-Code"><a href="#Full-Code" class="headerlink" title="Full Code"></a>Full Code</h2><p>Here‚Äôs the full code that uses the <code>Paho MQTT Client</code> library to connect to the MQTT broker, publish messages to a topic, and subscribe to a topic.</p><h3 id="client1-py"><a href="#client1-py" class="headerlink" title="client1.py"></a>client1.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> paho.mqtt <span class="keyword">import</span> client <span class="keyword">as</span> mqtt_client</span><br><span class="line"></span><br><span class="line">broker = <span class="string">&quot;broker.emqx.io&quot;</span></span><br><span class="line">port = <span class="number">1883</span></span><br><span class="line">topic = <span class="string">&quot;paho/mqtt/test&quot;</span></span><br><span class="line">client_id = <span class="string">f&quot;client_<span class="subst">&#123;random.randint(<span class="number">0</span>, <span class="number">1000</span>)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect_mqtt</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_connect</span>(<span class="params">client, userdata, flags, reason_code, properties</span>):</span><br><span class="line">        <span class="keyword">if</span> reason_code == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Connected to MQTT Broker!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to connect, return code %d\n&quot;</span>, reason_code)</span><br><span class="line">    client = mqtt_client.Client(client_id=client_id, callback_api_version=mqtt_client.CallbackAPIVersion.VERSION2)</span><br><span class="line"></span><br><span class="line">    client.on_connect = on_connect</span><br><span class="line">    client.connect(broker, port)</span><br><span class="line">    <span class="keyword">return</span> client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">publish</span>(<span class="params">client</span>):</span><br><span class="line">    msg_count = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        msg = <span class="string">f&quot;messages: test <span class="subst">&#123;msg_count&#125;</span>&quot;</span></span><br><span class="line">        result = client.publish(topic, msg)</span><br><span class="line">        status = result[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> status == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Send `<span class="subst">&#123;msg&#125;</span>` to topic `<span class="subst">&#123;topic&#125;</span>`&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Failed to send message to topic <span class="subst">&#123;topic&#125;</span>&quot;</span>)</span><br><span class="line">        msg_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> msg_count &gt; <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    client = connect_mqtt()</span><br><span class="line">    client.loop_start()</span><br><span class="line">    publish(client)</span><br><span class="line">    client.loop_stop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run()</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="client2-py"><a href="#client2-py" class="headerlink" title="client2.py"></a>client2.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> paho.mqtt <span class="keyword">import</span> client <span class="keyword">as</span> mqtt_client</span><br><span class="line"></span><br><span class="line">broker = <span class="string">&quot;broker.emqx.io&quot;</span></span><br><span class="line">port = <span class="number">1883</span></span><br><span class="line">topic = <span class="string">&quot;paho/mqtt/test&quot;</span></span><br><span class="line">client_id = <span class="string">f&quot;client_<span class="subst">&#123;random.randint(<span class="number">0</span>, <span class="number">1000</span>)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">connect_mqtt</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_connect</span>(<span class="params">client, userdata, flags, reason_code, properties</span>):</span><br><span class="line">        <span class="keyword">if</span> reason_code == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Connected to MQTT Broker!&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Failed to connect, return code %d\n&quot;</span>, reason_code)</span><br><span class="line">    client = mqtt_client.Client(client_id=client_id, callback_api_version=mqtt_client.CallbackAPIVersion.VERSION2)</span><br><span class="line"></span><br><span class="line">    client.on_connect = on_connect</span><br><span class="line">    client.connect(broker, port)</span><br><span class="line">    <span class="keyword">return</span> client</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">subscribe</span>(<span class="params">client: mqtt_client</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_message</span>(<span class="params">client, userdata, msg</span>):</span><br><span class="line">        <span class="built_in">print</span>(msg)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Received `<span class="subst">&#123;msg.payload.decode()&#125;</span>` which sent by `<span class="subst">&#123;client._client_id&#125;</span>` from `<span class="subst">&#123;msg.topic&#125;</span>` topic&quot;</span>)</span><br><span class="line"></span><br><span class="line">    client.subscribe(topic)</span><br><span class="line">    client.on_message = on_message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    client = connect_mqtt()</span><br><span class="line">    subscribe(client)</span><br><span class="line">    client.loop_forever()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure><p>That‚Äôs it! You can now use the <code>Paho MQTT Client</code> library to build MQTT applications in Python3.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;The &lt;code&gt;Paho MQTT client&lt;/code&gt; library for Python is a popular choice for building MQTT applications in Python. Here‚Äôs how to use it i</summary>
      
    
    
    
    
    <category term="Python" scheme="https://stonefishy.github.io/tags/Python/"/>
    
    <category term="MQTT" scheme="https://stonefishy.github.io/tags/MQTT/"/>
    
    <category term="IoT" scheme="https://stonefishy.github.io/tags/IoT/"/>
    
  </entry>
  
  <entry>
    <title>The Ultimate MQTT Client Tool - MQTTX</title>
    <link href="https://stonefishy.github.io/2024/12/31/the-ultimate-mqtt-client-tool-mqttx/"/>
    <id>https://stonefishy.github.io/2024/12/31/the-ultimate-mqtt-client-tool-mqttx/</id>
    <published>2024-12-31T14:42:10.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<p>In the world of <code>IoT (Internet of Things)</code>, <code>MQTT (Message Queuing Telemetry Transport)</code> is a popular lightweight messaging protocol that ensures efficient communication between devices, servers, and clients. MQTT is favored for its low-bandwidth requirements and its ability to work in low network environments. However, testing and debugging MQTT-based applications can be challenging without the right tools.</p><p>Today we‚Äôre talking about one such tool called <code>MQTTX</code>. MQTTX is a cross platform, open-source MQTT client tool that provides a user-friendly interface for testing and debugging MQTT-based applications. It supports multiple MQTT brokers, including EMQX, Mosquitto, HiveMQ, and others, and provides a range of features such as message history, message filtering, and more. It is available for multiple platforms, including <code>Windows</code>, <code>macOS</code>, and <code>Linux</code>.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-tool.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-tool.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="MQTTX tool" style="width:800px;"/></div><span class="image-caption">MQTTX tool</span></div><p>MQTTX supports all versions of the MQTT protocol, from MQTT 3.1.1 to MQTT 5.0, which makes it suitable for a wide range of use cases, from simple applications to advanced IoT systems.</p><h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><p>Let‚Äôs using MQTTX to test and debug an MQTT-based application. We‚Äôll use the <code>EMQX</code> MQTT broker for this example. And here we using Web version of MQTTX. The web client is <a href="https://mqttx.app/web-client">https://mqttx.app/web-client</a>.</p><p>The public <code>EMQX</code> server information is as follows:</p><blockquote><p><strong>Server</strong>: broker.emqx.io</p><p><strong>TCP Port</strong>: 1883</p><p><strong>WebSocket Port</strong>: 8083</p><p><strong>SSL&#x2F;TLS Port</strong>: 8883</p><p><strong>Secure WebSocket Port</strong>: 8084</p></blockquote><h3 id="Create-a-New-Connection"><a href="#Create-a-New-Connection" class="headerlink" title="Create a New Connection"></a>Create a New Connection</h3><p>Open web client of MQTTX and click on the <code>+</code> button on the top-left corner to create a new connection.  Naming the connection as ‚Äòcloudserver‚Äô, and keep to using <code>EMQX</code> as the broker.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-create-connection.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-create-connection.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Create a new connection" style="width:800px;"/></div><span class="image-caption">Create a new connection</span></div><h3 id="Subscribe-to-a-Topic"><a href="#Subscribe-to-a-Topic" class="headerlink" title="Subscribe to a Topic"></a>Subscribe to a Topic</h3><p>Once the connection is established, we can subscribe to a topic by clicking on the <code>New Subscription</code> button. Let‚Äôs subscribe to the topic <code>test/temperature</code>. </p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-subscribe-topic.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-subscribe-topic.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Create a subscription to a topic" style="width:800px;"/></div><span class="image-caption">Create a subscription to a topic</span></div><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-subscribe-topic2.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-subscribe-topic2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Subscribe to a topic" style="width:800px;"/></div><span class="image-caption">Subscribe to a topic</span></div><h3 id="Create-two-new-clients"><a href="#Create-two-new-clients" class="headerlink" title="Create two new clients"></a>Create two new clients</h3><p>Now, let‚Äôs create two new clients connection, naming as <code>sensor1</code> and <code>sensor2</code>. Both clients will subscribe to the same topic <code>test/resp</code>.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-create-clients.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-create-clients.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Create new clients" style="width:800px;"/></div><span class="image-caption">Create new clients</span></div><h3 id="Publish-a-Message"><a href="#Publish-a-Message" class="headerlink" title="Publish a Message"></a>Publish a Message</h3><p>Let‚Äôs publish a message which using JSON format from <code>sensor1</code> to the topic <code>test/temperature</code>. And we can see the message is received by <code>sensor1</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Topic: </span><br><span class="line">test/temperature</span><br><span class="line"></span><br><span class="line">Message:</span><br><span class="line">&#123;&quot;id&quot;: &quot;sensor1&quot;, &quot;value&quot;: &quot;2&quot;&#125;</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-publish-message.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-publish-message.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Publish a message" style="width:800px;"/></div><span class="image-caption">Publish a message</span></div><p>We can see the ‚Äòcloudserver‚Äô client which subscribed the topic <code>test/temperature</code> received the message.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-message-received.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-message-received.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Message received" style="width:800px;"/></div><span class="image-caption">Message received</span></div><p>In ‚Äòcloudserver‚Äô client, we also can send the message to the topic <code>test/resp</code>. Then both <code>sensor1</code> and <code>sensor2</code> will receive the message.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Topic:</span><br><span class="line">test/resp</span><br><span class="line"></span><br><span class="line">Message:</span><br><span class="line">&#123;&quot;id&quot;: &quot;cloudserver&quot;, &quot;value&quot;: &quot;100&quot;&#125;</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-publish-message2.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-publish-message2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Publish a message to a topic" style="width:800px;"/></div><span class="image-caption">Publish a message to a topic</span></div><h3 id="Topic-with-Wildcard"><a href="#Topic-with-Wildcard" class="headerlink" title="Topic with Wildcard"></a>Topic with Wildcard</h3><p>The MQTT protocol forwards messages based on the topic. Topics are hierarchical by <code>/</code>, similar to URL paths, for example:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chat/room/1</span><br><span class="line"></span><br><span class="line">sensor/10/temperature</span><br><span class="line"></span><br><span class="line">sensor/+/temperature</span><br></pre></td></tr></table></figure><p>MQTT topics support two wildcards: <code>+</code> and <code>#</code>.</p><p><strong>+</strong>: Represents a single-layer wildcard, such as A&#x2F;+ matching A&#x2F;X or A&#x2F;Y.<br><strong>#</strong>: Represents a multi-layered wildcard, e.g. A&#x2F;# matches A&#x2F;X, A&#x2F;B&#x2F;C&#x2F;D.</p><blockquote><p>Note: Wildcard topics can only be used for subscriptions, not for publishing.</p></blockquote><p>Let‚Äôs update the subscription of <code>cloudserver</code> client to subscribe to the topic <code>test/+/temperature</code>. This will match all topics that start with <code>test/</code> and end with <code>temperature</code>. And using <code>sensor1</code> client to publish a message to the topic <code>test/1/temperature</code>, <code>sensor2</code> client to publish a message to the topic <code>test/2/temperature</code>.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-subscribe-topic3.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-subscribe-topic3.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Subscribe to a topic with wildcard" style="width:800px;"/></div><span class="image-caption">Subscribe to a topic with wildcard</span></div><p>As you can see the <code>cloudserver</code> client received both messages.</p><p>The MQTTX tool provides QoS, message retained and more features for testing and debugging MQTT-based applications. You can test and debug your MQTT-based applications using MQTTX.</p><h2 id="Client-Version"><a href="#Client-Version" class="headerlink" title="Client Version"></a>Client Version</h2><p>The MQTTX tool client version includes more features such as topic tree visualization.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/mqttx-topic-tree.png" class="lazyload placeholder" data-srcset="/assets/images/tools/mqttx-topic-tree.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Topic tree visualization" style="width:800px;"/></div><span class="image-caption">Topic tree visualization</span></div><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>MQTTX is a powerful and user-friendly MQTT client tool that provides a range of features for testing and debugging MQTT-based applications. It supports multiple MQTT brokers, including EMQX, Mosquitto, HiveMQ, and others, and provides a cross-platform client for Windows, macOS, and Linux.   </p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;In the world of &lt;code&gt;IoT (Internet of Things)&lt;/code&gt;, &lt;code&gt;MQTT (Message Queuing Telemetry Transport)&lt;/code&gt; is a popular lightweight m</summary>
      
    
    
    
    <category term="Tools" scheme="https://stonefishy.github.io/categories/Tools/"/>
    
    
    <category term="MQTT" scheme="https://stonefishy.github.io/tags/MQTT/"/>
    
    <category term="IoT" scheme="https://stonefishy.github.io/tags/IoT/"/>
    
  </entry>
  
  <entry>
    <title>ÊµÖË∞àÁâ©ËÅîÁΩëIoT‰∏≠Â∏∏ËßÅÁöÑÊ∂àÊÅØ‰º†ËæìÂçèËÆÆMQTT</title>
    <link href="https://stonefishy.github.io/2024/12/30/what-is-mqtt-and-how-it-works/"/>
    <id>https://stonefishy.github.io/2024/12/30/what-is-mqtt-and-how-it-works/</id>
    <published>2024-12-30T15:02:06.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<h2 id="‰ªÄ‰πàÊòØMQTTÔºü"><a href="#‰ªÄ‰πàÊòØMQTTÔºü" class="headerlink" title="‰ªÄ‰πàÊòØMQTTÔºü"></a>‰ªÄ‰πàÊòØMQTTÔºü</h2><p><code>MQTT ÔºàMessage Queuing Telemetry Transport, Ê∂àÊÅØÈòüÂàóÈÅ•Êµã‰º†ËæìÂçèËÆÆÔºâ</code>ÊòØ‰∏ÄÁßçÂü∫‰∫é<code>ÂèëÂ∏É/ËÆ¢ÈòÖÔºàPublish/SubscribeÔºâ</code>Ê®°ÂºèÁöÑËΩªÈáèÁ∫ßÊ∂àÊÅØ‰º†ËæìÂçèËÆÆÔºåÊúÄÂàùÁî±IBMÂú®1999Âπ¥ÂºÄÂèëÔºå‰∏ªË¶ÅÁî®‰∫é<code>‰ΩéÂ∏¶ÂÆΩ</code>„ÄÅ<code>‰∏çÁ®≥ÂÆöÁΩëÁªúÁéØÂ¢É</code>‰∏ãÁöÑËÆæÂ§áÈÄö‰ø°„ÄÇMQTTÂçèËÆÆËÆæËÆ°ÁÆÄÂçïÔºåÂç†Áî®ËµÑÊ∫êÂ∞ëÔºåÈÄÇÂêàÂú®ËµÑÊ∫êÂèóÈôêÁöÑÂµåÂÖ•ÂºèËÆæÂ§á‰∏äËøêË°å„ÄÇ</p><p>MQTTÁöÑÊ†∏ÂøÉÊÄùÊÉ≥ÊòØÂ∞ÜÊ∂àÊÅØÁöÑÂèëÈÄÅËÄÖÔºàÂèëÂ∏ÉËÄÖÔºâÂíåÊé•Êî∂ËÄÖÔºàËÆ¢ÈòÖËÄÖÔºâËß£ËÄ¶ÔºåÈÄöËøá‰∏Ä‰∏™‰∏≠Èó¥‰ª£ÁêÜÔºàBrokerÔºâÊù•‰º†ÈÄíÊ∂àÊÅØ„ÄÇÂèëÂ∏ÉËÄÖÂ∞ÜÊ∂àÊÅØÂèëÈÄÅÂà∞ÁâπÂÆöÁöÑ‰∏ªÈ¢òÔºàTopicÔºâÔºåËÆ¢ÈòÖËÄÖÂàôËÆ¢ÈòÖÊÑüÂÖ¥Ë∂£ÁöÑ‰∏ªÈ¢òÔºå‰ªéËÄåÊé•Êî∂Áõ∏ÂÖ≥Ê∂àÊÅØ„ÄÇ</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/mqtt/mqtt-diagram.png" class="lazyload placeholder" data-srcset="/assets/images/mqtt/mqtt-diagram.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="MQTT (Message Queuing Telemetry Transport)"/></div><span class="image-caption">MQTT (Message Queuing Telemetry Transport)</span></div><h2 id="MQTTÁöÑÂ∫îÁî®Âú∫ÊôØ"><a href="#MQTTÁöÑÂ∫îÁî®Âú∫ÊôØ" class="headerlink" title="MQTTÁöÑÂ∫îÁî®Âú∫ÊôØ"></a>MQTTÁöÑÂ∫îÁî®Âú∫ÊôØ</h2><p><code>MQTT</code>ÂπøÊ≥õÂ∫îÁî®‰∫éIoT(Internet of Things, Áâ©ËÅîÁΩë)È¢ÜÂüüÔºå‰∏ªË¶ÅÁî®‰∫éÁâ©ËÅîÁΩë„ÄÅÁßªÂä®‰∫íËÅîÁΩë„ÄÅÊô∫ËÉΩÂÆ∂Â±Ö„ÄÅÂ∑•‰∏öËá™Âä®ÂåñÁ≠âÈ¢ÜÂüü„ÄÇ‰ª•‰∏ãÊòØ‰∏Ä‰∫õÂÖ∏ÂûãÁöÑÂ∫îÁî®Âú∫ÊôØÔºö</p><ol><li><p>Áâ©ËÅîÁΩëÔºàIoTÔºâ<br>Âú®Áâ©ËÅîÁΩë‰∏≠ÔºåËÆæÂ§áÈÄöÂ∏∏ÂàÜÂ∏ÉÂú®‰∏çÂêåÁöÑÂú∞ÁêÜ‰ΩçÁΩÆÔºå‰∏îÁΩëÁªúÊù°‰ª∂ÂèØËÉΩ‰∏çÁ®≥ÂÆö„ÄÇMQTTÁöÑ‰ΩéÂ∏¶ÂÆΩÊ∂àËÄóÂíåÂèØÈù†ÊÄß‰ΩøÂÖ∂Êàê‰∏∫ËøûÊé•Ëøô‰∫õËÆæÂ§áÁöÑÁêÜÊÉ≥ÈÄâÊã©„ÄÇ‰æãÂ¶ÇÔºå‰º†ÊÑüÂô®ÂèØ‰ª•ÈÄöËøáMQTTÂ∞ÜÊï∞ÊçÆÂèëÈÄÅÂà∞‰∫ëÁ´ØÔºå‰æõÂÖ∂‰ªñËÆæÂ§áÊàñÂ∫îÁî®Á®ãÂ∫è‰ΩøÁî®„ÄÇ</p></li><li><p>Êô∫ËÉΩÂÆ∂Â±Ö<br>Âú®Êô∫ËÉΩÂÆ∂Â±ÖÁ≥ªÁªü‰∏≠ÔºåÂêÑÁßçËÆæÂ§áÔºàÂ¶ÇÁÅØÂÖâ„ÄÅÊ∏©ÊéßÂô®„ÄÅÂÆâÈò≤Á≥ªÁªüÁ≠âÔºâÈúÄË¶ÅÁõ∏‰∫íÈÄö‰ø°„ÄÇMQTTÂèØ‰ª•Â∏ÆÂä©Ëøô‰∫õËÆæÂ§áÈ´òÊïàÂú∞‰∫§Êç¢‰ø°ÊÅØÔºåÂÆûÁé∞Ëá™Âä®ÂåñÊéßÂà∂„ÄÇ</p></li><li><p>Â∑•‰∏öËá™Âä®Âåñ<br>Âú®Â∑•‰∏öËá™Âä®ÂåñÈ¢ÜÂüüÔºåMQTTÂèØ‰ª•Áî®‰∫éÁõëÊéßÂíåÊéßÂà∂Áîü‰∫ßÁ∫ø‰∏äÁöÑËÆæÂ§á„ÄÇÈÄöËøáMQTTÔºåÂ∑•ÂéÇÂèØ‰ª•ÂÆûÊó∂Ëé∑ÂèñËÆæÂ§áÁä∂ÊÄÅÔºåËøõË°åËøúÁ®ãÊéßÂà∂ÂíåÊïÖÈöúËØäÊñ≠„ÄÇ</p></li><li><p>ÁßªÂä®Â∫îÁî®<br>Âú®ÁßªÂä®Â∫îÁî®‰∏≠ÔºåMQTTÂèØ‰ª•Áî®‰∫éÊé®ÈÄÅÈÄöÁü•„ÄÅÂÆûÊó∂Ê∂àÊÅØ‰º†ÈÄíÁ≠âÂú∫ÊôØ„ÄÇÁî±‰∫éMQTTÂçèËÆÆËΩªÈáè‰∏îÈ´òÊïàÔºåÈùûÂ∏∏ÈÄÇÂêàÂú®ÁßªÂä®ËÆæÂ§á‰∏ä‰ΩøÁî®„ÄÇ</p></li></ol><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/mqtt/mqtt-example.png" class="lazyload placeholder" data-srcset="/assets/images/mqtt/mqtt-example.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="MQTT Example"/></div><span class="image-caption">MQTT Example</span></div><h2 id="MQTTÁöÑÂ∑•‰ΩúÂéüÁêÜ"><a href="#MQTTÁöÑÂ∑•‰ΩúÂéüÁêÜ" class="headerlink" title="MQTTÁöÑÂ∑•‰ΩúÂéüÁêÜ"></a>MQTTÁöÑÂ∑•‰ΩúÂéüÁêÜ</h2><p>MQTTÂçèËÆÆÂü∫‰∫éÂèëÂ∏É&#x2F;ËÆ¢ÈòÖÊ®°ÂºèÔºåÂÖ∂Ê†∏ÂøÉÁªÑ‰ª∂ÂåÖÊã¨‰ª•‰∏ã‰∏â‰∏™Ôºö</p><p><strong>ÂèëÂ∏ÉËÄÖÔºàPublisherÔºâ</strong>ÔºöË¥üË¥£Â∞ÜÊ∂àÊÅØÂèëÈÄÅÂà∞ÁâπÂÆöÁöÑ‰∏ªÈ¢òTopic„ÄÇ<br><strong>ËÆ¢ÈòÖËÄÖÔºàSubscriberÔºâ</strong>ÔºöËÆ¢ÈòÖÊÑüÂÖ¥Ë∂£ÁöÑ‰∏ªÈ¢òÔºåÊé•Êî∂Áõ∏ÂÖ≥Ê∂àÊÅØ„ÄÇ<br><strong>‰ª£ÁêÜÔºàBrokerÔºâ</strong>ÔºöË¥üË¥£Êé•Êî∂ÂèëÂ∏ÉËÄÖÁöÑÊ∂àÊÅØÔºåÂπ∂Â∞ÜÂÖ∂ËΩ¨ÂèëÁªôËÆ¢ÈòÖËÄÖ„ÄÇ</p><h4 id="‰∏ªÈ¢òÔºàTopicÔºâ"><a href="#‰∏ªÈ¢òÔºàTopicÔºâ" class="headerlink" title="‰∏ªÈ¢òÔºàTopicÔºâ"></a>‰∏ªÈ¢òÔºàTopicÔºâ</h4><p>‰∏ªÈ¢òÊòØMQTT‰∏≠Ê∂àÊÅØÁöÑÂàÜÁ±ªÊ†áËØÜÁ¨¶ÔºåÈááÁî®<code>ÂàÜÂ±ÇÁªìÊûÑ</code>„ÄÇ‰æãÂ¶ÇÔºåhome&#x2F;livingroom&#x2F;temperature Ë°®Á§∫‚ÄúÂÆ¢ÂéÖÊ∏©Â∫¶‚Äù‰∏ªÈ¢ò„ÄÇÂèëÂ∏ÉËÄÖÂ∞ÜÊ∂àÊÅØÂèëÈÄÅÂà∞ÁâπÂÆö‰∏ªÈ¢òÔºåËÆ¢ÈòÖËÄÖÂàôÈÄöËøáËÆ¢ÈòÖ‰∏ªÈ¢òÊù•Êé•Êî∂Ê∂àÊÅØ„ÄÇ</p><h4 id="ÊúçÂä°Ë¥®ÈáèÔºàQoSÔºâ"><a href="#ÊúçÂä°Ë¥®ÈáèÔºàQoSÔºâ" class="headerlink" title="ÊúçÂä°Ë¥®ÈáèÔºàQoSÔºâ"></a>ÊúçÂä°Ë¥®ÈáèÔºàQoSÔºâ</h4><p>MQTTÊîØÊåÅ‰∏âÁßçÊúçÂä°Ë¥®ÈáèÁ∫ßÂà´ÔºåÁî®‰∫éÊéßÂà∂Ê∂àÊÅØ‰º†ÈÄíÁöÑÂèØÈù†ÊÄßÔºö</p><p><strong>QoS 0</strong>ÔºöÊúÄÂ§ö‰∏ÄÊ¨°‰º†ÈÄí„ÄÇÊ∂àÊÅØÂèØËÉΩ‰ºö‰∏¢Â§±Ôºå‰ΩÜ‰∏ç‰ºöÈáçÂ§ç„ÄÇ<br><strong>QoS 1</strong>ÔºöËá≥Â∞ë‰∏ÄÊ¨°‰º†ÈÄí„ÄÇÊ∂àÊÅØ‰∏ç‰ºö‰∏¢Â§±Ôºå‰ΩÜÂèØËÉΩ‰ºöÈáçÂ§ç„ÄÇ<br><strong>QoS 2</strong>ÔºöÊÅ∞Â•Ω‰∏ÄÊ¨°‰º†ÈÄí„ÄÇÊ∂àÊÅØÊó¢‰∏ç‰ºö‰∏¢Â§±Ôºå‰πü‰∏ç‰ºöÈáçÂ§ç„ÄÇ</p><h4 id="ÊåÅ‰πÖ‰ºöËØùÔºàPersistent-SessionÔºâ"><a href="#ÊåÅ‰πÖ‰ºöËØùÔºàPersistent-SessionÔºâ" class="headerlink" title="ÊåÅ‰πÖ‰ºöËØùÔºàPersistent SessionÔºâ"></a>ÊåÅ‰πÖ‰ºöËØùÔºàPersistent SessionÔºâ</h4><p>MQTTÊîØÊåÅÊåÅ‰πÖ‰ºöËØùÔºåÂÖÅËÆ∏ÂÆ¢Êà∑Á´ØÂú®Êñ≠ÂºÄËøûÊé•ÂêéÈáçÊñ∞ËøûÊé•Êó∂ÔºåÁªßÁª≠Êé•Êî∂Êú™Â§ÑÁêÜÁöÑÊ∂àÊÅØ„ÄÇËøôÂØπ‰∫é‰∏çÁ®≥ÂÆöÁöÑÁΩëÁªúÁéØÂ¢ÉÈùûÂ∏∏ÊúâÁî®„ÄÇ</p><h2 id="MQTTÁöÑÂ∑•‰ΩúÊµÅÁ®ã"><a href="#MQTTÁöÑÂ∑•‰ΩúÊµÅÁ®ã" class="headerlink" title="MQTTÁöÑÂ∑•‰ΩúÊµÅÁ®ã"></a>MQTTÁöÑÂ∑•‰ΩúÊµÅÁ®ã</h2><p>MQTTÁöÑÂ∑•‰ΩúÊµÅÁ®ãÂèØ‰ª•ÂàÜ‰∏∫‰ª•‰∏ãÂá†‰∏™Ê≠•È™§Ôºö</p><ol><li><p>ËøûÊé•‰ª£ÁêÜ<br>ÂÆ¢Êà∑Á´Ø(Client)ÔºàÂèëÂ∏ÉËÄÖÊàñËÆ¢ÈòÖËÄÖÔºâÈ¶ñÂÖà‰∏éMQTT‰ª£ÁêÜ(Broker)Âª∫Á´ãËøûÊé•„ÄÇËøûÊé•Êó∂ÔºåÂÆ¢Êà∑Á´ØÈúÄË¶ÅÊèê‰æõÂÆ¢Êà∑Á´ØID„ÄÅÁî®Êà∑Âêç„ÄÅÂØÜÁ†ÅÁ≠â‰ø°ÊÅØ„ÄÇ</p></li><li><p>ËÆ¢ÈòÖ‰∏ªÈ¢ò<br>ËÆ¢ÈòÖËÄÖÂêë‰ª£ÁêÜÂèëÈÄÅËÆ¢ÈòÖËØ∑Ê±ÇÔºåÊåáÂÆöÊÑüÂÖ¥Ë∂£ÁöÑ‰∏ªÈ¢ò„ÄÇ‰ª£ÁêÜ‰ºöËÆ∞ÂΩïËÆ¢ÈòÖËÄÖÁöÑËÆ¢ÈòÖ‰ø°ÊÅØ„ÄÇ</p></li><li><p>ÂèëÂ∏ÉÊ∂àÊÅØ<br>ÂèëÂ∏ÉËÄÖÂ∞ÜÊ∂àÊÅØÂèëÈÄÅÂà∞ÁâπÂÆö‰∏ªÈ¢ò„ÄÇ‰ª£ÁêÜÊé•Êî∂Âà∞Ê∂àÊÅØÂêéÔºå‰ºöÊ†πÊçÆ‰∏ªÈ¢òÂ∞ÜÊ∂àÊÅØËΩ¨ÂèëÁªôÊâÄÊúâËÆ¢ÈòÖËØ•‰∏ªÈ¢òÁöÑËÆ¢ÈòÖËÄÖ„ÄÇ</p></li><li><p>Êé•Êî∂Ê∂àÊÅØ<br>ËÆ¢ÈòÖËÄÖ‰ªé‰ª£ÁêÜÊé•Êî∂Ê∂àÊÅØÔºåÂπ∂Ê†πÊçÆÈúÄË¶ÅËøõË°åÂ§ÑÁêÜ„ÄÇ</p></li><li><p>Êñ≠ÂºÄËøûÊé•<br>ÂÆ¢Êà∑Á´ØÂèØ‰ª•‰∏ªÂä®Êñ≠ÂºÄ‰∏é‰ª£ÁêÜÁöÑËøûÊé•ÔºåÊàñËÄÖÁî±‰∫éÁΩëÁªúÈóÆÈ¢òÂØºËá¥ËøûÊé•Êñ≠ÂºÄ„ÄÇÂ¶ÇÊûúÂêØÁî®‰∫ÜÊåÅ‰πÖ‰ºöËØùÔºåÂÆ¢Êà∑Á´ØÈáçÊñ∞ËøûÊé•ÂêéÂèØ‰ª•ÁªßÁª≠Êé•Êî∂Êú™Â§ÑÁêÜÁöÑÊ∂àÊÅØ„ÄÇ</p></li></ol><h2 id="ÊÄªÁªì"><a href="#ÊÄªÁªì" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h2><p><code>MQTT</code>‰Ωú‰∏∫‰∏ÄÁßçËΩªÈáèÁ∫ß„ÄÅÈ´òÊïàÁöÑÈÄö‰ø°ÂçèËÆÆÔºåÂú®Áâ©ËÅîÁΩë„ÄÅÊô∫ËÉΩÂÆ∂Â±Ö„ÄÅÂ∑•‰∏öËá™Âä®ÂåñÁ≠âÈ¢ÜÂüüÊúâÁùÄÂπøÊ≥õÁöÑÂ∫îÁî®„ÄÇÂÖ∂Âü∫‰∫éÂèëÂ∏É&#x2F;ËÆ¢ÈòÖÊ®°ÂºèÁöÑËÆæËÆ°Ôºå‰ΩøÂæóËÆæÂ§á‰πãÈó¥ÁöÑÈÄö‰ø°Êõ¥Âä†ÁÅµÊ¥ªÂíåÈ´òÊïà„ÄÇÈÄöËøáÁêÜËß£MQTTÁöÑÂ∑•‰ΩúÂéüÁêÜÂíåÂ∑•‰ΩúÊµÅÁ®ãÔºåÂºÄÂèëËÄÖÂèØ‰ª•Êõ¥Â•ΩÂú∞Âà©Áî®Ëøô‰∏ÄÂçèËÆÆÔºåÊûÑÂª∫Á®≥ÂÆö„ÄÅÂèØÈù†ÁöÑÁâ©ËÅîÁΩëÁ≥ªÁªü„ÄÇ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;‰ªÄ‰πàÊòØMQTTÔºü&quot;&gt;&lt;a href=&quot;#‰ªÄ‰πàÊòØMQTTÔºü&quot; class=&quot;headerlink&quot; title=&quot;‰ªÄ‰πàÊòØMQTTÔºü&quot;&gt;&lt;/a&gt;‰ªÄ‰πàÊòØMQTTÔºü&lt;/h2&gt;&lt;p&gt;&lt;code&gt;MQTT ÔºàMessage Queuing Telemetry Transpor</summary>
      
    
    
    
    <category term="‰∏≠Èó¥‰ª∂" scheme="https://stonefishy.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
    <category term="MQTT" scheme="https://stonefishy.github.io/tags/MQTT/"/>
    
    <category term="IoT" scheme="https://stonefishy.github.io/tags/IoT/"/>
    
  </entry>
  
  <entry>
    <title>Sentry: The Developer‚Äôs Best Friend for Error Tracking and Performance Monitoring</title>
    <link href="https://stonefishy.github.io/2024/12/19/sentry-the-developer-s-best-friend-for-error-tracking-and-performance-monitoring/"/>
    <id>https://stonefishy.github.io/2024/12/19/sentry-the-developer-s-best-friend-for-error-tracking-and-performance-monitoring/</id>
    <published>2024-12-19T14:31:21.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/sentry.png" class="lazyload placeholder" data-srcset="/assets/images/tools/sentry.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Sentry"/></div><span class="image-caption">Sentry</span></div><p>As developers, we know how frustrating it can be to track down bugs and performance issues, especially when they slip through the cracks and impact end-users. Fortunately, <code>Sentry</code> is here to help you take control of your application‚Äôs stability and performance, offering a comprehensive solution for error tracking and performance monitoring.</p><p>In this post, we‚Äôll dive into what Sentry is, how it works, and why it should be a key part of your development workflow.</p><h2 id="What-is-Sentry"><a href="#What-is-Sentry" class="headerlink" title="What is Sentry?"></a>What is Sentry?</h2><p><code>Sentry</code> is an <code>open-source</code> <code>error tracking</code> and <code>performance monitoring</code> tool that helps you find and fix issues in your applications‚Äîwhether they‚Äôre web-based, mobile, or server-side. It captures errors in real-time, giving you deep insights into what went wrong, where it happened, and what might be causing it. Whether you‚Äôre building an app with React, Django, or even a mobile app, Sentry works across a wide variety of languages and platforms.</p><h2 id="Why-Should-Developers-Use-Sentry"><a href="#Why-Should-Developers-Use-Sentry" class="headerlink" title="Why Should Developers Use Sentry?"></a>Why Should Developers Use Sentry?</h2><ol><li><p>Track Errors in Real-Time<br>No one likes finding out about an issue after a user complains. Sentry sends real-time error alerts straight to your team‚Äîwhether it‚Äôs through email, Slack, or other channels‚Äîso you can address problems as they arise. And with detailed stack traces and contextual information, you‚Äôre not left guessing about where or why the issue happened.</p></li><li><p>Monitor Performance Issues<br>Sentry isn‚Äôt just for catching errors; it also provides powerful performance monitoring. From slow page loads to database bottlenecks, Sentry helps you track performance metrics and diagnose why your app might be lagging, allowing you to optimize performance proactively.</p></li><li><p>Understand Context Around Errors<br>When an error happens, Sentry doesn‚Äôt just provide a stack trace. It enriches the error data with contextual information like user actions, environment (production vs. staging), browser version, and the specific code version that caused the issue. This context allows you to fix issues faster because you get a better sense of what happened right before the error occurred.</p></li><li><p>Release Tracking<br>Have you ever deployed a new release, only to realize later that it introduced a bug? Sentry connects errors to specific releases, so you can quickly figure out which version of your app caused the problem. Plus, you can monitor the health of each release, so you know when it‚Äôs time to roll back or fix issues.</p></li></ol><h2 id="Core-Features-You‚Äôll-Love"><a href="#Core-Features-You‚Äôll-Love" class="headerlink" title="Core Features You‚Äôll Love"></a>Core Features You‚Äôll Love</h2><ol><li><p>Error Aggregation<br>Sentry aggregates errors that are similar or identical, helping you prioritize the most critical issues without being overwhelmed by duplicates. This makes it easier to focus on the errors that matter.</p></li><li><p>Customizable Alerts &amp; Notifications<br>You can set custom thresholds for error severity or the frequency of an error before triggering an alert. This ensures you‚Äôre not flooded with notifications for every minor issue but are still on top of critical bugs.</p></li><li><p>Issue Resolution Workflow<br>With issue tracking integration (e.g., JIRA, GitHub), you can automatically assign issues to team members and track their resolution status without leaving your existing tools. This helps streamline your workflow and ensures bugs don‚Äôt fall through the cracks.</p></li><li><p>Contextual Information<br>The error reports include all the context you need to solve a bug, like the user‚Äôs device info, the environment it happened in, stack traces, request URLs, and even relevant logs. This reduces the time it takes to identify and fix problems.</p></li><li><p>Performance Monitoring<br>With Sentry‚Äôs performance monitoring, you can trace the performance of specific transactions across your app. This helps pinpoint slow database queries, inefficient API calls, and anything else that might be affecting performance.</p></li><li><p>Wide Integration Support<br>Sentry integrates with many of the tools you already use, such as <code>GitHub</code>, <code>GitLab</code>, <code>Slack</code>, <code>JIRA</code>, <code>Trello</code>, and more. This makes it simple to plug Sentry into your existing workflow and ensure your development process is smooth.</p></li></ol><h2 id="How-Does-Sentry-Work"><a href="#How-Does-Sentry-Work" class="headerlink" title="How Does Sentry Work?"></a>How Does Sentry Work?</h2><p>Integrating Sentry is simple and quick, and once you set it up, it works seamlessly behind the scenes. Here‚Äôs a high-level look at how it works:</p><ol><li><p>Error Detection:<br>Sentry works by using SDKs specific to your tech stack. Once integrated, it automatically detects unhandled errors in your application.</p></li><li><p>Context Collection:</p><span class='pbg danger'>When an error is captured</span></li><li><p>Error Aggregation &amp; Notifications:<br>The error is aggregated and displayed on your Sentry dashboard. If you‚Äôve set up notifications, your team will be alerted in real-time via Slack, email, or any other supported channel.</p></li><li><p>Resolution &amp; Feedback:<br>Once a developer resolves an issue, Sentry marks it as resolved. If the issue reoccurs, Sentry notifies you again, keeping you in the loop.</p></li></ol><h2 id="How-to-Get-Started-with-Sentry"><a href="#How-to-Get-Started-with-Sentry" class="headerlink" title="How to Get Started with Sentry"></a>How to Get Started with Sentry</h2><ol><li><p>Create an Account<br>Go to Sentry‚Äôs website and sign up for a free account. You‚Äôll be guided through the setup process, and you can create a new project for your app. Accessing <a href="https://sentry.io/">https://sentry.io</a> to create your own account.</p></li><li><p>Install the SDK<br>Depending on the tech stack you‚Äôre using, you‚Äôll need to install the appropriate SDK. For example:</p></li></ol><p>In React Application:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @sentry/react</span><br></pre></td></tr></table></figure><p>Then, initialize Sentry in your app:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&quot;react-dom&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> <span class="title class_">Sentry</span> <span class="keyword">from</span> <span class="string">&quot;@sentry/react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&quot;./App&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Sentry</span>.<span class="title function_">init</span>(&#123;</span><br><span class="line">  <span class="attr">dsn</span>: <span class="string">&quot;https://&lt;key&gt;@sentry.io/&lt;project&gt;&quot;</span>,</span><br><span class="line">  <span class="comment">// This enables automatic instrumentation (highly recommended)</span></span><br><span class="line">  <span class="comment">// If you only want to use custom instrumentation:</span></span><br><span class="line">  <span class="comment">// * Remove the BrowserTracing integration</span></span><br><span class="line">  <span class="comment">// * add Sentry.addTracingExtensions() above your Sentry.init() call</span></span><br><span class="line">  <span class="attr">integrations</span>: [</span><br><span class="line">    <span class="title class_">Sentry</span>.<span class="title function_">browserTracingIntegration</span>(),</span><br><span class="line">    <span class="comment">// Or, if you are using react router, use the appropriate integration</span></span><br><span class="line">    <span class="comment">// See docs for support for different versions of react router</span></span><br><span class="line">    <span class="comment">// https://docs.sentry.io/platforms/javascript/guides/react/configuration/integrations/react-router/</span></span><br><span class="line">    <span class="title class_">Sentry</span>.<span class="title function_">reactRouterV6BrowserTracingIntegration</span>(&#123;</span><br><span class="line">      <span class="attr">useEffect</span>: <span class="title class_">React</span>.<span class="property">useEffect</span>,</span><br><span class="line">      useLocation,</span><br><span class="line">      useNavigationType,</span><br><span class="line">      createRoutesFromChildren,</span><br><span class="line">      matchRoutes,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For finer control of sent transactions you can adjust this value, or</span></span><br><span class="line">  <span class="comment">// use tracesSampler</span></span><br><span class="line">  <span class="attr">tracesSampleRate</span>: <span class="number">1.0</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set tracePropagationTargets to control for which URLs distributed tracing should be enabled</span></span><br><span class="line">  <span class="attr">tracePropagationTargets</span>: [<span class="string">&#x27;localhost&#x27;</span>, <span class="regexp">/^https:/</span><span class="regexp">/yourserver.io/</span>api/],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">App</span> /&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;root&quot;</span>));</span><br></pre></td></tr></table></figure><p>Sentry SDK supports multiple languages and frameworks, including React, Angular, Vue, .NET, Go, Python, SpringBoot, Next.js and more.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/tools/sentry-sdks.png" class="lazyload placeholder" data-srcset="/assets/images/tools/sentry-sdks.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Sentry SDK Integrations"/></div><span class="image-caption">Sentry SDK Integrations</span></div><ol start="3"><li><p>Integrate Error &amp; Performance Monitoring<br>Sentry works out of the box for most errors, but you can also use it to track performance. You can instrument specific parts of your code to track performance issues, like database queries or API calls.</p></li><li><p>Configure Notifications<br>Set up notification channels (e.g., <code>Slack</code>, <code>email</code>) so your team is alerted whenever a critical error occurs. Customize the rules to avoid spamming you with minor issues.</p></li><li><p>Monitor in the Dashboard<br>Once the integration is complete, you‚Äôll start seeing error logs, performance metrics, and more on your Sentry dashboard. You can drill down into individual issues, see affected users, and get all the data you need to fix the bug fast.</p></li></ol><h2 id="Benefits-of-Using-Sentry-for-Developers"><a href="#Benefits-of-Using-Sentry-for-Developers" class="headerlink" title="Benefits of Using Sentry for Developers"></a>Benefits of Using Sentry for Developers</h2><ol><li><p>Faster Debugging:<br>With all the contextual data Sentry provides, debugging becomes faster. No more chasing elusive bugs‚Äîget right to the root cause.</p></li><li><p>Proactive Monitoring:<br>Monitor both errors and performance, which helps you prevent issues before they affect users. Sentry gives you the insights to optimize performance and fix bugs early.</p></li><li><p>Increased Collaboration:<br>Integrated workflows with tools like GitHub, JIRA, and Slack mean you and your team can stay on the same page, and bugs can be tracked, assigned, and resolved efficiently.</p></li><li><p>Free Tier Available:<br>Sentry offers a free plan with generous limits, so you can get started without any upfront costs. As your project grows, you can scale to a paid plan with more features.</p></li></ol><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Sentry is an invaluable tool for developers, offering real-time error tracking and powerful performance monitoring. By integrating Sentry into your workflow, you can catch and resolve errors faster, improve your app‚Äôs performance, and provide a better experience for your users.</p><p>So if you‚Äôre looking to streamline your debugging process, improve performance monitoring, and keep your app healthy, you can try sentry in your application!</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;img-wrap&quot;&gt;&lt;div class=&quot;img-bg&quot;&gt;&lt;img class=&quot;img lazyload placeholder&quot; src=&quot;/assets/images/tools/sentry.png&quot; class=&quot;lazyload placeh</summary>
      
    
    
    
    <category term="Tools" scheme="https://stonefishy.github.io/categories/Tools/"/>
    
    
    <category term="React" scheme="https://stonefishy.github.io/tags/React/"/>
    
    <category term="Sentry" scheme="https://stonefishy.github.io/tags/Sentry/"/>
    
  </entry>
  
  <entry>
    <title>Introduction to LangChain: Make AI Smarter and Easier to use</title>
    <link href="https://stonefishy.github.io/2024/11/12/introduction-to-langchain-make-ai-smarter-and-easy-to-use/"/>
    <id>https://stonefishy.github.io/2024/11/12/introduction-to-langchain-make-ai-smarter-and-easy-to-use/</id>
    <published>2024-11-12T13:49:12.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/langchain-image.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/langchain-image.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" style="width:600px;"/></div></div><p>Have you ever wondered how some apps and websites can have conversations with you, answer your questions? Many of these apps use <code>artificial intelligence (AI)</code>, like the chatbot you might use to ask questions or get advice. But creating these smart systems can be tricky. This is where a tool called <code>LangChain</code> comes in to help!</p><p><code>LangChain</code> is a framework that makes it easier for developers to build applications that use <code>AI models</code>, like chatbots or smart helpers. In this blog, we‚Äôre going to explain what LangChain is, how it works, and why it‚Äôs useful for making AI apps.</p><h2 id="What-is-LangChain"><a href="#What-is-LangChain" class="headerlink" title="What is LangChain?"></a>What is LangChain?</h2><p>LangChain is a tool for developers that helps them build applications using <code>large language models (LLMs)</code>‚Äîthe same kind of AI that powers chatbots, writing assistants, and more. LLMs can understand and generate text in a way that sounds like a real person. However, using these models to make powerful apps can be complicated. LangChain makes it easier by offering ready-made building blocks to connect these models to other tools, data, and even databases.</p><p>Think of LangChain like a set of Lego blocks that you can use to build cool things with AI. It saves developers time by giving them ready-made pieces to use, rather than having to create everything from scratch.</p><h2 id="Features-of-LangChain"><a href="#Features-of-LangChain" class="headerlink" title="Features of LangChain"></a>Features of LangChain</h2><p>Let‚Äôs break down some of the cool features LangChain offers and how they help developers make smarter apps.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/langchain-features.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/langchain-features.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="LangChain Features"/></div><span class="image-caption">LangChain Features</span></div><ol><li><p><strong>Chains</strong>: Putting Multiple Steps Together<br>Imagine you have a robot that can help with math homework. The robot might need to do multiple things to solve a problem. First, it could look up the math formula, then solve the problem, and finally explain the answer. In LangChain, these steps are called chains.</p><blockquote><p>A chain is a sequence of actions where each step depends on the previous one. For example, you could create a chain where:</p><p>First, the app asks the AI to pull data from a website.<br>Then, it uses that data to answer a question.<br>Finally, it summarizes the answer for the user.</p></blockquote></li><li><p><strong>Prompt Management</strong>: Talking to AI the Right Way<br>When you talk to an AI, how you ask your question or give your instruction is really important. That‚Äôs called a prompt. LangChain helps developers make the best prompts by letting them create templates. These templates let developers easily change certain parts of the prompt without having to rewrite it every time.</p><blockquote><p>For example, if you wanted to ask the AI to summarize a story, you could have a prompt like this:</p><p>‚ÄúPlease summarize the following story: {story}‚Äù</p><p>In this template, {story} is a placeholder that can be replaced with any story you want the AI to summarize.</p></blockquote></li><li><p><strong>Agents</strong>: Letting AI Decide What to Do Next<br>Sometimes, a smart system needs to decide what to do next based on the information it gets. For example, if you ask an AI about the weather, it might decide to pull the latest weather data from the internet. This decision-making is done by agents.</p><blockquote><p>An agent is like a helper that looks at the information it gets and chooses the best action. LangChain helps developers build agents that can make these decisions automatically.</p></blockquote></li><li><p><strong>Memory</strong>: Remembering What Happened Before<br>Have you ever talked to a chatbot and then later felt like it forgot what you said earlier? That can make a conversation feel weird. <code>LangChain helps solve this problem by letting the AI remember what was said earlier in the conversation</code>. This feature is called memory.</p><blockquote><p>or example, if you ask a chatbot for homework help and then ask a follow-up question, LangChain can help the AI remember the first question and give a more useful answer based on that memory.</p></blockquote></li><li><p><strong>Integrations</strong>: Connecting to Other Tools and Websites<br>Sometimes, an AI app needs to talk to other systems to get more information. <span class='pbg success'>LangChain makes this easy by letting developers connect their AI app to other tools</span> This is like having a personal assistant that not only talks to you but also has access to tons of information online.</p><blockquote><p>For example, an AI app could pull up the latest sports scores, or check the weather for you, using real-time data from the internet.</p></blockquote></li><li><p><strong>Retrieval-Augmented Generation (RAG)</strong>: Getting Smarter Answers<br>LangChain also lets AI search for information in real-time. This is called retrieval-augmented generation (RAG). It allows the AI to look up the latest data, like news stories or facts, and use that information to create smarter answers.</p><blockquote><p>For example, if you ask about the latest trends in video games, the AI can search the web for the most up-to-date information and then explain it to you.</p></blockquote></li></ol><h2 id="Why-Do-Developers-Use-LangChain"><a href="#Why-Do-Developers-Use-LangChain" class="headerlink" title="Why Do Developers Use LangChain?"></a>Why Do Developers Use LangChain?</h2><p>There are several reasons why developers might want to use LangChain:</p><ol><li><p>Makes It Easier to Build AI Apps<br>Instead of starting from scratch, LangChain gives developers tools that speed up the process of creating AI apps. Developers can use LangChain‚Äôs building blocks to create powerful applications without needing to write everything by hand.</p></li><li><p>It‚Äôs Flexible<br>LangChain can be used for a wide variety of apps. Whether you want to build a chatbot, a smart search engine, or an app that helps you study, LangChain has tools that make it easier to put everything together.</p></li><li><p>Saves Time<br>Developers don‚Äôt have to spend a lot of time figuring out how to make an AI model work with a database or how to chain steps together. LangChain does much of the heavy lifting, so developers can focus on the fun and creative parts of building their apps.</p></li><li><p>It‚Äôs <code>Open-Source</code><br>LangChain is free for anyone to use and improve. It‚Äôs open-source, which means developers from all over the world can contribute to making it better. If you‚Äôre learning to code or want to help improve the tool, you can!</p></li></ol><h2 id="Real-World-Examples-of-LangChain"><a href="#Real-World-Examples-of-LangChain" class="headerlink" title="Real-World Examples of LangChain"></a>Real-World Examples of LangChain</h2><p>LangChain is already being used in many cool ways. Here are a few examples:</p><ol><li><p>Chatbots<br>Developers can use LangChain to build chatbots that remember previous conversations and can talk to you like a real person. For example, you could create a chatbot to help you study for a test, and it would remember what you‚Äôve learned so far.</p></li><li><p>Smart Assistants<br>LangChain can help build systems that pull information from the internet and use AI to explain things in simple terms. For example, if you‚Äôre stuck on a science problem, an AI could look up the topic online and explain it to you in a way you understand.</p></li><li><p>Automated Content Creation<br>Some apps use LangChain to automatically write articles or summaries. For example, a news website could use LangChain to summarize long articles or pull out the key points from reports, saving readers time.</p></li><li><p>Personalized Search Engines<br>LangChain can be used to build search engines that don‚Äôt just give you a list of links but also summarize the best results for you. This could help you find the exact answer you need faster.</p></li></ol><h2 id="How-to-Get-Started-with-LangChain"><a href="#How-to-Get-Started-with-LangChain" class="headerlink" title="How to Get Started with LangChain"></a>How to Get Started with LangChain</h2><p>If you‚Äôre excited to try out LangChain, here‚Äôs how you can get started:</p><ol><li>Install Python: LangChain works with Python, a programming language that‚Äôs great for beginners.</li><li>Install LangChain: You can install LangChain by running the command <code>pip install langchain</code> in Python.</li><li>Start Building: Once LangChain is installed, you can start building your own AI-powered applications! LangChain has tutorials and guides to help you learn how to use it.</li></ol><p>For more information, check out the LangChain documentation at <a href="https://python.langchain.com/docs/introduction/">https://python.langchain.com/docs/introduction/</a></p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>LangChain is a super helpful tool for developers who want to build cool apps powered by AI. It makes it easier to connect different parts of an app, like databases or the web, with a language model that can understand and generate text. Whether it‚Äôs helping with homework, answering questions, or building a chatbot, LangChain is a great way to build smarter, more interactive applications.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;img-wrap&quot;&gt;&lt;div class=&quot;img-bg&quot;&gt;&lt;img class=&quot;img lazyload placeholder&quot; src=&quot;/assets/images/ai-ml/langchain-image.png&quot; class=&quot;lazylo</summary>
      
    
    
    
    
    <category term="AI" scheme="https://stonefishy.github.io/tags/AI/"/>
    
    <category term="LangChain" scheme="https://stonefishy.github.io/tags/LangChain/"/>
    
  </entry>
  
  <entry>
    <title>What is Prompt Engineering? Best Practices and Examples</title>
    <link href="https://stonefishy.github.io/2024/11/05/what-is-prompt-engineer/"/>
    <id>https://stonefishy.github.io/2024/11/05/what-is-prompt-engineer/</id>
    <published>2024-11-05T14:08:09.000Z</published>
    <updated>2025-02-07T03:24:32.614Z</updated>
    
    <content type="html"><![CDATA[<p>As artificial intelligence (AI) models, especially large language models (LLMs) like OpenAI‚Äôs GPT series, have become increasingly sophisticated, a new role has emerged in the AI ecosystem: <code>the Prompt Engineer</code>. The term might sound technical or niche, but it‚Äôs actually pivotal to leveraging AI models effectively. Whether you‚Äôre interacting with AI in your personal or professional life, the quality of the interaction largely depends on how well the prompt is designed. This article will explore what a prompt engineer does, the best practices for writing effective prompts, and provide examples comparing outputs with and without a prompt engineer‚Äôs expertise.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/prompt-engineering.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/prompt-engineering.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" style="width:800px;"/></div></div><h2 id="What-is-a-Prompt-Engineer"><a href="#What-is-a-Prompt-Engineer" class="headerlink" title="What is a Prompt Engineer?"></a>What is a Prompt Engineer?</h2><p><em>A Prompt Engineer is someone who specializes in crafting, refining, and optimizing prompts to ensure that AI models respond with the most relevant,accurate,and actionable information.</em> The role requires a blend of creativity, technical understanding, and knowledge of the AI‚Äôs underlying model architecture.</p><p>In essence, the prompt engineer‚Äôs job is to ‚Äúspeak‚Äù the language of the AI model. Since AI models like <code>GPT-3</code> or <code>GPT-4</code> don‚Äôt ‚Äúthink‚Äù like humans, their responses depend heavily on how the question or task is framed. A prompt engineer ensures that the right context, constraints, and phrasing are in place to guide the model toward producing the most useful responses.</p><h2 id="Why-is-Prompt-Engineering-Important"><a href="#Why-is-Prompt-Engineering-Important" class="headerlink" title="Why is Prompt Engineering Important?"></a>Why is Prompt Engineering Important?</h2><p>While AI models are capable of generating human-like text and performing complex tasks, their outputs are highly sensitive to the structure of the prompt. The same AI model could provide vastly different answers depending on the way a question is asked. Prompt engineers understand this sensitivity and use it to maximize the effectiveness of the interaction with AI.</p><p>Here are some reasons why prompt engineering is important:</p><p><strong>Maximizing output quality</strong>: Well-designed prompts improve the accuracy, relevance, and clarity of responses.<br><strong>Reducing errors</strong>: By properly framing a prompt, prompt engineers can help reduce misunderstandings or irrelevant responses.<br><strong>Efficiency</strong>: Instead of relying on trial and error to get useful responses, prompt engineers streamline the interaction process, saving time and resources.<br><strong>Contextuality</strong>: A good prompt will provide the necessary context for the model, ensuring that the response is in line with the user‚Äôs expectations.</p><h2 id="The-Path-of-a-Prompt-Engineer"><a href="#The-Path-of-a-Prompt-Engineer" class="headerlink" title="The Path of a Prompt Engineer"></a>The Path of a Prompt Engineer</h2><p>The process that a prompt engineer follows to ensure optimal results involves several stages. Each stage builds upon the last, leading to an iterative cycle that refines both the prompt and the AI‚Äôs output. Here‚Äôs a breakdown of the typical path of a prompt engineer:</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/prompt-engineer-path.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/prompt-engineer-path.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="The Path of a Prompt Engineer" style="width:800px;"/></div><span class="image-caption">The Path of a Prompt Engineer</span></div><h3 id="1-Task-Understanding"><a href="#1-Task-Understanding" class="headerlink" title="1.Task Understanding:"></a>1.Task Understanding:</h3><p>Before crafting any prompt, the first step is to fully understand the task at hand. This involves clarifying the user‚Äôs goal, determining the desired output format, and understanding the nuances of the request. A deep understanding of the problem ensures that the prompt engineer can craft a question or instruction that addresses all necessary aspects.</p><blockquote><p>Example: If the task is to generate a poem, the prompt engineer will need to understand the tone, style, and subject matter required.</p></blockquote><h3 id="2-Crafting-Prompts"><a href="#2-Crafting-Prompts" class="headerlink" title="2.Crafting Prompts:"></a>2.Crafting Prompts:</h3><p>The next step is to craft the prompt. This involves framing the task clearly, with enough specificity to guide the AI toward the desired output. Crafting an effective prompt is not about asking a single question, but about <em>providing the model with the right context, constraints, and direction</em>.</p><blockquote><p>Example: Instead of asking, ‚ÄúWrite a poem,‚Äù a more specific prompt might be, ‚ÄúWrite a rhyming poem about the beauty of autumn, focusing on imagery and feelings of nostalgia.‚Äù</p></blockquote><h3 id="3-Prompt-Alignment"><a href="#3-Prompt-Alignment" class="headerlink" title="3.Prompt Alignment:"></a>3.Prompt Alignment:</h3><p>At this stage, the prompt must be aligned with the intended outcome. This means considering the AI model‚Äôs strengths and limitations and ensuring that the prompt leads the AI to produce a response that fits the desired format, tone, and depth. The prompt should ensure the model understands the context of the task, as well as any constraints or preferences that need to be respected.</p><blockquote><p>Example: For a technical article, aligning the prompt would involve ensuring the language model knows to prioritize clarity, accuracy, and technical precision.</p></blockquote><h3 id="4-Optimizing-Prompt"><a href="#4-Optimizing-Prompt" class="headerlink" title="4.Optimizing Prompt:"></a>4.Optimizing Prompt:</h3><p>After alignment, the prompt may need further refinement. This step involves fine-tuning the wording, simplifying complex instructions, or narrowing down the scope to ensure that the prompt is as effective as possible. <em>Optimization often involves making the prompt more specific and reducing ambiguity.</em></p><blockquote><p>Example: ‚ÄúWrite a 300-word summary of the research paper on AI ethics, emphasizing the ethical dilemmas and implications for technology companies.‚Äù This version is more optimized than a broad, vague instruction.</p></blockquote><h3 id="5-AI-Model-Processing"><a href="#5-AI-Model-Processing" class="headerlink" title="5.AI Model Processing:"></a>5.AI Model Processing:</h3><p>Once the optimized prompt is provided, the AI model processes it and generates a response. This is where the model applies its underlying machine learning architecture, leveraging its training data to formulate a response.</p><blockquote><p>Example: The AI will analyze the prompt, consider patterns in its training data, and produce a response based on its understanding of the language and context.</p></blockquote><h3 id="6-Generating-Output"><a href="#6-Generating-Output" class="headerlink" title="6.Generating Output:"></a>6.Generating Output:</h3><p>The AI model generates the initial output based on the prompt. Depending on the AI model‚Äôs capabilities, this output may vary in length, style, accuracy, or even relevance to the task.</p><blockquote><p>Example: If the task was to summarize a paper, the output might include key findings, conclusions, and references to methodology.</p></blockquote><h3 id="7-Output-Refinement"><a href="#7-Output-Refinement" class="headerlink" title="7.Output Refinement:"></a>7.Output Refinement:</h3><p>Once the output is generated, prompt engineers review and refine it. This may involve removing irrelevant information, adjusting tone, adding details, or improving clarity. In some cases, the output might need to be restructured to fit the desired format.</p><blockquote><p>Example: If the AI‚Äôs response contains tangential information or lacks clarity, the prompt engineer would reword it or fine-tune the output to better align with the user‚Äôs expectations.</p></blockquote><h3 id="8-Iterative-Improvement"><a href="#8-Iterative-Improvement" class="headerlink" title="8.Iterative Improvement:"></a>8.Iterative Improvement:</h3><p>Finally, the process of prompt engineering is iterative. After refining the output, prompt engineers analyze the effectiveness of the response and assess how the prompt can be improved for future tasks. This leads to continuous improvement, ensuring that future prompts are even more optimized, concise, and aligned with user needs.</p><blockquote><p>Example: The engineer might adjust the prompt for the next interaction to ensure more relevant details or a more focused response.</p></blockquote><h2 id="Key-Skills-and-Tools-of-a-Prompt-Engineer"><a href="#Key-Skills-and-Tools-of-a-Prompt-Engineer" class="headerlink" title="Key Skills and Tools of a Prompt Engineer"></a>Key Skills and Tools of a Prompt Engineer</h2><p>Prompt engineering requires a variety of skills:</p><p><strong>Understanding of Language Models</strong>:<br>A prompt engineer should have a deep understanding of how LLMs like GPT process language. Knowing their strengths and weaknesses allows for better prompt design.</p><p><strong>Communication Skills</strong>:<br>Effective communication is critical, as prompt engineers must be able to convey complex instructions in a way that the model can interpret clearly.</p><p><strong>Creativity and Experimentation</strong>:<br>Crafting effective prompts often requires trial and error, testing different phrasings and structures to see what works best.</p><p><strong>Analytical Thinking</strong>:<br>Understanding how different types of inputs influence the model‚Äôs outputs and iterating to improve results.</p><p>In addition to these skills, prompt engineers also use tools to test and refine their prompts. For instance, platforms like OpenAI‚Äôs Playground allow users to experiment with various prompts in real-time, while more advanced professionals might leverage APIs to automate or scale their prompt engineering work.</p><h2 id="Best-Practices-for-Prompt-Engineering"><a href="#Best-Practices-for-Prompt-Engineering" class="headerlink" title="Best Practices for Prompt Engineering"></a>Best Practices for Prompt Engineering</h2><p>There are several strategies that a prompt engineer can employ to get the most out of a language model. Below are some of the best practices:</p><ol><li><p><strong>Be Specific and Clear</strong>: Ambiguous prompts can confuse AI models, leading to vague or incorrect responses. Make sure the prompt is clear and as specific as possible.</p><blockquote><p>Example: Instead of asking, ‚ÄúTell me about AI,‚Äù a more specific prompt would be, ‚ÄúCan you explain the difference between supervised and unsupervised learning in AI?‚Äù</p></blockquote></li><li><p><strong>Use Context Effectively</strong>: Providing context can guide the model to better understand the desired output.</p><blockquote><p>Example: Instead of saying, ‚ÄúWrite a poem,‚Äù say, ‚ÄúWrite a rhyming poem about the beauty of autumn with a melancholic tone.‚Äù</p></blockquote></li><li><p><strong>Limit the Scope</strong>: Sometimes, less is more. Limit the scope of the prompt to avoid overwhelming the model with too much information or too many instructions.</p><blockquote><p>Example: Instead of ‚ÄúWrite an article about the importance of artificial intelligence in modern business, covering all aspects of AI from machine learning to natural language processing,‚Äù you could say, ‚ÄúWrite a short article explaining the importance of AI in customer service.‚Äù</p></blockquote></li><li><p><strong>Test and Iterate</strong>: A prompt engineer should test various iterations of a prompt to identify the most effective structure.</p></li><li><p><strong>Give Examples</strong>: For tasks requiring specific output formats, include an example to guide the model.</p><blockquote><p>Example: If you want a bulleted list, you could say, ‚ÄúList the steps in a process to build a website. For example: Step 1: Plan the layout.‚Äù</p></blockquote></li><li><p><strong>Use Temperature and Max Tokens</strong>: Some models allow you to adjust the <code>temperature (which controls randomness)</code> and the <code>max tokens (which sets a character limit)</code> to control the output. These can be adjusted to fine-tune the model‚Äôs output.</p></li></ol><h2 id="Comparing-with-and-without-Prompt-Engineering"><a href="#Comparing-with-and-without-Prompt-Engineering" class="headerlink" title="Comparing with and without Prompt Engineering"></a>Comparing with and without Prompt Engineering</h2><p>Now let‚Äôs look at some concrete examples of how a well-crafted prompt versus a poorly constructed one can affect the outcome.</p><h3 id="Example-1-Writing-a-Research-Summary"><a href="#Example-1-Writing-a-Research-Summary" class="headerlink" title="Example 1: Writing a Research Summary"></a>Example 1: Writing a Research Summary</h3><ul><li>Without a Prompt Engineer:</li></ul><p><strong>Prompt</strong>: ‚ÄúSummarize this research paper.‚Äù</p><p>The AI may generate a generic or overly simplistic summary, without capturing the key aspects of the paper, such as methodology, results, and conclusions.</p><ul><li>With a Prompt Engineer:</li></ul><p><strong>Prompt</strong>: ‚ÄúSummarize the research paper titled ‚ÄòExploring AI Ethics in Autonomous Vehicles.‚Äô Focus on the methodology, key findings, and implications for policy. Keep the summary under 200 words.‚Äù</p><p>The AI‚Äôs response will be more targeted, concise, and aligned with the user‚Äôs expectations, providing a detailed summary that addresses the core aspects of the paper.</p><h3 id="Example-2-Writing-a-Creative-Story"><a href="#Example-2-Writing-a-Creative-Story" class="headerlink" title="Example 2: Writing a Creative Story"></a>Example 2: Writing a Creative Story</h3><ul><li>Without a Prompt Engineer:</li></ul><p><strong>Prompt</strong>: ‚ÄúWrite a story.‚Äù</p><p>The story might lack direction, coherence, or creativity, leading to a generic or even nonsensical narrative.</p><ul><li>With a Prompt Engineer:</li></ul><p><strong>Prompt</strong>: ‚ÄúWrite a short story set in a post-apocalyptic world where humans are living on Mars. The protagonist is a scientist struggling with the ethical implications of using artificial intelligence to terraform the planet. Make the tone introspective and thought-provoking.‚Äù</p><p>The story produced will be richer, more engaging, and aligned with the specific context and themes the user wanted.</p><h3 id="Example-3-Asking-for-Code"><a href="#Example-3-Asking-for-Code" class="headerlink" title="Example 3: Asking for Code"></a>Example 3: Asking for Code</h3><ul><li>Without a Prompt Engineer:</li></ul><p><strong>Prompt</strong>: ‚ÄúWrite a Python function.‚Äù</p><p>The AI may generate a simple function, but it may not meet the user‚Äôs needs or lack important features such as error handling or optimization.</p><ul><li>With a Prompt Engineer:</li></ul><p><strong>Prompt</strong>: ‚ÄúWrite a Python function to validate an email address using regular expressions. The function should return True if the email is valid and False if it is invalid. It should also handle common edge cases such as missing domain names or incorrect characters.‚Äù</p><p>The AI‚Äôs response will be much more precise, including the correct implementation, error handling, and edge case considerations.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In the world of AI, a <code>Prompt Engineer</code> plays a critical role in ensuring that AI models deliver optimal results. The expertise of prompt engineers can dramatically influence the quality, relevance, and accuracy of responses from language models like <code>GPT-4</code>. By following best practices‚Äîsuch as being specific, providing context, testing different iterations, and using examples‚Äîthey can significantly improve the interaction between humans and AI.</p><p>As AI continues to evolve, the role of prompt engineering will become even more important, helping users and businesses unlock the full potential of artificial intelligence. Whether it‚Äôs writing, problem-solving, or complex technical tasks, the way we interact with AI will increasingly depend on how well we craft our prompts.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;As artificial intelligence (AI) models, especially large language models (LLMs) like OpenAI‚Äôs GPT series, have become increasingly sophis</summary>
      
    
    
    
    <category term="AI/ML" scheme="https://stonefishy.github.io/categories/AI-ML/"/>
    
    
    <category term="AI" scheme="https://stonefishy.github.io/tags/AI/"/>
    
    <category term="OpenAI" scheme="https://stonefishy.github.io/tags/OpenAI/"/>
    
    <category term="GPT-4" scheme="https://stonefishy.github.io/tags/GPT-4/"/>
    
    <category term="GPT-3" scheme="https://stonefishy.github.io/tags/GPT-3/"/>
    
    <category term="Prompt Engineering" scheme="https://stonefishy.github.io/tags/Prompt-Engineering/"/>
    
  </entry>
  
  <entry>
    <title>Understanding the Azure OpenAI GPT-4 API Chat Role Usage</title>
    <link href="https://stonefishy.github.io/2024/11/01/understanding-the-azure-openai-gpt-4-api-role/"/>
    <id>https://stonefishy.github.io/2024/11/01/understanding-the-azure-openai-gpt-4-api-role/</id>
    <published>2024-11-01T10:34:01.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p><code>Azure OpenAI</code> is a service provided by Microsoft that integrates OpenAI‚Äôs advanced language models into the Azure cloud platform. It allows developers to access and use OpenAI‚Äôs capabilities, such as natural language processing, code generation, and more, through Azure‚Äôs infrastructure.</p><p>Recently, we have deployed our first version of the OpenAI <code>GPT-4</code> model into the Azure cloud platform. This model is a powerful natural language model that can generate text based on a given prompt.</p><h2 id="What-is-GPT-4"><a href="#What-is-GPT-4" class="headerlink" title="What is GPT-4?"></a>What is GPT-4?</h2><p><code>GPT-4</code> is a transformer-based language model that was developed by OpenAI. It is a powerful language model that can generate text based on a given prompt. It has been trained on a large dataset of text and can generate coherent and engaging text that is often considered to be the next big thing in language models.</p><h2 id="How-can-I-use-the-GPT-4-API"><a href="#How-can-I-use-the-GPT-4-API" class="headerlink" title="How can I use the GPT-4 API?"></a>How can I use the GPT-4 API?</h2><p>To use the GPT-4 API, you need to follow these steps:</p><ol><li>Create an Azure account.</li><li>Create a resource group.</li><li>Create a new OpenAI resource.</li><li>Generate an API key.</li><li>Use the API key to make API requests.</li></ol><h3 id="1-Create-an-Azure-account"><a href="#1-Create-an-Azure-account" class="headerlink" title="1. Create an Azure account"></a>1. Create an Azure account</h3><p>To use the GPT-4 API, you need to have an Azure account. If you don‚Äôt have one, you can create one for free by following the steps in the <a href="https://azure.microsoft.com/en-us/free/">Azure sign-up page</a>.</p><h3 id="2-Create-a-resource-group"><a href="#2-Create-a-resource-group" class="headerlink" title="2. Create a resource group"></a>2. Create a resource group</h3><p>Create a resource group to organize your Azure resources. To create a new resource group, follow these steps:</p><ol><li>Go to the <a href="https://portal.azure.com/">Azure portal</a>.</li><li>Click on the <code>Resource groups</code> option in the left-hand menu.</li><li>Click on the <code>+ Create</code> button.</li><li>Enter a name for your resource group and select your subscription.</li><li>Click on the <code>Review + create</code> button.</li></ol><h3 id="3-Create-a-new-OpenAI-resource"><a href="#3-Create-a-new-OpenAI-resource" class="headerlink" title="3. Create a new OpenAI resource"></a>3. Create a new OpenAI resource</h3><p>To create a new OpenAI resource, follow these steps:</p><ol><li>Go to the <a href="https://portal.azure.com/">Azure portal</a>.</li><li>Click on the <code>Create a resource</code> button.</li><li>Search for <code>OpenAI</code> in the search bar.</li><li>Click on the <code>OpenAI</code> resource.</li><li>Click on the <code>Create</code> button.</li><li>Enter a name for your OpenAI resource and select your subscription.</li><li>Select the resource group you created earlier.</li><li>Select the pricing tier.</li><li>Click on the <code>Create</code> button.</li></ol><h3 id="4-Generate-an-API-key"><a href="#4-Generate-an-API-key" class="headerlink" title="4. Generate an API key"></a>4. Generate an API key</h3><p>To generate an API key, follow these steps:</p><ol><li>Go to the <a href="https://portal.azure.com/">Azure portal</a>.</li><li>Click on the <code>All resources</code> option in the left-hand menu.</li><li>Search for your OpenAI resource.</li><li>Click on the resource.</li><li>Click on the <code>Show access keys</code> button.</li><li>Copy the <code>Key 1</code> value.</li></ol><h3 id="5-Use-the-API-key-to-make-API-requests"><a href="#5-Use-the-API-key-to-make-API-requests" class="headerlink" title="5. Use the API key to make API requests"></a>5. Use the API key to make API requests</h3><p>To make API requests, we need to include the API key in the request headers. Here‚Äôs an example of how to make a request to the GPT-4 API with REST styles. </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="variable">$AZURE_OPENAI_ENDPOINT</span>/openai/deployments/gpt-4o/chat/completions?api-version=2023-07-01-preview \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;api-key: <span class="variable">$AZURE_OPENAI_API_KEY</span>&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;messages&quot;:[&#123;&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;There are 5 classifications: Suggestion, Meanless, Compliment, Complaint, Please provide a classification for user input.&quot;&#125;,&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Does Azure OpenAI support customer managed keys?&quot;&#125;,&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;A classification word&quot;&#125;,&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;its great and easy to use&quot;&#125;]&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>Place your API key and endpoint in the appropriate variables, and update which deployments model (gpt-4, gpt-4o or other models) and model version of your endpoint is using.</p><p>The Azure OpenAI also supports multiple programming languages, including <code>Python</code>, <code>JavaScript</code>, and <code>C#</code>. You can use the API to generate text in your preferred programming language.</p><h2 id="GPT-4-Chat-Roles"><a href="#GPT-4-Chat-Roles" class="headerlink" title="GPT-4 Chat Roles"></a>GPT-4 Chat Roles</h2><p>In above message parameter, you may notice thata there are three roles: <code>system</code>, <code>user</code>, and <code>assistant</code>. The GPT-4 API supports three chat roles. Let digger deeper into each role:</p><p><strong>System</strong>: This role sets the context or guidelines for the conversation. It‚Äôs where you can specify instructions or constraints for how the assistant should behave throughout the interaction.</p><p><strong>User</strong>: This role represents the input from the person interacting with the model. Any questions or prompts posed by the user fall under this role.</p><p><strong>Assistant</strong>: This role is for the model‚Äôs responses. It contains the output generated by the assistant based on the user input and the context provided by the system.</p><p>In another word. The <code>system</code> role sets the context, the <code>user</code> role represents the input, and the <code>assistant</code> role contains the output.</p><blockquote><p>Use system to define the conversation‚Äôs tone, behavior, or rules.<br>Use user for all queries or statements made by the person.<br>Use assistant for the model‚Äôs replies.</p></blockquote><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><p>Let‚Äôs say we want to classify the product feedback classification as <code>Suggestion</code>, <code>Meanless</code>, <code>Compliment</code>, <code>Complaint</code>, or <code>Others</code>. We can use the GPT-4 API to generate text based on the given prompt and classify the feedback.</p><p>First, we define the context or guidelines to let the assistant know what result we want to achieve. Given below content to the <code>system</code> role.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;role&quot;: &quot;system&quot;, &quot;content&quot;: &quot;There are 5 classifications: Suggestion, Meanless, Compliment, Complaint, Please provide a classification for user input.&quot;&#125;,</span><br></pre></td></tr></table></figure><p>And, we only the <code>OpenAI</code> to reply me the classification word when user input is provided. So we define the <code>assistant</code> role as <code>classification word</code>.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;role&quot;: &quot;assistant&quot;, &quot;content&quot;: &quot;A classification word&quot;&#125;</span><br></pre></td></tr></table></figure><p>Now, we can ask the user to provide the feedback and provide the <code>user</code> role.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;its great and easy to use&quot;&#125;</span><br></pre></td></tr></table></figure><p>After the conversation, the <code>assistant</code> role will provide the classification word as <code>Compliment</code>. You will notice that there is a piece of json indicates the <code>assistant</code> role content value in the response. The OpenAI gpt-4o model knows ‚Äúits great and easy to use‚Äù is a ‚ÄúCompliment‚Äù and provides the classification word as ‚ÄúCompliment‚Äù.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Compliment&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;assistant&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/openai-chat-role-api-usage-example-1.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/openai-chat-role-api-usage-example-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Classification - its great and easy to use" style="width:800px;"/></div><span class="image-caption">Classification - its great and easy to use</span></div><p>Let‚Äôs try another user input.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;I&#x27;m in your walls&quot;&#125;</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/openai-chat-role-api-usage-example-2.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/openai-chat-role-api-usage-example-2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Classification - I'm in your walls" style="width:800px;"/></div><span class="image-caption">Classification - I'm in your walls</span></div><p>The <code>assistant</code> role will provide the classification word as <code>Meanless</code>. Because this input is not meanful for any product feedback.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In this article, we have explored the role of the Azure OpenAI GPT-4 API and how it can be used to generate text. We have also learned about the chat roles and how to use them to classify the product feedback.</p>]]></content>
    
    
    <summary type="html">In this article, we will explore the role of the Azure OpenAI GPT-4 API and how it can be used to generate text.</summary>
    
    
    
    <category term="AI/ML" scheme="https://stonefishy.github.io/categories/AI-ML/"/>
    
    
    <category term="AI" scheme="https://stonefishy.github.io/tags/AI/"/>
    
    <category term="OpenAI" scheme="https://stonefishy.github.io/tags/OpenAI/"/>
    
    <category term="Azure" scheme="https://stonefishy.github.io/tags/Azure/"/>
    
    <category term="GPT-4" scheme="https://stonefishy.github.io/tags/GPT-4/"/>
    
  </entry>
  
  <entry>
    <title>Data Analysis Chart by Generative AI</title>
    <link href="https://stonefishy.github.io/2024/10/29/data-analysis-chart-by-generative-ai/"/>
    <id>https://stonefishy.github.io/2024/10/29/data-analysis-chart-by-generative-ai/</id>
    <published>2024-10-29T14:18:48.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>In data analysis, we often need to create charts to visualize the data by using BI tools, such as <code>Tableau</code>, <code>Power BI</code>, <code>AWS Quicksight</code>, or <code>Qlik Sense</code>. These tools allow us to create interactive and visually appealing charts, which can help us to identify patterns and trends in the data.</p><h2 id="General-Solution-Architecture-for-Data-Analysis-BI-Chart"><a href="#General-Solution-Architecture-for-Data-Analysis-BI-Chart" class="headerlink" title="General Solution Architecture for Data Analysis BI Chart"></a>General Solution Architecture for Data Analysis BI Chart</h2><p>The general data analysis BI chart solution architecture like below:</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/bi-chart-general-arch.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/bi-chart-general-arch.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="General Solution Architecture for Data Analysis BI Chart" style="width:800px;"/></div><span class="image-caption">General Solution Architecture for Data Analysis BI Chart</span></div>.<p>Usually, the engieering create business chart by using BI tools after data is ETL proceseed. If the business want to see the data distribution chart, they need to ask the data engineer to create the chart. The data engineer will create the chart using BI tools and share it with the business. This may take some time and effort.</p><h2 id="Solution-Architecture-for-Data-Analysis-BI-Chart-by-Generative-AI"><a href="#Solution-Architecture-for-Data-Analysis-BI-Chart-by-Generative-AI" class="headerlink" title="Solution Architecture for Data Analysis BI Chart by Generative AI"></a>Solution Architecture for Data Analysis BI Chart by Generative AI</h2><p>Think about the scenario where the business want to see the data distribution chart without the data engineer‚Äôs help. How can we create the chart without the data engineer‚Äôs help?</p><p>One way to create the data distribution chart without the data engineer‚Äôs help is to use a generative AI model. The business just need to describe what the data they want to see and want to display as which chart type. The generative AI application will create the chart for them.</p><p>The core important thing we need to let the GenAI to understand user‚Äôs natural language and generate the information which application can be use. The solution architecture like below:</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/bi-chart-AI-arch.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/bi-chart-AI-arch.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AI Solution Architecture for Data Analysis BI Chart" style="width:800px;"/></div><span class="image-caption">AI Solution Architecture for Data Analysis BI Chart</span></div>.<p>The AI application will take the user‚Äôs natural language as input and generate the chart for them. The AI application will use the following steps to generate the chart:</p><ol><li>Understand the user‚Äôs natural language and generate the chart title, chart type and chart related sql.</li><li>Connect to the database or dataset and execute the chart related sql to get the data.</li><li>Use the data to create the chart using the chart type.</li></ol><p>The AI model could be <code>ChatGPT</code>, <code>OpenAI</code> or <code>Claude</code> model. The AI model will generate the chart related sql, chart type and chart title based on the user‚Äôs natural language. The AI model will use the chart type to create the chart.</p><p>For example, if the user‚Äôs natural language is ‚ÄúShow the distribution of the sales by product category‚Äù, the AI application will generate the chart title as ‚ÄúSales Distribution by Product Category‚Äù and chart type as ‚ÄúBar Chart‚Äù. The AI application will execute the following sql to get the data:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> product_category, <span class="built_in">SUM</span>(sales) <span class="keyword">as</span> total_sales</span><br><span class="line"><span class="keyword">FROM</span> sales_data</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> product_category</span><br></pre></td></tr></table></figure><p>Below is a demo to generate the chart for the user‚Äôs natural language base on testing sample data.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/bi-chart-by-ai-test-1.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/bi-chart-by-ai-test-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" style="width:800px;"/></div></div>.<p>User input natural language: </p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;I want to see the distribution of all product categories with duplicate devices removed, and exclude the empty category, please display it in a pie chart.&quot;</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/bi-chart-by-ai-test-1a.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/bi-chart-by-ai-test-1a.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" style="width:800px;"/></div></div>.<p>The AI model response below base on the user‚Äôs natural language and prompts.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    &#x27;sql&#x27;<span class="punctuation">:</span> <span class="string">&quot;SELECT category, COUNT(DISTINCT macaddress) as device_count FROM device_demo_data WHERE category != &#x27;&#x27; GROUP BY category ORDER BY device_count DESC&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    &#x27;chart&#x27;<span class="punctuation">:</span> &#x27;pie&#x27;<span class="punctuation">,</span> </span><br><span class="line">    &#x27;title&#x27;<span class="punctuation">:</span> &#x27;Distribution of Unique Devices by Product Category&#x27;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>There is a question, how the AI model know to generate this data format for us? Actually it is because we provide the prompts to the AI model. The prompts will guide the AI model to generate the chart related sql, chart type and chart title. Below is sample prompts:</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">You are a data analyst. Below is the table structure information about devices reported data. I will ask you questions, and then please generate the json data format &#123;&#x27;sql&#x27;:&#x27;&#x27;,&#x27;chart&#x27;:&#x27;table&#x27;,&#x27;title&#x27;:&#x27;&#x27;&#125; based on the questions I asked. </span><br><span class="line">Emphasize: I only need this json data format. The &#x27;sql&#x27; value is used by AWS Athena to query and generate the chart data. </span><br><span class="line">The &#x27;chart&#x27; value is the chart type, &#x27;numeric&#x27; represents a just a number, &#x27;table&#x27; represents a table chart, &#x27;pie&#x27; represents a pie chart, &#x27;bar&#x27; represents a bar chart, &#x27;line&#x27; represents a line chart. </span><br><span class="line">The &#x27;title&#x27; value is the chart title. Please remember, I only need the json string format data, don&#x27;t need other sentence.</span><br><span class="line">CREATE EXTERNAL TABLE `device_demo_data`(</span><br><span class="line">  `macaddress` string COMMENT &#x27;ËÆæÂ§ámacÂú∞ÂùÄ / The device macaddress&#x27;, </span><br><span class="line">  `productname` string COMMENT &#x27;ËÆæÂ§á‰∫ßÂìÅÂêçÁß∞ / The device product name&#x27;, </span><br><span class="line">  `category` string COMMENT &#x27;ËÆæÂ§á‰∫ßÂìÅÁöÑÂàÜÁ±ª / The device product category&#x27;, </span><br><span class="line">  `country` string COMMENT &#x27;ËÆæÂ§áÊâÄÂú®ÁöÑÂõΩÂÆ∂ / The country where the device is located&#x27;, </span><br><span class="line">  `region` string COMMENT &#x27;ËÆæÂ§á‰∏ä‰º†Êï∞ÊçÆÊâÄÂú®ÁöÑÂå∫Âüü / The region where the device data is reported&#x27;, </span><br><span class="line">  `default_region` string COMMENT &#x27;ËÆæÂ§áÂá∫ÂéÇËÆæÁΩÆÁöÑÈªòËÆ§Âå∫Âüü / The default region set by the device&#x27;, </span><br><span class="line">  `oneosversion` string COMMENT &#x27;ËÆæÂ§áOneOSÁöÑÁâàÊú¨Âè∑ / The OneOS version of the device&#x27;, </span><br><span class="line">  `firmwareversion` string COMMENT &#x27;ËÆæÂ§áÁöÑÂõ∫‰ª∂ÁâàÊú¨Âè∑ / The firmware version of the device&#x27;, </span><br><span class="line">  `officialversion` string COMMENT &#x27;ËÆæÂ§áÊòØÂê¶ÊòØÂÆòÊñπÁöÑÂèëÂ∏ÉÁâàÊú¨Ôºå1‰∏∫ÂÆòÊñπÁâàÊú¨Ôºå 0‰∏∫ÈùûÂÆòÊñπÁâàÊú¨ / Whether the device is an official release, 1 for official version, 0 for non-official version&#x27;, </span><br><span class="line">  `createtime` string COMMENT &#x27;ËÆæÂ§á‰∏äÊä•Êï∞ÊçÆÁöÑÊó•Êúü, Êï∞ÊçÆÁ±ªÂûãÊòØÂ≠óÁ¨¶‰∏≤ÔºåÊó•ÊúüÊ†ºÂºèÊòØ2024-09-01ÔºåË°®Á§∫2024Âπ¥9Êúà1Êó• / The date when the device reported data, the data type is string, the date format is 2024-09-01, which means September 1, 2024&#x27;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>We tell AI model the data schema and each field means, and indicate only need the json format response with specific field. Once the AI model generate the response, we can use it to create the chart for the user‚Äôs natural language.</p><p>We can also generate the line chart base on time line.</p><p>User input natural language: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">How many distinct devices reported every week, exclude the empty date, display the data in line graph</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/bi-chart-by-ai-test-2.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/bi-chart-by-ai-test-2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" style="width:800px;"/></div></div>.<p>For the front-end UI to display the chart, we can use some chart library like <code>Echarts</code>, <code>Hightcharts</code>, <code>D3.js</code> or <code>Chart.js</code>. The front-end UI display the chart base on chart type and the data which queried by SQL.</p><p>All these generated charts can be added into dashboard.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/bi-chart-by-ai-dashboard.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/bi-chart-by-ai-dashboard.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" style="width:800px;"/></div></div>.<h2 id="Limitation"><a href="#Limitation" class="headerlink" title="Limitation"></a>Limitation</h2><p>As you can see, the AI solution architecture is a new way to create BI chart. However, it still has some limitations. It can not generate the complex chart which like some BI tools advanced chart fucntionality. But it is still a good start to create the chart for business users.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;In data analysis, we often need to create charts to visualize the data by using BI tools, such as &lt;code&gt;Tableau&lt;/code&gt;, &lt;code&gt;Power BI&lt;/c</summary>
      
    
    
    
    <category term="AI/ML" scheme="https://stonefishy.github.io/categories/AI-ML/"/>
    
    
    <category term="AI" scheme="https://stonefishy.github.io/tags/AI/"/>
    
    <category term="Python" scheme="https://stonefishy.github.io/tags/Python/"/>
    
    <category term="AWS" scheme="https://stonefishy.github.io/tags/AWS/"/>
    
    <category term="SQL" scheme="https://stonefishy.github.io/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>The Intelligent SQL Generator base on Spring AI with AWS Bedrock</title>
    <link href="https://stonefishy.github.io/2024/10/23/intelligent-sql-generator-base-on-spring-ai-with-aws-bedrock/"/>
    <id>https://stonefishy.github.io/2024/10/23/intelligent-sql-generator-base-on-spring-ai-with-aws-bedrock/</id>
    <published>2024-10-23T15:01:12.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>The generative AI is a type of artificial intelligence (AI) that can learn from data and generate new data. In this article, we will discuss how to build an intelligent SQL generator using <code>Spring AI</code> and <code>AWS Bedrock</code>. For example, the application able to provide the data sql to us after we input the natural language questions, and we can query the data by using the sql, even display the chart base on data queried.</p><h2 id="Spring-AI"><a href="#Spring-AI" class="headerlink" title="Spring AI"></a>Spring AI</h2><p>The <code>Spring AI</code> is a project of <code>Spring</code>. It support for all major AI Model providers such as <code>Anthropic</code>, <code>OpenAI</code>, <code>Microsoft</code>, <code>Amazon</code>, <code>Google</code>, and <code>Ollama</code>. Model type supports such as <code>Chart Completion</code>, <code>Text to Image</code>, <code>Text to Speech</code>, <code>Translation</code>, <code>Audio Transcription</code> and so on. It make it easy to integrate AI models into the application.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/spring-ai.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/spring-ai.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Spring AI" style="width:500px;"/></div><span class="image-caption">Spring AI</span></div><h2 id="AWS-Bedrock"><a href="#AWS-Bedrock" class="headerlink" title="AWS Bedrock"></a>AWS Bedrock</h2><p>Amazon Bedrock is a fully managed service that makes FMs from leading AI startups and Amazon available via an API, so you can choose from a wide range of FMs to find the model that is best suited for your use case. It contains <code>Anthropic</code> (<code>Claude</code>), <code>Meta</code> (<code>Llama</code>) and <code>Stability AI</code> models. In this blog, we will use <code>Claude</code> AI model of <code>Anthropic</code> to build our intelligent SQL generator.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/aws-bedrock-ai.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/aws-bedrock-ai.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Bedrock" style="width:600px;"/></div><span class="image-caption">AWS Bedrock</span></div><h2 id="Building-Intelligent-SQL-Generator"><a href="#Building-Intelligent-SQL-Generator" class="headerlink" title="Building Intelligent SQL Generator"></a>Building Intelligent SQL Generator</h2><p>Assuming we‚Äôre data analyzer, we have product_sales, products and customers three tables data in mysql. And we want to query the data by input natural language instead of write specific SQL manually. We can use AI to understand user natural langauge to generate the SQL base on table schemas. Let‚Äôs get start. </p><h3 id="Create-a-new-Spring-Boot-project"><a href="#Create-a-new-Spring-Boot-project" class="headerlink" title="Create a new Spring Boot project"></a>Create a new Spring Boot project</h3><p>Create a <code>Spring Boot</code> project with restful api, add the following dependencies in maven <code>pom.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.ai<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-ai-bedrock-ai-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>The <code>spring-ai-bedrock-ai-spring-boot-starter</code> is library that provides integration with <code>AWS Bedrock</code> models in <code>Spring AI</code>.</p><h3 id="Configure-AWS-Bedrock-configuraitons"><a href="#Configure-AWS-Bedrock-configuraitons" class="headerlink" title="Configure AWS Bedrock configuraitons"></a>Configure AWS Bedrock configuraitons</h3><p>In application.properties, configur below configurations.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=spring-ai-datasql</span><br><span class="line">spring.ai.bedrock.aws.region=us-east-1</span><br><span class="line">spring.ai.bedrock.aws.timeout=5m</span><br><span class="line">spring.ai.bedrock.anthropic3.chat.enabled=true</span><br><span class="line">spring.ai.bedrock.anthropic3.chat.options.max-tokens=4000</span><br><span class="line"></span><br><span class="line"># config below AWS credential key, configure it in Java environments or System environments</span><br><span class="line">spring.ai.bedrock.aws.access-key=$&#123;AWS_ACCESS_KEY_ID&#125;</span><br><span class="line">spring.ai.bedrock.aws.secret-key=$&#123;AWS_SECRET_ACCESS_KEY&#125;</span><br></pre></td></tr></table></figure><h3 id="Prepare-prompts-for-AI"><a href="#Prepare-prompts-for-AI" class="headerlink" title="Prepare prompts for AI"></a>Prepare prompts for AI</h3><p>Since we only need AI to generate the SQL base on mysql table schema. So we need prepare prompts to <code>AI</code> to fully understand our requirements. Below is <code>prompts.txt</code></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">There are 3 mysql tables schema product_sales, products, customers.</span><br><span class="line">CREATE TABLE product_sales (</span><br><span class="line">    sale_id INT AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">    product_id INT NOT NULL,</span><br><span class="line">    sale_date DATETIME DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    price DECIMAL(10, 2) NOT NULL,</span><br><span class="line">    customer_id INT,</span><br><span class="line">    region VARCHAR(100),</span><br><span class="line">    FOREIGN KEY (product_id) REFERENCES products(product_id),</span><br><span class="line">    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)</span><br><span class="line">);</span><br><span class="line">CREATE TABLE products (</span><br><span class="line">    product_id INT AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">    product_name VARCHAR(100),</span><br><span class="line">    product_category VARCHAR(100)</span><br><span class="line">);</span><br><span class="line">CREATE TABLE customers (</span><br><span class="line">    customer_id INT AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">    customer_name VARCHAR(100)</span><br><span class="line">);</span><br><span class="line">I will ask you question, please base on table schema to generate the SQL text in single line, please note I only need full correct sql text, do not</span><br><span class="line">need other text or any other characters.</span><br></pre></td></tr></table></figure><p>In above prompts, you can see it tells AI we only need SQL text base on the 3 mysql table schemas.</p><h3 id="Core-Code"><a href="#Core-Code" class="headerlink" title="Core Code"></a>Core Code</h3><p>Create a restful controller and pass the prompts and user input message to AI model.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> spring.ai.datasql.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.ai.bedrock.anthropic3.BedrockAnthropic3ChatModel;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> spring.ai.datasql.service.PromptService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLGenController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BedrockAnthropic3ChatModel chatModel;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PromptService prompts;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SQLGenController</span><span class="params">(BedrockAnthropic3ChatModel chatModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.chatModel = chatModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/ai/sql&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">generate</span><span class="params">(<span class="meta">@RequestBody</span> String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">newMsg</span> <span class="operator">=</span> prompts.getContent() + message;</span><br><span class="line">        <span class="keyword">return</span> Map.of(<span class="string">&quot;sql&quot;</span>, chatModel.call(newMsg));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In above code, we inject <code>BedrockAnthropic3ChatModel</code> which is <code>Anthropic</code> model of <code>AWS Bedrock</code> provided by <code>Spring AI</code>. We also inject <code>PromptService</code> which is a service to read prompts.<br>In <code>generate</code> method, we read prompts from <code>PromptService</code> and append user input message to it. Then we call <code>chatModel.call</code> method to generate the SQL text.</p><p>Code of <code>PromptService</code> to read prompts from file.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> spring.ai.datasql.service;</span><br><span class="line"><span class="keyword">import</span> jakarta.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PromptService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;classpath:prompts.txt&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> org.springframework.core.io.Resource resource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String fileContent;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        fileContent = <span class="keyword">new</span> <span class="title class_">String</span>(Files.readAllBytes(Paths.get(resource.getURI())));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> fileContent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Run-the-application"><a href="#Run-the-application" class="headerlink" title="Run the application"></a>Run the application</h3><p>Run the application and test the API by sending a request with user input message. We may encounter below errors.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/aws-bedrock-model-can-not-access.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/aws-bedrock-model-can-not-access.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Bedrock Model can not access"/></div><span class="image-caption">AWS Bedrock Model can not access</span></div><p>This is because the <code>spring.ai.bedrock.anthropic3.chat.model</code> in  current Spring AI version default value is <code>anthropic.claude-3-sonnet-20240229-v1:0</code>. Let‚Äôs check the anthropic available Claude models in AWS Bedrock. Here we use <code>Claude 3.5</code> AI model.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/aws-bedrock-claude-model-id.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/aws-bedrock-claude-model-id.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Bedrock Anthropic Claude Model Id"/></div><span class="image-caption">AWS Bedrock Anthropic Claude Model Id</span></div><p>Copy this model id and update the <code>spring.ai.bedrock.anthropic3.chat.model</code> in <code>application.properties</code> file. The fully updated <code>application.properties</code> file should be like below.</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=spring-ai-datasql</span><br><span class="line">spring.ai.bedrock.aws.region=us-east-1</span><br><span class="line">spring.ai.bedrock.aws.timeout=5m</span><br><span class="line">spring.ai.bedrock.anthropic3.chat.enabled=true</span><br><span class="line">spring.ai.bedrock.anthropic3.chat.options.max-tokens=4000</span><br><span class="line">spring.ai.bedrock.anthropic3.chat.model=anthropic.claude-3-5-sonnet-20240620-v1:0</span><br><span class="line"></span><br><span class="line"># config below AWS credential key, it also can be configure in Java environments or System environments</span><br><span class="line">spring.ai.bedrock.aws.access-key=$&#123;AWS_ACCESS_KEY_ID&#125;</span><br><span class="line">spring.ai.bedrock.aws.secret-key=$&#123;AWS_SECRET_ACCESS_KEY&#125;</span><br></pre></td></tr></table></figure><p>Now, we can run the application and test the API.</p><h4 id="Test-Example-1"><a href="#Test-Example-1" class="headerlink" title="Test Example 1"></a>Test Example 1</h4><p><strong>Input:</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">What&#x27;s the total prices of product sales ?</span><br></pre></td></tr></table></figure><p><strong>Output:</strong></p><p>The response will be like below.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">SUM</span>(price) <span class="keyword">FROM</span> product_sales;</span><br></pre></td></tr></table></figure><p><strong>Postman Screenshot:</strong></p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/gen-sql-by-ai-test-1.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/gen-sql-by-ai-test-1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><p>The <code>AI</code> model can generate the SQL text base on user input message.</p><h4 id="Test-Example-2"><a href="#Test-Example-2" class="headerlink" title="Test Example 2"></a>Test Example 2</h4><p><strong>Input:</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">How many customers by our products? I only need unique customers.</span><br></pre></td></tr></table></figure><p><strong>Output:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> customer_id) <span class="keyword">FROM</span> product_sales</span><br></pre></td></tr></table></figure><p><strong>Postman Screenshot:</strong></p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/gen-sql-by-ai-test-2.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/gen-sql-by-ai-test-2.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><h4 id="Test-Example-3"><a href="#Test-Example-3" class="headerlink" title="Test Example 3"></a>Test Example 3</h4><p><strong>Input:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I want to see the total sales prices for each product categories.</span><br></pre></td></tr></table></figure><p><strong>Output:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> product_category, <span class="built_in">SUM</span>(price) <span class="keyword">AS</span> total_sales <span class="keyword">FROM</span> product_sales <span class="keyword">JOIN</span> products <span class="keyword">ON</span> product_sales.product_id <span class="operator">=</span> products.product_id <span class="keyword">GROUP</span> <span class="keyword">BY</span> product_category;</span><br></pre></td></tr></table></figure><p><strong>Postman Screenshot:</strong></p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/gen-sql-by-ai-test-3.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/gen-sql-by-ai-test-3.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><h4 id="Test-Example-4"><a href="#Test-Example-4" class="headerlink" title="Test Example 4"></a>Test Example 4</h4><p><strong>Input:</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please show me all sales data which contains price, sales date, customer name and product name and product categories</span><br></pre></td></tr></table></figure><p><strong>Output:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> ps.price, ps.sale_date, c.customer_name, p.product_name, p.product_category <span class="keyword">FROM</span> product_sales ps <span class="keyword">JOIN</span> products p <span class="keyword">ON</span> ps.product_id <span class="operator">=</span> p.product_id <span class="keyword">JOIN</span> customers c <span class="keyword">ON</span> ps.customer_id <span class="operator">=</span> c.customer_id</span><br></pre></td></tr></table></figure><p><strong>Postman Screenshot:</strong></p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/gen-sql-by-ai-test-4.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/gen-sql-by-ai-test-4.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><h4 id="Test-Example-5"><a href="#Test-Example-5" class="headerlink" title="Test Example 5"></a>Test Example 5</h4><p><strong>Input:</strong> </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please show total sales prices of each product category on 2nd quarter this year</span><br></pre></td></tr></table></figure><p><strong>Output:</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> p.product_category, <span class="built_in">SUM</span>(ps.price) <span class="keyword">AS</span> total_sales <span class="keyword">FROM</span> product_sales ps <span class="keyword">JOIN</span> products p <span class="keyword">ON</span> ps.product_id <span class="operator">=</span> p.product_id <span class="keyword">WHERE</span> <span class="keyword">YEAR</span>(ps.sale_date) <span class="operator">=</span> <span class="keyword">YEAR</span>(CURDATE()) <span class="keyword">AND</span> QUARTER(ps.sale_date) <span class="operator">=</span> <span class="number">2</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> p.product_category</span><br></pre></td></tr></table></figure><p><strong>Postman Screenshot:</strong></p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/ai-ml/gen-sql-by-ai-test-5.png" class="lazyload placeholder" data-srcset="/assets/images/ai-ml/gen-sql-by-ai-test-5.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><p>As you can see the <code>AI</code> model can generate the SQL text base on user input message. Base on this function, we can download the data from mysql or display the chart base on data queried. It‚Äôs good for business analyst to query the data by natural language.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;The generative AI is a type of artificial intelligence (AI) that can learn from data and generate new data. In this article, we will disc</summary>
      
    
    
    
    <category term="AI/ML" scheme="https://stonefishy.github.io/categories/AI-ML/"/>
    
    
    <category term="Java" scheme="https://stonefishy.github.io/tags/Java/"/>
    
    <category term="Spring" scheme="https://stonefishy.github.io/tags/Spring/"/>
    
    <category term="AI" scheme="https://stonefishy.github.io/tags/AI/"/>
    
    <category term="AWS" scheme="https://stonefishy.github.io/tags/AWS/"/>
    
    <category term="SQL" scheme="https://stonefishy.github.io/tags/SQL/"/>
    
    <category term="Spring AI" scheme="https://stonefishy.github.io/tags/Spring-AI/"/>
    
  </entry>
  
  <entry>
    <title>The useEffect of React Runs Twice in Development Mode.</title>
    <link href="https://stonefishy.github.io/2024/10/16/the-useeffect-of-react-runs-twice-in-development-mode/"/>
    <id>https://stonefishy.github.io/2024/10/16/the-useeffect-of-react-runs-twice-in-development-mode/</id>
    <published>2024-10-16T16:23:44.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>Have you noticed that your <code>useEffect</code> hook of <code>React</code> runs twice when the page first loads in development mode? This occurs because since <code>React 18</code>, it can be confusing, especially for new developers. Let‚Äôs explore why this happens and what it means.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/react/react-hook-useEffect.png" class="lazyload placeholder" data-srcset="/assets/images/react/react-hook-useEffect.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="React Hook useEffect" style="width:800px;"/></div><span class="image-caption">React Hook useEffect</span></div><h2 id="What-is-useEffect"><a href="#What-is-useEffect" class="headerlink" title="What is useEffect?"></a>What is <code>useEffect</code>?</h2><p><code>useEffect</code> is a hook that allows you to perform side effects in your components. Side effects can be things like <strong>fetching data</strong>, <strong>subscribing to events</strong>, or <strong>changing the DOM</strong>. This hook takes two arguments:</p><ol><li>A function to run your side effect.</li><li>An optional array of dependencies that tells React when to run the effect again.</li></ol><p>Here‚Äôs a simple example of useEffect in action:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useEffect, useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ExampleComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Effect has been executed&#x27;</span>);</span><br><span class="line">    <span class="comment">// Side effect logic here</span></span><br><span class="line">  &#125;, [count]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>You clicked &#123;count&#125; times<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;Click me<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In above code, the log ‚ÄòEffect has been executed‚Äô will be printed to the console twice when the component is first render on development mode.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/react/react-useEffect-runs-twice.png" class="lazyload placeholder" data-srcset="/assets/images/react/react-useEffect-runs-twice.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="React useEffect runs twice in development mode"/></div><span class="image-caption">React useEffect runs twice in development mode</span></div><h2 id="Why-Does-useEffect-Run-Twice-in-Development-Mode"><a href="#Why-Does-useEffect-Run-Twice-in-Development-Mode" class="headerlink" title="Why Does useEffect Run Twice in Development Mode?"></a>Why Does useEffect Run Twice in Development Mode?</h2><p>When you run your React app in development mode, you might see that the useEffect runs twice when the component loads for the first time. This can be confusing, especially for new developers.</p><h3 id="Reasons-for-the-Double-Execution"><a href="#Reasons-for-the-Double-Execution" class="headerlink" title="Reasons for the Double Execution"></a>Reasons for the Double Execution</h3><p><strong>Strict Mode:</strong> This behavior is part of React‚Äôs <code>Strict Mode</code>. It purposely runs certain lifecycle methods and hooks like useEffect twice during development. This helps check if your code can handle side effects correctly.</p><p><strong>Testing Effects:</strong> By running the effect two times, React tests if your side effects can handle being called multiple times without causing bugs. This helps catch problems early.</p><h3 id="What-Happens-in-Production"><a href="#What-Happens-in-Production" class="headerlink" title="What Happens in Production?"></a>What Happens in Production?</h3><span class='pbg danger'>The double call only happens in development mode. When you make your app for production</span><h2 id="How-to-Handle-the-Double-Execution"><a href="#How-to-Handle-the-Double-Execution" class="headerlink" title="How to Handle the Double Execution"></a>How to Handle the Double Execution</h2><p>Here are some tips for dealing with the double execution of useEffect:</p><p><strong>Be Careful with State Updates</strong>: If your effect updates state, make sure it‚Äôs safe to run the effect multiple times without causing issues.</p><p><strong>Use Cleanup Functions</strong>: Always return a cleanup function from your useEffect to free up resources and avoid memory issues.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// Your side effect code here</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// Cleanup code here</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, [dependencies]);</span><br></pre></td></tr></table></figure><p><strong>Test Your Effects</strong>: Use the extra invocation to ensure that your effects work correctly.</p><h2 id="Disable-Strict-Mode"><a href="#Disable-Strict-Mode" class="headerlink" title="Disable Strict Mode"></a>Disable Strict Mode</h2><p>It is not recommend this way, but if you want to disable Strict Mode, in <code>React 18</code> you can disable Strict Mode by removing the <code>&lt;React.StrictMode&gt;</code> tag from the return statement in your root component.</p><p>In <code>Next.js</code>, you can disable Strict Mode by setting the following parameter in <code>next.config.js</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">reactStrictMode</span>: <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><span class='pbg green'>Seeing useEffect run twice in development mode can be surprising</span> Understanding this behavior and preparing your code for it will allow you to use React hooks effectively and build better applications.<p>Even though this might seem confusing at first, it‚Äôs an important part of the React development experience. Happy coding!</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Have you noticed that your &lt;code&gt;useEffect&lt;/code&gt; hook of &lt;code&gt;React&lt;/code&gt; runs twice when the page first loads in development mode? Th</summary>
      
    
    
    
    <category term="Frontend" scheme="https://stonefishy.github.io/categories/Frontend/"/>
    
    
    <category term="JavaScript" scheme="https://stonefishy.github.io/tags/JavaScript/"/>
    
    <category term="React" scheme="https://stonefishy.github.io/tags/React/"/>
    
  </entry>
  
  <entry>
    <title>AWS Glue Iceberg tables schema can&#39;t be updated with Pulumi</title>
    <link href="https://stonefishy.github.io/2024/10/09/aws-glue-iceberg-tables-schema-can-t-be-updated-with-pulumi/"/>
    <id>https://stonefishy.github.io/2024/10/09/aws-glue-iceberg-tables-schema-can-t-be-updated-with-pulumi/</id>
    <published>2024-10-09T09:46:22.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>Recently, we‚Äôre planing to use <code>Pulumi</code> to manage all current existing <code>AWS Glue Datacatalog</code> tables which are <code>Iceberg</code> format. For the <code>Iceberg</code> tables, I have post a blog before to talk about what is iceberg and what‚Äôs feature of it. Here is post link: <a href="https://stonefishy.github.io/2020/05/23/what-is-apache-iceberg/">https://stonefishy.github.io/2020/05/23/what-is-apache-iceberg/</a></p><p>To manage the AWS Glue Iceberg tables with <code>Pulumi</code>, due to our catalog table schemas are continue changes base on requirements. We need to do some technical POC whethere the pulumi can also support to update the iceberg metadata schema as well.</p><h2 id="Create-Glue-Iceberg-Table"><a href="#Create-Glue-Iceberg-Table" class="headerlink" title="Create Glue Iceberg Table"></a>Create Glue Iceberg Table</h2><p>We‚Äôre using <code>Pulumi</code> to manage the AWS Cloud Infrastructure. Before create glue table, a glue database is indeed.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pulumi</span><br><span class="line"><span class="keyword">import</span> pulumi_aws <span class="keyword">as</span> aws</span><br><span class="line"></span><br><span class="line">pulumi_database_test = aws.glue.CatalogDatabase(<span class="string">&quot;pulumi_database_test&quot;</span>,</span><br><span class="line">    create_table_default_permissions=[aws.glue.CatalogDatabaseCreateTableDefaultPermissionArgs(</span><br><span class="line">        permissions=[<span class="string">&quot;ALL&quot;</span>],</span><br><span class="line">        principal=aws.glue.CatalogDatabaseCreateTableDefaultPermissionPrincipalArgs(</span><br><span class="line">            data_lake_principal_identifier=<span class="string">&quot;IAM_ALLOWED_PRINCIPALS&quot;</span>,</span><br><span class="line">        ),</span><br><span class="line">    )],</span><br><span class="line">    name=<span class="string">&quot;pulumi_database_test&quot;</span>)</span><br></pre></td></tr></table></figure><p>Above code is to create a glue database named pulumi_database_test. Next Step is to create a glue table with <code>Iceberg</code> format.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pulumi</span><br><span class="line"><span class="keyword">import</span> pulumi_aws <span class="keyword">as</span> aws</span><br><span class="line"></span><br><span class="line">pulumi_external_table_test = aws.glue.CatalogTable(<span class="string">&quot;pulumi_external_table_test&quot;</span>,</span><br><span class="line">    database_name=<span class="string">&quot;pulumi_database_test&quot;</span>,</span><br><span class="line">    name=<span class="string">&quot;pulumi_external_table_test&quot;</span>,</span><br><span class="line">    storage_descriptor=aws.glue.CatalogTableStorageDescriptorArgs(</span><br><span class="line">        additional_locations=[<span class="string">&quot;s3://xxx/pulumi_external_table_test/data&quot;</span>],</span><br><span class="line">        columns=[</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test1&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test2&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test3&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;boolean&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test4&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">        ],</span><br><span class="line">        location=<span class="string">&quot;s3://xxx/pulumi_external_table_test&quot;</span>,</span><br><span class="line">    ),</span><br><span class="line">    table_type=<span class="string">&quot;EXTERNAL_TABLE&quot;</span>,</span><br><span class="line">        open_table_format_input=aws.glue.CatalogTableOpenTableFormatInputArgs(</span><br><span class="line">        iceberg_input=aws.glue.CatalogTableOpenTableFormatInputIcebergInputArgs(</span><br><span class="line">            metadata_operation=<span class="string">&quot;CREATE&quot;</span></span><br><span class="line">        )</span><br><span class="line">    ),</span><br><span class="line">    opts=pulumi.ResourceOptions(protect=<span class="literal">False</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>There is important thing to notice here is that we need to set <code>open_table_format_input</code> with <code>iceberg_input</code> and set <code>metadata_operation</code> as <code>CREATE</code>. This is because we want to create a new Iceberg table with new schema. </p><p>Below is glue iceberg table created screenshot. You can see the 4 fields is added in schema and table format is <code>Apache Iceberg</code>.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-table.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-table.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Glue Table Schema Created by Pulumi"/></div><span class="image-caption">AWS Glue Table Schema Created by Pulumi</span></div><p>Next, let‚Äôs check the important file that is <code>Apache Iceberg</code> metadata file which is located in <code>s3://xxx/pulumi_external_table_test/metadata/</code>.  Download this json file <code>00006-fd122b03-a7aa-42cf-8fec-001535a9fcf5.metadata.json</code> from <code>S3</code>. The 4 fields are defined in metadata json file. That is good. The metadata json is created as well when creating glue table.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-iceberg-metadata.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-iceberg-metadata.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Glue Table Iceberg metadata"/></div><span class="image-caption">AWS Glue Table Iceberg metadata</span></div><h2 id="Insert-new-data-in-Glue-iceberg-table"><a href="#Insert-new-data-in-Glue-iceberg-table" class="headerlink" title="Insert new data in Glue iceberg table"></a>Insert new data in Glue iceberg table</h2><p>Let‚Äôs using <code>AWS Athena</code> to insert a test data in the table.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> pulumi_database_test.pulumi_external_table_test(test1,test2,test3,test4) <span class="keyword">VALUES</span>(<span class="string">&#x27;1a&#x27;</span>, <span class="string">&#x27;2a&#x27;</span>, <span class="literal">true</span>, <span class="string">&#x27;4a&#x27;</span>)</span><br></pre></td></tr></table></figure><p>The data is insert success and we can use <code>SELECT</code> sql to query the data.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-iceberg-table-query.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-iceberg-table-query.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Query inserted data in AWS Glue Iceberg table"/></div><span class="image-caption">Query inserted data in AWS Glue Iceberg table</span></div><p>In Iceberg table, we can <code>insert</code>, <code>update</code>, <code>delete</code> data as well.</p><h2 id="Update-Glue-Iceberg-table-schema"><a href="#Update-Glue-Iceberg-table-schema" class="headerlink" title="Update Glue Iceberg table schema"></a>Update Glue Iceberg table schema</h2><p>Let‚Äôs add a new field <code>test5</code> in the glue iceberg table base on previous code.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pulumi</span><br><span class="line"><span class="keyword">import</span> pulumi_aws <span class="keyword">as</span> aws</span><br><span class="line"></span><br><span class="line">pulumi_external_table_test = aws.glue.CatalogTable(<span class="string">&quot;pulumi_external_table_test&quot;</span>,</span><br><span class="line">    database_name=<span class="string">&quot;pulumi_database_test&quot;</span>,</span><br><span class="line">    name=<span class="string">&quot;pulumi_external_table_test&quot;</span>,</span><br><span class="line">    storage_descriptor=aws.glue.CatalogTableStorageDescriptorArgs(</span><br><span class="line">        additional_locations=[<span class="string">&quot;s3://xxx/pulumi_external_table_test/data&quot;</span>],</span><br><span class="line">        columns=[</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test1&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test2&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test3&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;boolean&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test4&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            aws.glue.CatalogTableStorageDescriptorColumnArgs(</span><br><span class="line">                name=<span class="string">&quot;test5&quot;</span>,</span><br><span class="line">                <span class="built_in">type</span>=<span class="string">&quot;string&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">        ],</span><br><span class="line">        location=<span class="string">&quot;s3://xxx/pulumi_external_table_test&quot;</span>,</span><br><span class="line">    ),</span><br><span class="line">    table_type=<span class="string">&quot;EXTERNAL_TABLE&quot;</span>,</span><br><span class="line">        open_table_format_input=aws.glue.CatalogTableOpenTableFormatInputArgs(</span><br><span class="line">        iceberg_input=aws.glue.CatalogTableOpenTableFormatInputIcebergInputArgs(</span><br><span class="line">            metadata_operation=<span class="string">&quot;CREATE&quot;</span></span><br><span class="line">        )</span><br><span class="line">    ),</span><br><span class="line">    opts=pulumi.ResourceOptions(protect=<span class="literal">False</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>Execute <code>pulumi up</code> command to update the glue table schema.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-iceberg-update-by-pulumi.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-iceberg-update-by-pulumi.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Pulumi update AWS Glue Iceberg table schema"/></div><span class="image-caption">Pulumi update AWS Glue Iceberg table schema</span></div><p>After that, we can check the glue table schema is updated to add a new field <code>test5</code>.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-iceberg-table-new-field.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-iceberg-table-new-field.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Glue iceberg table new field"/></div><span class="image-caption">AWS Glue iceberg table new field</span></div><p>Let‚Äôs insert new data in the table with new field <code>test5</code> and run it in <code>AWS Athena</code>.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> pulumi_database_test.pulumi_external_table_test(test1,test2,test3,test4,test5) <span class="keyword">VALUES</span>(<span class="string">&#x27;1b&#x27;</span>, <span class="string">&#x27;2b&#x27;</span>, <span class="literal">true</span>, <span class="string">&#x27;4b&#x27;</span>, <span class="string">&#x27;5b&#x27;</span>)</span><br></pre></td></tr></table></figure><p>The Athena execute show below errors:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">COLUMN_NOT_FOUND: Insert column name does not exist in target table: test5. If a data manifest file was generated at &#x27;s3://xxxxxx/4c346103-60d2-45ea-9813-d7060bd5efe9/Unsaved/2024/10/09/37f67a67-4604-43cb-b113-af351c363a51-manifest.csv&#x27;, you may need to manually clean the data from locations specified in the manifest. Athena will not delete data in your account.</span><br><span class="line">This query ran against the &quot;pulumi_database_test&quot; database, unless qualified by the query. Please post the error message on our forum  or contact customer support  with Query Id: 37f67a67-4604-43cb-b113-af351c363a51</span><br></pre></td></tr></table></figure><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-iceberg-athena-insert-failed.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-iceberg-athena-insert-failed.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Athena insert glue iceberg table failed"/></div><span class="image-caption">AWS Athena insert glue iceberg table failed</span></div><p>But when we check the <code>Apache Iceberg</code> metadata file again. The new field <code>test5</code> is not added in the new metadata file. That‚Äôs why the insert new data with new field failed.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-iceberg-metadata-not-updated.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-iceberg-metadata-not-updated.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Glue iceberg table metadata not updated"/></div><span class="image-caption">AWS Glue iceberg table metadata not updated</span></div><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>In Pulumi documentation. The <code>metadata_operation</code> of <code>iceberg_input</code> in <code>open_table_format_input</code> is only support <code>CREATE</code> value. It seems it only can create the iceberg metadata file when glue table created.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-glue-iceberg-pulumi-doc.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-glue-iceberg-pulumi-doc.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Pulumi API Doc"/></div><span class="image-caption">Pulumi API Doc</span></div><p>It seems this is <code>pulumi</code> issue. It is not updating the iceberg metadata file when the glue table schema is updated. I‚Äôve raised a issue to pulumi,  here is issue link: <a href="https://github.com/pulumi/pulumi/issues/17516">https://github.com/pulumi/pulumi/issues/17516</a>. Hope this issue can be fixed soon.</p><p>Mean while, I found there is same issue in <code>Terraform</code> which also can not update the iceberg metadata file when the glue table schema is updated. Terraform issue link here <a href="https://github.com/hashicorp/terraform-provider-aws/issues/36641">https://github.com/hashicorp/terraform-provider-aws/issues/36641</a>.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Context&quot;&gt;&lt;a href=&quot;#Context&quot; class=&quot;headerlink&quot; title=&quot;Context&quot;&gt;&lt;/a&gt;Context&lt;/h2&gt;&lt;p&gt;Recently, we‚Äôre planing to use &lt;code&gt;Pulumi&lt;/code&gt;</summary>
      
    
    
    
    <category term="Cloud" scheme="https://stonefishy.github.io/categories/Cloud/"/>
    
    
    <category term="Python" scheme="https://stonefishy.github.io/tags/Python/"/>
    
    <category term="Pulumi" scheme="https://stonefishy.github.io/tags/Pulumi/"/>
    
    <category term="Cloud" scheme="https://stonefishy.github.io/tags/Cloud/"/>
    
    <category term="AWS" scheme="https://stonefishy.github.io/tags/AWS/"/>
    
    <category term="IaC" scheme="https://stonefishy.github.io/tags/IaC/"/>
    
  </entry>
  
  <entry>
    <title>User Survey Feedback Sentiment Analysis Base on AWS Cloud Solution</title>
    <link href="https://stonefishy.github.io/2024/09/19/user-survey-feedback-sentiment-analysis-base-on-aws-cloud-solution/"/>
    <id>https://stonefishy.github.io/2024/09/19/user-survey-feedback-sentiment-analysis-base-on-aws-cloud-solution/</id>
    <published>2024-09-19T14:00:33.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>The App Product User Survey Feedback Sentiment Analysis Solution is a cloud-based solution that uses AWS services to analyze user feedback and sentiment of the app product. The solution uses Amazon Comprehend to perform sentiment analysis on the feedback and Amazon S3 to store the data. The solution is designed to be scalable and cost-effective, and can be easily integrated into any app product.</p><p>Basically, our survey feedback file is Excel file that contains the user feedback of app and related application info such as OS verion and app version. The feedback text is different language from global users, so we need to translate the text into English using Amazon Translate.  Besides, the feedback file is generated monthly. So, the solution will extract the feedback data from the Excel file, translate the text into English using Amazon Translate, perform sentiment analysis using Amazon Comprehend, and store the data in Amazon S3. The solution will also provide a dashboard to visualize the sentiment analysis results.</p><p>The <code>Amazon Comprehend</code> is a natural language processing (NLP) service that can analyze text and extract insights such as sentiment, syntax, entities, and key phrases. </p><h2 id="Solution-Architecture"><a href="#Solution-Architecture" class="headerlink" title="Solution Architecture"></a>Solution Architecture</h2><p>Below is the high-level architecture of the solution:</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-sentiment-analysis-solution.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-sentiment-analysis-solution.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Sentiment Analysis Solution"/></div><span class="image-caption">AWS Sentiment Analysis Solution</span></div><h3 id="AWS-Services-Used"><a href="#AWS-Services-Used" class="headerlink" title="AWS Services Used"></a>AWS Services Used</h3><p>The solution uses the following AWS services:<br><code>AWS S3</code>: Amazon Simple Storage Service (S3) is a scalable object storage service that can store large amounts of data.<br><code>AWS Lambda</code>: AWS Lambda is a serverless compute service that can run code without provisioning or managing servers.<br><code>AWS Comprehend</code>: Amazon Comprehend is a natural language processing (NLP) service that can analyze text and extract insights such as sentiment, syntax, entities, and key phrases.<br><code>AWS SNS</code>: Amazon Simple Notification Service (SNS) is a messaging service that can be used to send notifications to users.<br><code>AWS Translate</code>: Amazon Translate is a machine translation service that can translate text from one language to another.<br><code>AWS SQS</code>: Amazon Simple Queue Service (SQS) is a messaging service that can be used to store and process large amounts of messages.<br><code>AWS CloudWatch</code>: Amazon CloudWatch is a monitoring service that can be used to monitor the solution and generate metrics.<br><code>AWS Glue</code>: Amazon Glue is a serverless ETL (extract, transform, and load) service that can be used to extract data from the survey feedback file and store it in Amazon S3.<br><code>AWS Athena</code>: Amazon Athena is a serverless data analytics service that can be used to query and analyze data stored in Amazon S3.<br><code>AWS QuickSight</code>: Amazon QuickSight is a business intelligence (BI) service that can be used to create visualizations and dashboards based on the sentiment analysis results.</p><h3 id="Solution-Implementation"><a href="#Solution-Implementation" class="headerlink" title="Solution Implementation"></a>Solution Implementation</h3><p>The solution implementation is divided into the following steps:</p><ol><li>Create an Amazon S3 bucket as raw data bucket to store the survey feedback Excel file.</li><li>Uploaded a survey feedback Excel file to the S3 bucket to trigger the AWS Lambda function.</li><li>AWS Lambda to extract the survey feedback data from the Excel file, translate the text into English using Amazon Translate, sentiment analysis using Amazon Comprehend, and store the data as Parquet format in another Amazon S3 Bucket.</li><li>Create an Amazon SNS topic to notify users by email when the Lambda process data failed.</li><li>Create an Amazon CloudWatch to log the lamdba exeuction logs, generate metrics.</li><li>AWS Glue Crawler to extract the parquet data from the processed amazon S3 bucket and generate a table schema.</li><li>Using Amazon Athena to query the data from the processed Amazon S3 bucket.</li><li>Create an Amazon QuickSight dashboard to visualize the sentiment analysis results.</li></ol><p>The AWS Lambda core function code is as follows:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> pyarrow <span class="keyword">as</span> pa</span><br><span class="line"><span class="keyword">import</span> pyarrow.parquet <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> urllib.parse <span class="keyword">as</span> urlparse</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">S3_TARGET_BUCKET = os.environ[<span class="string">&#x27;QE_SURVEY_PROCESSED_TARGET_BUCKET&#x27;</span>]</span><br><span class="line">SNS_TOPIC_ARN = os.environ[<span class="string">&#x27;SNS_TOPIC_ARN&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">translate_feedbacks</span>(<span class="params">feedbacks</span>):</span><br><span class="line">    translate = boto3.client(<span class="string">&#x27;translate&#x27;</span>)</span><br><span class="line">    feedbacks_en = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;calling AWS Translate to auto detect language and translate feedback, total <span class="subst">&#123;feedbacks.__len__()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> feedback <span class="keyword">in</span> feedbacks:</span><br><span class="line">        response = translate.translate_text(</span><br><span class="line">            Text=feedback,</span><br><span class="line">            SourceLanguageCode=<span class="string">&#x27;auto&#x27;</span>,  <span class="comment"># Detect source language automatically</span></span><br><span class="line">            TargetLanguageCode=<span class="string">&#x27;en&#x27;</span></span><br><span class="line">        )</span><br><span class="line">        feedbacks_en.append(response[<span class="string">&#x27;TranslatedText&#x27;</span>])</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Finished transalate sourceText: <span class="subst">&#123;feedback&#125;</span> to targetText: <span class="subst">&#123;response[<span class="string">&#x27;TranslatedText&#x27;</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> feedbacks_en</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">comprehend_sentiment</span>(<span class="params">feedbacks</span>):</span><br><span class="line">    comprehend = boto3.client(<span class="string">&#x27;comprehend&#x27;</span>)</span><br><span class="line">    batch_size = <span class="number">25</span></span><br><span class="line">    all_sentiments = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;calling AWS Comprehend AI to analysis feedback, total <span class="subst">&#123;feedbacks.__len__()&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(feedbacks), batch_size):</span><br><span class="line">        batch_feedbacks = feedbacks[i:i+batch_size]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;calling AWS Comprehend AI to analysis feedback, batch <span class="subst">&#123;i&#125;</span> - <span class="subst">&#123;i+batch_size&#125;</span>&quot;</span>)</span><br><span class="line">        comprehend_response = comprehend.batch_detect_sentiment(TextList=batch_feedbacks, LanguageCode=<span class="string">&#x27;en&#x27;</span>)</span><br><span class="line">        sentiments = [response[<span class="string">&#x27;Sentiment&#x27;</span>] <span class="keyword">for</span> response <span class="keyword">in</span> comprehend_response[<span class="string">&#x27;ResultList&#x27;</span>]]</span><br><span class="line">        all_sentiments.extend(sentiments)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> all_sentiments</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line">    sns_client = boto3.client(<span class="string">&#x27;sns&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    source_bucket = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    source_key = urlparse.unquote_plus(event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    target_bucket = S3_TARGET_BUCKET</span><br><span class="line">    target_key = <span class="string">f&quot;qe-survey/<span class="subst">&#123;source_key.replace(<span class="string">&#x27;.xlsx&#x27;</span>, <span class="string">&#x27;.parquet&#x27;</span>)&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = s3.get_object(Bucket=source_bucket, Key=source_key)</span><br><span class="line">        excel_file = response[<span class="string">&#x27;Body&#x27;</span>].read()</span><br><span class="line">        </span><br><span class="line">        columns = [<span class="string">&#x27;ce_timestamp&#x27;</span>, <span class="string">&#x27;ce_host_id&#x27;</span>, <span class="string">&#x27;ce_host_os&#x27;</span>, <span class="string">&#x27;ce_hw&#x27;</span>, <span class="string">&#x27;ce_fw&#x27;</span>, <span class="string">&#x27;ce_sw&#x27;</span>, <span class="string">&#x27;survey_feedback&#x27;</span>, <span class="string">&#x27;survey_rating&#x27;</span>]</span><br><span class="line">        df = pd.read_excel(io.BytesIO(excel_file), usecols=columns)</span><br><span class="line">        df[<span class="string">&#x27;ce_timestamp&#x27;</span>] = pd.to_datetime(df[<span class="string">&#x27;ce_timestamp&#x27;</span>], <span class="built_in">format</span>=<span class="string">&#x27;%Y-%m-%d %H:%M:%S:%f&#x27;</span>)</span><br><span class="line">        df[<span class="string">&#x27;survey_feedback&#x27;</span>] = df[<span class="string">&#x27;survey_feedback&#x27;</span>].astype(<span class="built_in">str</span>)</span><br><span class="line">        valid_df = df[df[<span class="string">&#x27;survey_feedback&#x27;</span>].apply(<span class="keyword">lambda</span> x: x.strip() != <span class="string">&#x27;&#x27;</span>)]</span><br><span class="line">        valid_df = valid_df[valid_df[<span class="string">&#x27;survey_feedback&#x27;</span>] != <span class="string">&#x27;nan&#x27;</span>]</span><br><span class="line">        </span><br><span class="line">        feedbacks = valid_df[<span class="string">&#x27;survey_feedback&#x27;</span>].tolist()</span><br><span class="line">        </span><br><span class="line">        feedbacks_en = translate_feedbacks(feedbacks)</span><br><span class="line">        valid_df[<span class="string">&quot;survey_feedback_en&quot;</span>]= feedbacks_en</span><br><span class="line">        valid_df[<span class="string">&#x27;sentiment&#x27;</span>] = comprehend_sentiment(feedbacks_en)</span><br><span class="line">        </span><br><span class="line">        parquet_buffer = io.BytesIO()</span><br><span class="line">        pq.write_table(pa.Table.from_pandas(valid_df), parquet_buffer)</span><br><span class="line">        parquet_buffer.seek(<span class="number">0</span>)</span><br><span class="line">        </span><br><span class="line">        s3.put_object(Bucket=target_bucket, Key=target_key, Body=parquet_buffer)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;source_key&#125;</span> File converted to Parquet <span class="subst">&#123;target_key&#125;</span> and stored in S3 bucket <span class="subst">&#123;target_bucket&#125;</span> successfully&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;statusCode&#x27;</span>: <span class="number">200</span>,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span>: json.dumps(<span class="string">f&#x27;<span class="subst">&#123;source_key&#125;</span> File converted to Parquet <span class="subst">&#123;target_key&#125;</span> and stored in S3 bucket <span class="subst">&#123;target_bucket&#125;</span> successfully&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Error processing <span class="subst">&#123;source_key&#125;</span>: <span class="subst">&#123;e&#125;</span>&#x27;</span>)</span><br><span class="line">        sns_client.publish(</span><br><span class="line">            TopicArn=SNS_TOPIC_ARN,</span><br><span class="line">            Subject=<span class="string">&#x27;Lambda Function Processing QE Survey Feedback Failure Notification&#x27;</span>,</span><br><span class="line">            Message=<span class="string">f&#x27;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&#x27;</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure><p>The above code extracts the survey feedback data from the Excel file, translates the text into English using Amazon Translate, performs sentiment analysis using Amazon Comprehend, and stores the data as Parquet format in another Amazon S3 Bucket. also notify users by email when the Lambda process data failed by using Amazon SNS. </p><p>Below is sentiment analysis results visualization using Amazon QuickSight:</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/aws/aws-sentiment-analysis-result.png" class="lazyload placeholder" data-srcset="/assets/images/aws/aws-sentiment-analysis-result.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="AWS Sentiment Analysis Results"/></div><span class="image-caption">AWS Sentiment Analysis Results</span></div><p>This is a high-level overview of the solution implementation. The solution can be further customized and enhanced based on the specific requirements of the app product.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Introduction&quot;&gt;&lt;a href=&quot;#Introduction&quot; class=&quot;headerlink&quot; title=&quot;Introduction&quot;&gt;&lt;/a&gt;Introduction&lt;/h2&gt;&lt;p&gt;The App Product User Survey Fe</summary>
      
    
    
    
    <category term="Cloud" scheme="https://stonefishy.github.io/categories/Cloud/"/>
    
    
    <category term="Python" scheme="https://stonefishy.github.io/tags/Python/"/>
    
    <category term="AWS" scheme="https://stonefishy.github.io/tags/AWS/"/>
    
    <category term="Machine Learning" scheme="https://stonefishy.github.io/tags/Machine-Learning/"/>
    
    <category term="Sentiment Analysis" scheme="https://stonefishy.github.io/tags/Sentiment-Analysis/"/>
    
  </entry>
  
  <entry>
    <title>How to Fix AWS S3 Event Replacing Space With &#39;+&#39; Character Sign in Object Key Name</title>
    <link href="https://stonefishy.github.io/2024/09/10/aws-s3-event-replacing-space-with-character-sign-in-object-key-name/"/>
    <id>https://stonefishy.github.io/2024/09/10/aws-s3-event-replacing-space-with-character-sign-in-object-key-name/</id>
    <published>2024-09-10T09:22:34.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>The issue with AWS S3 Event notifications is that it replaces spaces with ‚Äò+‚Äô character sign in the object key name. This can cause issues when trying to access the object in S3. It will occurs <code>NoSuchKey</code> error if not handling this issue properly.</p><h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>Configured a S3 bucket put event notification to a Lambda function. The Lambda function will be triggered when a new object is uploaded to the S3 bucket. I upload a file named ‚Äò2023 2nd quarter QE survey raw data.xlsx‚Äô into S3 bucket, the Lambda function is triggered, but when I try to access the object in S3, I get <code>NoSuchKey</code> error in <code>AWS CloudWatch Logs</code>. Debugging shows that the object key name is ‚Äò2023+2nd+quarter+QE+survey+raw+data.xlsx‚Äô instead of ‚Äò2023 2nd quarter QE survey raw data.xlsx‚Äô. It means the S3 event notification is replacing the space with ‚Äò+‚Äô character sign in the object key name.</p><p>The detail error is below:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] NoSuchKey: An error occurred (NoSuchKey) when calling the GetObject operation: The specified key does not exist.</span><br></pre></td></tr></table></figure><h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>There are two solutions to fix this issue, one is from AWS S3 upload file side, another is from Lambda function side.</p><h3 id="1-From-AWS-S3-upload-file-side"><a href="#1-From-AWS-S3-upload-file-side" class="headerlink" title="1. From AWS S3 upload file side:"></a>1. From AWS S3 upload file side:</h3><p>If you have control over the upload process, ensure that the keys are properly URL-encoded.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">s3_client = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example key with spaces</span></span><br><span class="line">object_key = <span class="string">&quot;2023 2nd quarter QE survey raw data.xlsx&quot;</span></span><br><span class="line">encoded_key = urllib.parse.quote(object_key)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Upload the object</span></span><br><span class="line">s3_client.upload_file(<span class="string">&quot;/tmp/2023 2nd quarter QE survey raw data.xlsx&quot;</span>, <span class="string">&quot;my-bucket-name&quot;</span>, encoded_key)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>This will ensure that the object key name is properly URL-encoded, which will prevent the S3 event notification from replacing spaces with ‚Äò+‚Äô character sign. The <code>urllib.parse.quote</code> function will replace spaces with ‚Äò%20‚Äô and ‚Äò+‚Äô with ‚Äò%2B‚Äô.</p><h3 id="2-From-Lambda-function-side"><a href="#2-From-Lambda-function-side" class="headerlink" title="2. From Lambda function side:"></a>2. From Lambda function side:</h3><p>To fix this issue, we need to modify the Lambda function to handle the object key name with ‚Äò+‚Äô character sign. We can use the <code>urllib.parse</code> package to handle it. The package library provide the function <code>unquote_plus</code> to replace ‚Äò+‚Äô with space. Here is the code to handle the object key name with ‚Äò+‚Äô character sign:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib.parse <span class="keyword">as</span> urlparse</span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"></span><br><span class="line">s3 = boto3.client(<span class="string">&#x27;s3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lambda_handler</span>(<span class="params">event, context</span>):</span><br><span class="line">    bucket_name = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;bucket&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    object_key = event[<span class="string">&#x27;Records&#x27;</span>][<span class="number">0</span>][<span class="string">&#x27;s3&#x27;</span>][<span class="string">&#x27;object&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">    <span class="comment"># Replace &#x27;+&#x27; with space</span></span><br><span class="line">    object_key = urlparse.unquote_plus(object_key)</span><br><span class="line">    <span class="comment"># Download the object</span></span><br><span class="line">    s3.download_file(bucket_name, object_key, <span class="string">&#x27;/tmp/file.txt&#x27;</span>)</span><br><span class="line">    <span class="comment"># Do something with the downloaded file</span></span><br><span class="line">    <span class="comment">#...</span></span><br></pre></td></tr></table></figure><p>In the above code, we first get the bucket name and object key from the S3 event notification. We then use the <code>urlparse.unquote_plus</code> function to replace ‚Äò+‚Äô with space in the object key name. Finally, we download the object using the <code>s3.download_file</code> function.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>To fix the issue with AWS S3 Event notifications replacing space with ‚Äò+‚Äô character sign in the object key name, we need to handle it properly in the Lambda function. We can use the <code>urllib.parse</code> package to handle it.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;The issue with AWS S3 Event notifications is that it replaces spaces with ‚Äò+‚Äô character sign in the object key name. This can cause issue</summary>
      
    
    
    
    <category term="Cloud" scheme="https://stonefishy.github.io/categories/Cloud/"/>
    
    
    <category term="Python" scheme="https://stonefishy.github.io/tags/Python/"/>
    
    <category term="Cloud" scheme="https://stonefishy.github.io/tags/Cloud/"/>
    
    <category term="AWS" scheme="https://stonefishy.github.io/tags/AWS/"/>
    
    <category term="AWS S3" scheme="https://stonefishy.github.io/tags/AWS-S3/"/>
    
    <category term="AWS Lambda" scheme="https://stonefishy.github.io/tags/AWS-Lambda/"/>
    
  </entry>
  
  <entry>
    <title>SQL ‰∏≠ÁöÑ IS DISTINCT FROM ËØ≠Ê≥ïËØ¶Ëß£</title>
    <link href="https://stonefishy.github.io/2024/08/16/introduce-is-distinct-from-in-sql/"/>
    <id>https://stonefishy.github.io/2024/08/16/introduce-is-distinct-from-in-sql/</id>
    <published>2024-08-16T09:22:15.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>Âú®SQLÊü•ËØ¢‰∏≠ÔºåÊØîËæÉÊìç‰ΩúÁ¨¶ <code>=</code> ÈÄöÂ∏∏Áî®‰∫éÊ£ÄÊü•‰∏§‰∏™ÂÄºÊòØÂê¶Áõ∏Á≠â„ÄÇÁÑ∂ËÄåÔºåÂΩìÊ∂âÂèäÂà∞Â§ÑÁêÜÁº∫Â§±ÂÄºÔºà<code>NULL</code>ÔºâÊó∂ÔºåËøôÁßçÊìç‰ΩúÁ¨¶Â∞±‰ºöÈù¢‰∏¥ÊåëÊàò„ÄÇ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢òÔºå<span class='pbg green'>SQL Êèê‰æõ‰∫Ü `IS DISTINCT FROM` Êìç‰ΩúÁ¨¶ÔºåÂÆÉÁî®‰∫éÁ≤æÁ°ÆÊØîËæÉ‰∏§‰∏™ÂÄºÊòØÂê¶‰∏çÂêåÔºåÂç≥‰ΩøËøô‰∫õÂÄº‰∏≠Êúâ NULL</span>„ÄÇÊú¨ÊñáÂ∞ÜËØ¶ÁªÜ‰ªãÁªç IS DISTINCT FROM ÁöÑËØ≠Ê≥ï„ÄÅËß£ÂÜ≥ÁöÑÈóÆÈ¢ò‰ª•ÂèäÂ∏∏ËßÅÁöÑ‰ΩøÁî®Âú∫ÊôØ„ÄÇ</p><h2 id="ËØ≠Ê≥ï"><a href="#ËØ≠Ê≥ï" class="headerlink" title="ËØ≠Ê≥ï"></a>ËØ≠Ê≥ï</h2><p>IS DISTINCT FROM ÁöÑÂü∫Êú¨ËØ≠Ê≥ïÂ¶Ç‰∏ãÔºö</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expression1 <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> expression2</span><br></pre></td></tr></table></figure><p>ÂÖ∂‰∏≠ expression1 Âíå expression2 ÊòØË¶ÅËøõË°åÊØîËæÉÁöÑ‰∏§‰∏™Ë°®ËææÂºè„ÄÇ ËØ•Êìç‰ΩúÁ¨¶ËøîÂõûÂ∏ÉÂ∞îÂÄºÔºöTRUE„ÄÅFALSE„ÄÇ</p><h2 id="‰∏ªË¶ÅËß£ÂÜ≥ÁöÑÈóÆÈ¢ò"><a href="#‰∏ªË¶ÅËß£ÂÜ≥ÁöÑÈóÆÈ¢ò" class="headerlink" title="‰∏ªË¶ÅËß£ÂÜ≥ÁöÑÈóÆÈ¢ò"></a>‰∏ªË¶ÅËß£ÂÜ≥ÁöÑÈóÆÈ¢ò</h2><p>Âú®SQL‰∏≠Ôºå<code>NULL</code> ÂÄº‰ª£Ë°®Áº∫Â§±ÊàñÊú™Áü•ÁöÑÊï∞ÊçÆ„ÄÇÂΩì‰∏§‰∏™Ë°®ËææÂºè‰∏≠Ëá≥Â∞ëÊúâ‰∏Ä‰∏™‰∏∫ NULL Êó∂Ôºå‰ΩøÁî®‰º†ÁªüÁöÑÊØîËæÉÊìç‰ΩúÁ¨¶ÔºàÂ¶Ç &#x3D; Êàñ &lt;&gt;ÔºâËøõË°åÊØîËæÉ‰ºöÂØºËá¥‰∏çÁ°ÆÂÆöÁöÑÁªìÊûú„ÄÇÂÖ∑‰ΩìÊù•ËØ¥Ôºö</p><ul><li>expression1 &#x3D; expression2 Âú® expression1 Êàñ expression2 ‰∏∫ NULL Êó∂‰ºöËøîÂõû UNKNOWN„ÄÇ</li><li>expression1 &lt;&gt; expression2 Âú® expression1 Êàñ expression2 ‰∏∫ NULL Êó∂‰πü‰ºöËøîÂõû UNKNOWN„ÄÇ</li></ul><p>ÊØîÂ¶Ç‰∏ãÈù¢ÁöÑÊü•ËØ¢ËØ≠Âè•Ôºö</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">    <span class="number">1</span> <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">as</span> A1,</span><br><span class="line">    <span class="keyword">NULL</span> <span class="operator">&lt;&gt;</span> <span class="number">1</span> <span class="keyword">as</span> A2,</span><br><span class="line">    <span class="keyword">NULL</span> <span class="operator">=</span> <span class="keyword">NULL</span> <span class="keyword">as</span> A3,</span><br><span class="line">    <span class="keyword">NULL</span> <span class="operator">&lt;&gt;</span> <span class="keyword">NULL</span> <span class="keyword">as</span> A4,</span><br><span class="line">    <span class="number">1</span> <span class="operator">=</span> <span class="number">1</span> <span class="keyword">as</span> A5, </span><br><span class="line">    <span class="number">1</span> <span class="operator">&lt;&gt;</span> <span class="number">1</span> <span class="keyword">as</span> A6</span><br></pre></td></tr></table></figure><p>‰ºöËøîÂõû‰ª•‰∏ãÁªìÊûúÔºö</p><table><thead><tr><th>A1</th><th>A2</th><th>A3</th><th>A4</th><th>A5</th><th>A6</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td>TRUE</td><td>FALSE</td></tr></tbody></table><p>ÂèØ‰ª•ÁúãÂà∞ÔºåÂΩì expression1 Êàñ expression2 ‰∏∫ NULL Êó∂Ôºå‰º†ÁªüÁöÑÊØîËæÉÊìç‰ΩúÁ¨¶‰ºöËøîÂõû UNKNOWNÁ©∫ÂÄºÔºå Â¶Ç‰∏äÈù¢ÁöÑA1, A2, A3, A4ÁöÑÁªìÊûúÂÄºÔºåËøôÂ∞±‰ºöÂØºËá¥‰∏çÁ°ÆÂÆöÊÄß„ÄÇ</p><p><code>IS DISTINCT FROM</code> Êìç‰ΩúÁ¨¶ÁöÑÂá∫Áé∞ÔºåËß£ÂÜ≥‰∫ÜËøô‰∫õÈóÆÈ¢ò„ÄÇÂÆÉËÉΩÊ≠£Á°ÆÂ§ÑÁêÜ <code>NULL</code> ÂÄºÔºå‰ºöËøîÂõû <code>TRUE Êàñ FALSE</code>ÔºåÁ°Æ‰øùÁªìÊûúÁöÑÂèØÈù†ÊÄß„ÄÇ Âú®‰ª•‰∏ãÊÉÖÂÜµ‰∏ãËøîÂõû TRUEÔºö</p><ul><li>expression1 Âíå expression2 ÈÉΩ‰∏∫ NULL„ÄÇ</li><li>expression1 Âíå expression2 ÁöÑÂÄº‰∏çÂêåÔºà‰∏çËÆ∫ÊòØÂê¶‰∏∫ NULLÔºâ„ÄÇ</li></ul><p>ËÄåÂú® expression1 Âíå expression2 Áõ∏Á≠âÔºàÂåÖÊã¨ÈÉΩÊòØ NULLÔºâÁöÑÊÉÖÂÜµ‰∏ãÔºåIS DISTINCT FROM ËøîÂõû FALSE„ÄÇ Âè¶Â§ñËøòÊúâ‰∏Ä‰∏™ <code>IS NOT DISTINCT FROM</code> Êìç‰ΩúÁ¨¶ÔºåÁî®‰∫éÂà§Êñ≠‰∏§‰∏™ÂÄºÊòØÂê¶Áõ∏Á≠â„ÄÇÂÖ∂Áî®Ê≥ï‰∏ÄÊ†∑ÔºåÂè™ÊòØËØ≠‰πâÁõ∏Âèç„ÄÇ</p><p>‰∏ãÈù¢ÁöÑ‰æãÂ≠êÊü•ËØ¢Ôºö</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="number">1</span> <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="keyword">NULL</span> <span class="keyword">as</span> B1,</span><br><span class="line">    <span class="keyword">NULL</span> <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">as</span> B2,</span><br><span class="line">    <span class="number">1</span> <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="number">2</span> <span class="keyword">as</span> B3,</span><br><span class="line">    <span class="keyword">NULL</span> <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="keyword">NULL</span> <span class="keyword">as</span> B4,</span><br><span class="line">    <span class="number">1</span> <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">as</span> B5,</span><br><span class="line">    <span class="number">1</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="number">1</span> <span class="keyword">as</span> B6</span><br></pre></td></tr></table></figure><p>Êü•ËØ¢ÁªìÊûúÂ¶Ç‰∏ã:</p><table><thead><tr><th>B1</th><th>B2</th><th>B3</th><th>B4</th><th>B5</th><th>B6</th></tr></thead><tbody><tr><td>TRUE</td><td>TRUE</td><td>TRUE</td><td>FALSE</td><td>FALSE</td><td>TRUE</td></tr></tbody></table><p>ÂèØ‰ª•ÁúãÂà∞ÔºåIS DISTINCT FROM Ê≠£Á°ÆÂ§ÑÁêÜ NULL ÂÄºÔºåËøîÂõû TRUE Êàñ FALSEÔºåÁ°Æ‰øùÁªìÊûúÁöÑÂèØÈù†ÊÄß„ÄÇ</p><h2 id="‰ΩøÁî®Âú∫ÊôØ"><a href="#‰ΩøÁî®Âú∫ÊôØ" class="headerlink" title="‰ΩøÁî®Âú∫ÊôØ"></a>‰ΩøÁî®Âú∫ÊôØ</h2><h3 id="Êï∞ÊçÆÊ∏ÖÊ¥óÂíåÈ™åËØÅ"><a href="#Êï∞ÊçÆÊ∏ÖÊ¥óÂíåÈ™åËØÅ" class="headerlink" title="Êï∞ÊçÆÊ∏ÖÊ¥óÂíåÈ™åËØÅ"></a>Êï∞ÊçÆÊ∏ÖÊ¥óÂíåÈ™åËØÅ</h3><p>Âú®<code>Êï∞ÊçÆÊ∏ÖÊ¥ó</code>Âíå<code>Êï∞ÊçÆÈ™åËØÅ</code>ËøáÁ®ã‰∏≠ÔºåÁªèÂ∏∏ÈúÄË¶ÅÊ£ÄÊü•Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂÄºÊòØÂê¶‰∏çÂêåÔºåÂåÖÊã¨ÂØπ NULL ÂÄºÁöÑÂ§ÑÁêÜ„ÄÇ‰æãÂ¶ÇÔºåÊØîËæÉÁî®Êà∑ËæìÂÖ•ÁöÑÊï∞ÊçÆ‰∏éÁé∞ÊúâËÆ∞ÂΩïÔºå‰ª•Á°ÆÂÆöÊòØÂê¶Êúâ‰∏çÂêåÁöÑËÆ∞ÂΩï„ÄÇ<span class='pbg warning'>‰ΩøÁî® IS DISTINCT FROM ÂèØ‰ª•Êõ¥ÂáÜÁ°ÆÂú∞Â§ÑÁêÜ NULL ÂÄºÔºåÈÅøÂÖçÂá∫Áé∞ÈîôËØØÊàñÈÅóÊºè„ÄÇ</span></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> users</span><br><span class="line"><span class="keyword">WHERE</span> username <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="string">&#x27;andrewsy&#x27;</span>;</span><br></pre></td></tr></table></figure><p>ËøôÊù°Êü•ËØ¢‰ºöËøîÂõûÊâÄÊúâ username ‰∏é ‚Äòandrewsy‚Äô ‰∏çÂêåÁöÑËÆ∞ÂΩïÔºåÂåÖÊã¨ÈÇ£‰∫õ username ‰∏∫ NULL ÁöÑËÆ∞ÂΩï„ÄÇ</p><h3 id="Êï∞ÊçÆÊõ¥Êñ∞"><a href="#Êï∞ÊçÆÊõ¥Êñ∞" class="headerlink" title="Êï∞ÊçÆÊõ¥Êñ∞"></a>Êï∞ÊçÆÊõ¥Êñ∞</h3><p>Âú®Êõ¥Êñ∞Êï∞ÊçÆÊó∂Ôºå‰ΩøÁî® IS DISTINCT FROM ÂèØ‰ª•Á°Æ‰øùÂè™ÊúâÂú®Êï∞ÊçÆÂÆûÈôÖÂèòÂåñÊó∂ÊâçËøõË°åÊõ¥Êñ∞Ôºå‰ªéËÄåÈÅøÂÖç‰∏çÂøÖË¶ÅÁöÑÊõ¥Êñ∞Êìç‰Ωú„ÄÇ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> users</span><br><span class="line"><span class="keyword">SET</span> email <span class="operator">=</span> <span class="string">&#x27;new_andrewsy@email.com&#x27;</span></span><br><span class="line"><span class="keyword">WHERE</span> email <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> <span class="string">&#x27;new_andrewsy@email.com&#x27;</span>;</span><br></pre></td></tr></table></figure><p>ËøôÊù°Êü•ËØ¢‰ºöÊõ¥Êñ∞ÊâÄÊúâ email ‰∏çÂêå‰∫é ‚Äò<a href="mailto:&#x6e;&#101;&#x77;&#x5f;&#97;&#110;&#x64;&#114;&#101;&#x77;&#x73;&#x79;&#64;&#x65;&#109;&#x61;&#x69;&#x6c;&#x2e;&#99;&#111;&#x6d;">&#x6e;&#101;&#x77;&#x5f;&#97;&#110;&#x64;&#114;&#101;&#x77;&#x73;&#x79;&#64;&#x65;&#109;&#x61;&#x69;&#x6c;&#x2e;&#99;&#111;&#x6d;</a>‚Äò ÁöÑËÆ∞ÂΩïÔºåÂåÖÊã¨ÈÇ£‰∫õ email ‰∏∫ NULL ÁöÑËÆ∞ÂΩï„ÄÇ</p><h3 id="Êï∞ÊçÆÊØîËæÉ"><a href="#Êï∞ÊçÆÊØîËæÉ" class="headerlink" title="Êï∞ÊçÆÊØîËæÉ"></a>Êï∞ÊçÆÊØîËæÉ</h3><p>Âú®ËøõË°åÂ§çÊùÇÁöÑÊï∞ÊçÆÊØîËæÉÊó∂ÔºåÂ∞§ÂÖ∂ÊòØÊ∂âÂèäÂà∞ NULL ÂÄºÊó∂ÔºåIS DISTINCT FROM Êèê‰æõ‰∫ÜÊõ¥Áõ¥ËßÇÁöÑÊØîËæÉÈÄªËæë„ÄÇ‰æãÂ¶ÇÔºåÂú®ÂêàÂπ∂‰∏§‰∏™Êï∞ÊçÆÈõÜÊó∂ÔºåÂèØ‰ª•‰ΩøÁî®Ê≠§Êìç‰ΩúÁ¨¶Êù•Á°Æ‰øùÂîØ‰∏ÄÊÄß„ÄÇ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    dataset1</span><br><span class="line"><span class="keyword">FULL</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> </span><br><span class="line">    dataset2</span><br><span class="line"><span class="keyword">ON</span> </span><br><span class="line">    dataset1.id <span class="keyword">IS</span> <span class="keyword">DISTINCT</span> <span class="keyword">FROM</span> dataset2.id</span><br></pre></td></tr></table></figure><p>ËøôÊù°Êü•ËØ¢‰ºöÊâæÂá∫‰∏§‰∏™Êï∞ÊçÆÈõÜ‰∏≠ id ‰∏çÂêåÁöÑËÆ∞ÂΩïÔºåÂåÖÊã¨ id ‰∏∫ NULL ÁöÑÊÉÖÂÜµ„ÄÇ</p><h2 id="Ê≥®ÊÑè‰∫ãÈ°π"><a href="#Ê≥®ÊÑè‰∫ãÈ°π" class="headerlink" title="Ê≥®ÊÑè‰∫ãÈ°π"></a>Ê≥®ÊÑè‰∫ãÈ°π</h2><p><code>IS DISTINCT FROM</code> ÊòØ SQL Ê†áÂáÜ‰∏≠ÁöÑ‰∏ÄÈÉ®ÂàÜÔºå‰ΩÜÂπ∂ÈùûÊâÄÊúâÊï∞ÊçÆÂ∫ìÁ≥ªÁªüÈÉΩÊîØÊåÅ„ÄÇÂÖ∑‰ΩìÁöÑÊîØÊåÅÊÉÖÂÜµÈúÄË¶ÅÊü•ÈòÖÊï∞ÊçÆÂ∫ìÁöÑÊñáÊ°£„ÄÇÂú®‰ΩøÁî® IS DISTINCT FROM Êó∂ÔºåÁ°Æ‰øùÊï∞ÊçÆÂ∫ìÁ≥ªÁªüÁöÑÁâàÊú¨ÂíåÊñáÊ°£‰∏≠ÂØπÊ≠§Êìç‰ΩúÁ¨¶ÁöÑÊîØÊåÅÂèäË°å‰∏∫‰∏ÄËá¥„ÄÇ</p><h2 id="ÊÄªÁªì"><a href="#ÊÄªÁªì" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h2><p><code>IS DISTINCT FROM</code> ÊòØ‰∏Ä‰∏™Âº∫Â§ßÁöÑÂ∑•ÂÖ∑ÔºåÁî®‰∫éÂú® SQL ‰∏≠Â§ÑÁêÜÂåÖÂê´ NULL ÂÄºÁöÑÊï∞ÊçÆÊØîËæÉ„ÄÇÂÆÉËß£ÂÜ≥‰∫Ü‰º†ÁªüÊØîËæÉÊìç‰ΩúÁ¨¶Âú®Â§ÑÁêÜ NULL ÂÄºÊó∂ÁöÑ‰∏çË∂≥Ôºå‰ΩøÂæóÊï∞ÊçÆÈ™åËØÅ„ÄÅÊõ¥Êñ∞ÂíåÊØîËæÉÊõ¥Âä†ÂáÜÁ°ÆÂíåÂèØÈù†„ÄÇÂú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåÊ†πÊçÆÊï∞ÊçÆÂ∫ìÁ≥ªÁªüÁöÑÊîØÊåÅÊÉÖÂÜµÔºåÂêàÁêÜ‰ΩøÁî® IS DISTINCT FROM ÂèØ‰ª•ÊòæËëóÊèêÈ´òÊï∞ÊçÆÊìç‰ΩúÁöÑÁ≤æÁ°ÆÊÄßÂíåÂÅ•Â£ÆÊÄß„ÄÇ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Âú®SQLÊü•ËØ¢‰∏≠ÔºåÊØîËæÉÊìç‰ΩúÁ¨¶ &lt;code&gt;=&lt;/code&gt; ÈÄöÂ∏∏Áî®‰∫éÊ£ÄÊü•‰∏§‰∏™ÂÄºÊòØÂê¶Áõ∏Á≠â„ÄÇÁÑ∂ËÄåÔºåÂΩìÊ∂âÂèäÂà∞Â§ÑÁêÜÁº∫Â§±ÂÄºÔºà&lt;code&gt;NULL&lt;/code&gt;ÔºâÊó∂ÔºåËøôÁßçÊìç‰ΩúÁ¨¶Â∞±‰ºöÈù¢‰∏¥ÊåëÊàò„ÄÇ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏ÄÈóÆÈ¢òÔºå&lt;span class=&#39;pbg green&#39;&gt;SQL Êèê‰æõ‰∫Ü `IS DIST</summary>
      
    
    
    
    <category term="Database" scheme="https://stonefishy.github.io/categories/Database/"/>
    
    
    <category term="Big Data" scheme="https://stonefishy.github.io/tags/Big-Data/"/>
    
    <category term="MySQL" scheme="https://stonefishy.github.io/tags/MySQL/"/>
    
    <category term="SQL" scheme="https://stonefishy.github.io/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>ËØ¶Ëß£ SQL ‰∏≠ÁöÑ LAG ÂáΩÊï∞</title>
    <link href="https://stonefishy.github.io/2024/08/15/what-is-lag-in-sql/"/>
    <id>https://stonefishy.github.io/2024/08/15/what-is-lag-in-sql/</id>
    <published>2024-08-15T09:24:21.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>ÊúÄËøëÂú®ÂÅöÊï∞ÊçÆÂàÜÊûêÔºåÈúÄË¶ÅÊåñÊéòÊï∞ÊçÆÈöèÊó∂Èó¥ÂèòÂåñÁöÑ‰ø°ÊÅØ„ÄÇÊâÄÊúâÊï∞ÊçÆÁâ©ÁêÜÂ≠òÂÇ®Âú®AWS S3‰∏äÔºåÈÄöËøáAWS Glue CatalogÂíåAWS AthenaËøõË°åÊï∞ÊçÆÊü•ËØ¢„ÄÇAWS AthenaÊîØÊåÅSQLËØ≠Ë®ÄÔºåÂèØ‰ª•ÂØπÊï∞ÊçÆËøõË°åÂàÜÊûê„ÄÇÂú®Â§ÑÁêÜÊó∂Èó¥Â∫èÂàóÊï∞ÊçÆÊàñÂàÜÊûêË°åÈó¥ÂèòÂåñÊó∂Ôºå SQL‰∏≠ÁöÑ <code>LAG</code> ÂáΩÊï∞Âíå <code>LEAD</code> ÂáΩÊï∞ÊòØÈùûÂ∏∏ÊúâÁî®ÁöÑ„ÄÇ‰∏ãÈù¢ÔºåÊàë‰ª¨Êù•Áúã‰∏Ä‰∏ã LAG ÂáΩÊï∞ÁöÑÂü∫Êú¨Áî®Ê≥ï„ÄÇ</p><h2 id="‰ªÄ‰πàÊòØ-LAG-ÂáΩÊï∞Ôºü"><a href="#‰ªÄ‰πàÊòØ-LAG-ÂáΩÊï∞Ôºü" class="headerlink" title="‰ªÄ‰πàÊòØ LAG ÂáΩÊï∞Ôºü"></a>‰ªÄ‰πàÊòØ LAG ÂáΩÊï∞Ôºü</h2><p>Âú® SQL ‰∏≠Ôºå<code>LAG</code> ÂáΩÊï∞ÊòØ‰∏ÄÁßç<code>Á™óÂè£ÂáΩÊï∞</code>Ôºå<span class='pbg warning'>Áî®‰∫éËé∑ÂèñÂΩìÂâçË°å‰πãÂâçÊüê‰∏ÄË°åÁöÑÂÄº„ÄÇËøôÂú®Â§ÑÁêÜÊó∂Èó¥Â∫èÂàóÊï∞ÊçÆÊàñÂàÜÊûêË°åÈó¥ÂèòÂåñÊó∂ÈùûÂ∏∏ÊúâÁî®„ÄÇLAG ÂáΩÊï∞ÂèØ‰ª•ËÆ©‰Ω†ËÆøÈóÆÂΩìÂâçË°å‰πãÂâçÁöÑË°åÊï∞ÊçÆÔºåËÄå‰∏çÈúÄË¶Å‰ΩøÁî®Â≠êÊü•ËØ¢ÊàñËá™ËøûÊé•„ÄÇ</span> ËÄå<code>LEAD</code> ÂáΩÊï∞ÂàôÊòØËé∑ÂèñÂΩìÂâçË°å‰πãÂêéÁöÑË°åÊï∞ÊçÆ„ÄÇ‰ªñ‰ª¨ÁöÑËØ≠Ê≥ïÂíåÁî®Ê≥ïÁ±ª‰ººÔºåÂè™ÊòØÊñπÂêë‰∏çÂêå„ÄÇ</p><h2 id="LAG-ÂáΩÊï∞ÁöÑËØ≠Ê≥ï"><a href="#LAG-ÂáΩÊï∞ÁöÑËØ≠Ê≥ï" class="headerlink" title="LAG ÂáΩÊï∞ÁöÑËØ≠Ê≥ï"></a>LAG ÂáΩÊï∞ÁöÑËØ≠Ê≥ï</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LAG</span>(expression, <span class="keyword">offset</span>, <span class="keyword">default</span>) <span class="keyword">OVER</span> (<span class="keyword">PARTITION</span> <span class="keyword">BY</span> partition_column <span class="keyword">ORDER</span> <span class="keyword">BY</span> order_column)</span><br></pre></td></tr></table></figure><ul><li><code>expression</code>ÔºöË¶ÅËøîÂõûÁöÑÂàóÊàñËÆ°ÁÆóÁªìÊûú„ÄÇ</li><li><code>offset</code>ÔºöÂêëÂâçÊü•ÊâæÁöÑË°åÊï∞ÔºåÈªòËÆ§‰∏∫ 1ÔºàÂç≥Ââç‰∏ÄË°åÔºâ„ÄÇ</li><li><code>default</code>ÔºöÂΩìÊ≤°ÊúâÂâçË°åÊó∂ËøîÂõûÁöÑÈªòËÆ§ÂÄºÔºåÈªòËÆ§‰∏∫ NULL„ÄÇ</li><li><code>PARTITION BY</code>ÔºöÁî®‰∫éÂ∞ÜÊï∞ÊçÆÂàÜÁªÑ„ÄÇÂ¶ÇÊûúÁúÅÁï•ÔºåLAG ‰ºöÂú®Êï¥‰∏™ÁªìÊûúÈõÜ‰∏äÂ∫îÁî®„ÄÇ</li><li><code>ORDER BY</code>ÔºöÁ°ÆÂÆöË°åÁöÑÈ°∫Â∫èÔºåLAG ÂáΩÊï∞‰ºöÊ†πÊçÆËøô‰∏™È°∫Â∫èÊù•ËÆøÈóÆÂâçÈù¢ÁöÑË°å„ÄÇ</li></ul><h2 id="Â¶Ç‰Ωï‰ΩøÁî®-LAG-ÂáΩÊï∞"><a href="#Â¶Ç‰Ωï‰ΩøÁî®-LAG-ÂáΩÊï∞" class="headerlink" title="Â¶Ç‰Ωï‰ΩøÁî® LAG ÂáΩÊï∞"></a>Â¶Ç‰Ωï‰ΩøÁî® LAG ÂáΩÊï∞</h2><p><code>LAG</code> ÂáΩÊï∞Âú®‰ΩøÁî®Êó∂ÈÄöÂ∏∏‰∏é <code>OVER</code> Â≠êÂè•‰∏ÄËµ∑‰ΩøÁî®„ÄÇOVER Â≠êÂè•Áî®‰∫éÂÆö‰πâÁ™óÂè£ÔºàÂç≥Â∫îÁî® LAG ÂáΩÊï∞ÁöÑËåÉÂõ¥Ôºâ„ÄÇÂú®Á™óÂè£‰∏≠Ôºå<code>ORDER BY</code> Á°ÆÂÆö‰∫ÜË°åÁöÑÈ°∫Â∫èÔºå<code>PARTITION BY</code> ÂàôÂèØ‰ª•Áî®Êù•Â∞ÜÊï∞ÊçÆÂàÜÁªÑÔºå‰ΩøÊØè‰∏™ÂàÜÁªÑÂÜÖÁöÑËÆ°ÁÆó‰∫íÁõ∏Áã¨Á´ã„ÄÇ</p><h3 id="Âü∫Êú¨‰ΩøÁî®Á§∫‰æãÔºö"><a href="#Âü∫Êú¨‰ΩøÁî®Á§∫‰æãÔºö" class="headerlink" title="Âü∫Êú¨‰ΩøÁî®Á§∫‰æãÔºö"></a>Âü∫Êú¨‰ΩøÁî®Á§∫‰æãÔºö</h3><p>ÂÅáËÆæÊàë‰ª¨Êúâ‰∏Ä‰∏™Âêç‰∏∫ sales ÁöÑË°®ÔºåÂåÖÂê´ sale_date Âíå amount Âàó„ÄÇÊàë‰ª¨ÊÉ≥Ë¶ÅÊØîËæÉÊØèÁ¨îÈîÄÂîÆÈáëÈ¢ù‰∏éÂâç‰∏ÄÁ¨îÈîÄÂîÆÈáëÈ¢ùÁöÑÂèòÂåñ„ÄÇ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    sale_date,</span><br><span class="line">    amount,</span><br><span class="line">    <span class="built_in">LAG</span>(amount, <span class="number">1</span>) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> sale_date) <span class="keyword">AS</span> previous_amount</span><br><span class="line"><span class="keyword">FROM</span> sales;</span><br></pre></td></tr></table></figure><p>Âú®Ëøô‰∏™Êü•ËØ¢‰∏≠Ôºö</p><p>amount ÊòØÂΩìÂâçÈîÄÂîÆÈáëÈ¢ù„ÄÇ<br>LAG(amount, 1) Ëé∑ÂèñÂΩìÂâçÈîÄÂîÆÁöÑÂâç‰∏ÄÁ¨îÈîÄÂîÆÈáëÈ¢ùÔºàÊ†πÊçÆ sale_date ÊéíÂ∫èÔºâ„ÄÇ</p><h2 id="‰ΩøÁî®Âú∫ÊôØ"><a href="#‰ΩøÁî®Âú∫ÊôØ" class="headerlink" title="‰ΩøÁî®Âú∫ÊôØ"></a>‰ΩøÁî®Âú∫ÊôØ</h2><ol><li><p>Êó∂Èó¥Â∫èÂàóÂàÜÊûêÔºö<br>LAG ÂáΩÊï∞ÈùûÂ∏∏ÈÄÇÂêàÂàÜÊûêÊó∂Èó¥Â∫èÂàóÊï∞ÊçÆÔºåÂ∏ÆÂä©Áî®Êà∑‰∫ÜËß£Êï∞ÊçÆÂèòÂåñË∂ãÂäø„ÄÇ‰æãÂ¶ÇÔºåÂàÜÊûêÊØèÊúàÁöÑÈîÄÂîÆÊï∞ÊçÆÔºåÊâæÂá∫Â¢ûÈïøÊàñ‰∏ãÈôçÁöÑË∂ãÂäø„ÄÇ</p></li><li><p>ËÆ°ÁÆóÂèòÂåñÈáèÔºö<br>ÂèØ‰ª•ËÆ°ÁÆóÂΩìÂâçÂÄº‰∏éÂâç‰∏ÄÂÄº‰πãÈó¥ÁöÑÂèòÂåñÈáèÔºå‰æãÂ¶ÇÈîÄÂîÆÈ¢ùÂèòÂåñ„ÄÅÊ∏©Â∫¶ÂèòÂåñÁ≠â„ÄÇ</p></li><li><p>ÁîüÊàêÊªöÂä®Êä•ÂëäÔºö<br>LAG ÂèØ‰ª•Áî®Êù•ÁîüÊàêÂ∏¶ÊúâÂâçÂÄºÁöÑÊªöÂä®Êä•ÂëäÔºå‰æãÂ¶ÇËÆ°ÁÆóÁ¥ØËÆ°ÈîÄÂîÆÈ¢ùÔºåÊàñËÄÖÁîüÊàêÊªûÂêéÊï∞ÊçÆÁî®‰∫éÊä•Ë°®„ÄÇ</p></li></ol><h2 id="‰∏æ‰∏™‰æãÂ≠ê"><a href="#‰∏æ‰∏™‰æãÂ≠ê" class="headerlink" title="‰∏æ‰∏™‰æãÂ≠ê"></a>‰∏æ‰∏™‰æãÂ≠ê</h2><p>ÂÅáËÆæÊàë‰ª¨Êúâ‰∏Ä‰∏™ÈîÄÂîÆËÆ∞ÂΩïË°® monthly_salesÔºåÁªìÊûÑÂ¶Ç‰∏ãÔºö</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> monthly_sales (</span><br><span class="line">    <span class="keyword">month</span> <span class="type">DATE</span>,</span><br><span class="line">    sales_amount <span class="type">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> monthly_sales (<span class="keyword">month</span>, sales_amount) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="string">&#x27;2024-01-01&#x27;</span>, <span class="number">1000.00</span>),</span><br><span class="line">(<span class="string">&#x27;2024-02-01&#x27;</span>, <span class="number">1500.00</span>),</span><br><span class="line">(<span class="string">&#x27;2024-03-01&#x27;</span>, <span class="number">1200.00</span>),</span><br><span class="line">(<span class="string">&#x27;2024-04-01&#x27;</span>, <span class="number">1700.00</span>);</span><br></pre></td></tr></table></figure><p>Êàë‰ª¨ÂèØ‰ª•‰ΩøÁî® <code>LAG</code> ÂáΩÊï∞Êù•ÊØîËæÉÊØè‰∏™ÊúàÁöÑÈîÄÂîÆÈ¢ù‰∏éÂâç‰∏Ä‰∏™ÊúàÁöÑÈîÄÂîÆÈ¢ùÔºö</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">month</span>,</span><br><span class="line">    sales_amount,</span><br><span class="line">    <span class="built_in">LAG</span>(sales_amount, <span class="number">1</span>) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> previous_month_sales,</span><br><span class="line">    sales_amount <span class="operator">-</span> <span class="built_in">LAG</span>(sales_amount, <span class="number">1</span>) <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">month</span>) <span class="keyword">AS</span> sales_difference</span><br><span class="line"><span class="keyword">FROM</span> monthly_sales;</span><br></pre></td></tr></table></figure><p>Êü•ËØ¢ÁªìÊûúÔºö</p><table><thead><tr><th>month</th><th>sales_amount</th><th>previous_month_sales</th><th>sales_difference</th></tr></thead><tbody><tr><td>2024-01-01</td><td>1000.00</td><td>NULL</td><td>NULL</td></tr><tr><td>2024-02-01</td><td>1500.00</td><td>1000.00</td><td>500.00</td></tr><tr><td>2024-03-01</td><td>1200.00</td><td>1500.00</td><td>-300.00</td></tr><tr><td>2024-04-01</td><td>1700.00</td><td>1200.00</td><td>500.00</td></tr></tbody></table><p>Âú®Ëøô‰∏™Êü•ËØ¢‰∏≠Ôºö<br>previous_month_sales ÊòæÁ§∫‰∫ÜÂâç‰∏Ä‰∏™ÊúàÁöÑÈîÄÂîÆÈ¢ù„ÄÇ<br>sales_difference ÊòæÁ§∫‰∫ÜÂΩìÂâçÊúà‰∏éÂâç‰∏Ä‰∏™ÊúàÁöÑÈîÄÂîÆÈ¢ùÂ∑ÆÂºÇ„ÄÇ<br>ÈÄöËøá‰∏äËø∞Êü•ËØ¢ÔºåÊàë‰ª¨ÂèØ‰ª•Êñπ‰æøÂú∞ÂàÜÊûêÈîÄÂîÆÊï∞ÊçÆÁöÑÂèòÂåñÊÉÖÂÜµ„ÄÇ</p><h2 id="ÊÄªÁªì"><a href="#ÊÄªÁªì" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h2><p><code>LAG</code> ÂáΩÊï∞ÊòØ‰∏Ä‰∏™Âº∫Â§ßÁöÑÂ∑•ÂÖ∑ÔºåÂèØ‰ª•Â∏ÆÂä©‰Ω†Âú®Êï∞ÊçÆÂàÜÊûê‰∏≠Â§ÑÁêÜË°åÈó¥ÁöÑÊØîËæÉÂíåÂèòÂåñ„ÄÇÊó†ËÆ∫ÊòØÁî®‰∫éÊó∂Èó¥Â∫èÂàóÊï∞ÊçÆ„ÄÅËÆ°ÁÆóÂèòÂåñÈáèÔºåËøòÊòØÁîüÊàêÊªöÂä®Êä•ÂëäÔºåLAG ÂáΩÊï∞ÈÉΩËÉΩÊèê‰æõÊúâ‰ª∑ÂÄºÁöÑ‰ø°ÊÅØ„ÄÇÂÆÉÈÄöÂ∏∏‰∏é <code>OVER</code> Â≠êÂè•‰∏ÄËµ∑‰ΩøÁî®, Âú®OVERÂ≠êÂè•‰∏≠ÔºåÊàë‰ª¨ÂèØ‰ª•ÊåáÂÆöÂàÜÁªÑÊù°‰ª∂„ÄÅÊéíÂ∫èÊù°‰ª∂Á≠â„ÄÇ<code>ORDER BY</code> Á°ÆÂÆöË°åÁöÑÈ°∫Â∫èÔºå<code>PARTITION BY</code> ÂàôÂèØ‰ª•Áî®Êù•Â∞ÜÊï∞ÊçÆÂàÜÁªÑÔºå‰ΩøÊØè‰∏™ÂàÜÁªÑÂÜÖÁöÑËÆ°ÁÆó‰∫íÁõ∏Áã¨Á´ã„ÄÇ</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ÊúÄËøëÂú®ÂÅöÊï∞ÊçÆÂàÜÊûêÔºåÈúÄË¶ÅÊåñÊéòÊï∞ÊçÆÈöèÊó∂Èó¥ÂèòÂåñÁöÑ‰ø°ÊÅØ„ÄÇÊâÄÊúâÊï∞ÊçÆÁâ©ÁêÜÂ≠òÂÇ®Âú®AWS S3‰∏äÔºåÈÄöËøáAWS Glue CatalogÂíåAWS AthenaËøõË°åÊï∞ÊçÆÊü•ËØ¢„ÄÇAWS AthenaÊîØÊåÅSQLËØ≠Ë®ÄÔºåÂèØ‰ª•ÂØπÊï∞ÊçÆËøõË°åÂàÜÊûê„ÄÇÂú®Â§ÑÁêÜÊó∂Èó¥Â∫èÂàóÊï∞ÊçÆÊàñÂàÜÊûêË°åÈó¥ÂèòÂåñÊó∂Ôºå SQL‰∏≠ÁöÑ &lt;code&gt;L</summary>
      
    
    
    
    <category term="Database" scheme="https://stonefishy.github.io/categories/Database/"/>
    
    
    <category term="Big Data" scheme="https://stonefishy.github.io/tags/Big-Data/"/>
    
    <category term="MySQL" scheme="https://stonefishy.github.io/tags/MySQL/"/>
    
    <category term="SQL" scheme="https://stonefishy.github.io/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>How to query tree-structured relation data in MySQL</title>
    <link href="https://stonefishy.github.io/2024/08/02/how-to-query-tree-structured-relation-data-in-mysql/"/>
    <id>https://stonefishy.github.io/2024/08/02/how-to-query-tree-structured-relation-data-in-mysql/</id>
    <published>2024-08-02T10:08:52.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>To query hierarchical relational data in <code>MySQL</code>, <code>recursive Common Table Expressions (CTEs)</code> are typically used. However, MySQL did not support recursive CTEs before version 8.0, so in earlier versions, <code>self-joins</code> are commonly used to handle such queries. Below is an example using a self-join, assuming we have a table employees that contains information about employees and their manager IDs (manager_id).</p><h2 id="Create-Table-and-Insert-Data"><a href="#Create-Table-and-Insert-Data" class="headerlink" title="Create Table and Insert Data"></a>Create Table and Insert Data</h2><p>Creating a table named <code>employees</code> with the following columns:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> employees (</span><br><span class="line">    id <span class="type">INT</span> <span class="keyword">PRIMARY</span> KEY,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>),</span><br><span class="line">    manager_id <span class="type">INT</span>,</span><br><span class="line">    <span class="keyword">FOREIGN</span> KEY (manager_id) <span class="keyword">REFERENCES</span> employees(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> employees (id, name, manager_id) <span class="keyword">VALUES</span></span><br><span class="line">(<span class="number">1</span>, <span class="string">&#x27;CEO&#x27;</span>, <span class="keyword">NULL</span>),</span><br><span class="line">(<span class="number">2</span>, <span class="string">&#x27;CTO&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">3</span>, <span class="string">&#x27;CFO&#x27;</span>, <span class="number">1</span>),</span><br><span class="line">(<span class="number">4</span>, <span class="string">&#x27;Developer Lead&#x27;</span>, <span class="number">2</span>),</span><br><span class="line">(<span class="number">5</span>, <span class="string">&#x27;Accountant Lead&#x27;</span>, <span class="number">3</span>),</span><br><span class="line">(<span class="number">6</span>, <span class="string">&#x27;Developer&#x27;</span>, <span class="number">4</span>),</span><br><span class="line">(<span class="number">7</span>, <span class="string">&#x27;Junior Developer&#x27;</span>, <span class="number">4</span>),</span><br><span class="line">(<span class="number">8</span>, <span class="string">&#x27;Senior Accountant&#x27;</span>, <span class="number">5</span>),</span><br><span class="line">(<span class="number">9</span>, <span class="string">&#x27;Junior Accountant&#x27;</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure><h2 id="Self-Join"><a href="#Self-Join" class="headerlink" title="Self-Join"></a>Self-Join</h2><p>We can search for all employees and their direct reports (subordinates) using a self-join. The following SQL statement will list all employees and their direct manager‚Äôs name.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.name <span class="keyword">AS</span> employee_name, e2.name <span class="keyword">AS</span> manager_name</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e2 <span class="keyword">ON</span> e1.manager_id <span class="operator">=</span> e2.id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> e1.manager_id, e1.id;</span><br></pre></td></tr></table></figure><p>We can also use a self-join to count the number of direct reports for each manager. The following SQL statement will list all managers and the number of their direct reports.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> e1.name <span class="keyword">AS</span> manager_name, <span class="built_in">COUNT</span>(e2.id) <span class="keyword">AS</span> subordinate_count</span><br><span class="line"><span class="keyword">FROM</span> employees e1</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> employees e2 <span class="keyword">ON</span> e1.id <span class="operator">=</span> e2.manager_id</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> e1.id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> subordinate_count <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h2 id="Recursive-Common-Table-Expressions-CTEs"><a href="#Recursive-Common-Table-Expressions-CTEs" class="headerlink" title="Recursive Common Table Expressions (CTEs)"></a>Recursive Common Table Expressions (CTEs)</h2><p>MySQL 8.0 introduced support for recursive CTEs, which allows us to query hierarchical relational data more efficiently. The following SQL statement will list all employees and their direct reports (subordinates) using a recursive CTE.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> subordinates <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> id, name, manager_id</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">1</span> <span class="comment">-- root node CEO, we can replace with any other root node ID, for example 2 which is CTO</span></span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> e.id, e.name, e.manager_id</span><br><span class="line">    <span class="keyword">FROM</span> employees e</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span> subordinates s <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> s.id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> subordinates;</span><br></pre></td></tr></table></figure><p>But please note that this method only works for <code>MySQL 8.0</code> and above, as these versions support <code>recursive CTEs</code>.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;To query hierarchical relational data in &lt;code&gt;MySQL&lt;/code&gt;, &lt;code&gt;recursive Common Table Expressions (CTEs)&lt;/code&gt; are typically used. H</summary>
      
    
    
    
    <category term="Database" scheme="https://stonefishy.github.io/categories/Database/"/>
    
    
    <category term="MySQL" scheme="https://stonefishy.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL 8.x CTEs feature - WITH clause</title>
    <link href="https://stonefishy.github.io/2024/07/26/mysql-8-x-ctes-feature-with-clause/"/>
    <id>https://stonefishy.github.io/2024/07/26/mysql-8-x-ctes-feature-with-clause/</id>
    <published>2024-07-26T09:19:59.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL <code>Common Table Expressions (CTEs)</code> are a powerful feature introduced in <code>MySQL 8.0</code>. CTEs are a type of MySQL 8.0 that provide a way to create <code>temporary result sets</code> that can be referenced within a <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, or <code>DELETE</code> statement. <span class='pbg danger'>The primary purpose of `CTEs` is to make complex queries more readable and manageable by breaking them down into simpler</span>.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/mysql/mysql-cte-with-clause.png" class="lazyload placeholder" data-srcset="/assets/images/mysql/mysql-cte-with-clause.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="MYSQL CTEs feature - WITH clause" style="width:600px;"/></div><span class="image-caption">MYSQL CTEs feature - WITH clause</span></div><h2 id="Purpose-of-CTEs"><a href="#Purpose-of-CTEs" class="headerlink" title="Purpose of CTEs"></a>Purpose of CTEs</h2><ul><li><strong>Readability</strong>: <code>CTEs</code> can make SQL queries more readable, especially for complex queries involving multiple subqueries or recursive operations.</li><li><strong>Modularity</strong>: They allow you to define a temporary result set that can be reused within the same query, promoting code reuse and reducing redundancy.</li><li><strong>Recursive Queries</strong>: CTEs support recursive queries, which are useful for querying hierarchical data like organizational charts, bill of materials, or tree structures.</li></ul><h2 id="How-to-Use-CTEs"><a href="#How-to-Use-CTEs" class="headerlink" title="How to Use CTEs"></a>How to Use CTEs</h2><p><code>CTEs</code> are defined using the <code>WITH</code> clause and can be referenced within the main query. Here‚Äôs the basic syntax:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> cte_name <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> ...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> ... <span class="keyword">FROM</span> cte_name;</span><br></pre></td></tr></table></figure><h3 id="Basic-CTE"><a href="#Basic-CTE" class="headerlink" title="Basic CTE"></a>Basic CTE</h3><p>Suppose you have a table employees and you want to find the average salary of employees in each department.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> DepartmentSalaries <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> department_id, <span class="built_in">AVG</span>(salary) <span class="keyword">AS</span> avg_salary</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> department_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> DepartmentSalaries;</span><br></pre></td></tr></table></figure><p>In this example, DepartmentSalaries is a CTE that calculates the average salary for each department. The main query then selects from this CTE.</p><p><code>CTEs</code> feature also supports multiple temporary result sets in the same query, see below example:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span></span><br><span class="line">  cte1 <span class="keyword">AS</span> (<span class="keyword">SELECT</span> a, b <span class="keyword">FROM</span> table1),</span><br><span class="line">  cte2 <span class="keyword">AS</span> (<span class="keyword">SELECT</span> c, d <span class="keyword">FROM</span> table2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> b, d <span class="keyword">FROM</span> cte1 <span class="keyword">JOIN</span> cte2 <span class="keyword">WHERE</span> cte1.a <span class="operator">=</span> cte2.c;</span><br></pre></td></tr></table></figure><p>Above sqls defines two CTEs cte1 and cte2 and then joins them using a WHERE clause.</p><h3 id="Recursive-CTE"><a href="#Recursive-CTE" class="headerlink" title="Recursive CTE"></a>Recursive CTE</h3><p>A CTE can refer to itself to define a <code>recursive CTE</code>. Common applications of recursive CTEs include series generation and traversal of hierarchical or tree-structured data.</p><p>Suppose you have a table employees with a self-referencing column manager_id to represent a hierarchy. You want to find all subordinates of a given manager.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> <span class="keyword">RECURSIVE</span> Subordinates <span class="keyword">AS</span> (</span><br><span class="line">    <span class="keyword">SELECT</span> employee_id, manager_id, name</span><br><span class="line">    <span class="keyword">FROM</span> employees</span><br><span class="line">    <span class="keyword">WHERE</span> manager_id <span class="operator">=</span> <span class="number">1</span>  <span class="comment">-- Starting with the manager ID 1</span></span><br><span class="line">    <span class="keyword">UNION</span> <span class="keyword">ALL</span></span><br><span class="line">    <span class="keyword">SELECT</span> e.employee_id, e.manager_id, e.name</span><br><span class="line">    <span class="keyword">FROM</span> employees e</span><br><span class="line">    <span class="keyword">INNER</span> <span class="keyword">JOIN</span> Subordinates s <span class="keyword">ON</span> e.manager_id <span class="operator">=</span> s.employee_id</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> Subordinates;</span><br></pre></td></tr></table></figure><p>In this example, Subordinates is a recursive CTE that starts with employees directly reporting to manager ID 1 and then recursively includes all their subordinates.</p><h2 id="Key-Points"><a href="#Key-Points" class="headerlink" title="Key Points"></a>Key Points</h2><ul><li><strong>Non-Recursive CTEs</strong>: These are straightforward and do not involve recursion. They are simply a way to define a temporary result set for use within the query.</li><li><strong>Recursive CTEs</strong>: These involve recursion and are useful for hierarchical or tree-structured data. They must include a <code>UNION ALL</code> clause to combine the initial result set with the recursive result set.</li><li><strong>Scope</strong>: CTEs are scoped to the query they are defined in and cannot be referenced outside of that query.</li></ul><p><code>CTEs</code> are a powerful tool in MySQL that can significantly improve the <code>readability</code> and <code>maintainability</code> of <code>complex SQL queries</code>.</p><h2 id="Reference-Links"><a href="#Reference-Links" class="headerlink" title="Reference Links:"></a>Reference Links:</h2><p>For other scenarios, like use <code>WITH</code> clause in <code>UPDATE</code> or <code>DELETE</code> statements, please refer to the following links:</p><ul><li><strong>WITH (Common Table Expressions)</strong>: <a href="https://dev.mysql.com/doc/refman/8.4/en/with.html">https://dev.mysql.com/doc/refman/8.4/en/with.html</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;MySQL &lt;code&gt;Common Table Expressions (CTEs)&lt;/code&gt; are a powerful feature introduced in &lt;code&gt;MySQL 8.0&lt;/code&gt;. CTEs are a type of MySQL </summary>
      
    
    
    
    <category term="Database" scheme="https://stonefishy.github.io/categories/Database/"/>
    
    
    <category term="MySQL" scheme="https://stonefishy.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Using Pulumi to Import the AWS Resources of the Other Region</title>
    <link href="https://stonefishy.github.io/2024/07/04/using-pulumi-to-import-the-aws-resources-of-the-other-region/"/>
    <id>https://stonefishy.github.io/2024/07/04/using-pulumi-to-import-the-aws-resources-of-the-other-region/</id>
    <published>2024-07-04T10:27:55.000Z</published>
    <updated>2025-02-07T03:24:32.613Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>By default, the Pulumi import the resource in the region which is specified in the <code>Pulumi.yaml</code> or <code>Pulumi.&lt;stack-name&gt;.yaml</code> file. If we import the resources which is located in other regions. It will cause the error by using <code>pulumi import</code> command.</p><p>For example, we have quicksight resources such like DataSource, DataSet located in the <code>eu-west-1</code> region, we already manage these resources in the pulumi by using <code>pulumi import</code> CLI command. All resources are located in <code>eu-west-1</code> region. It is specified in the <code>Pulumi.yaml</code> or <code>Pulumi.&lt;stack-name&gt;.yaml</code> file like below.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">aws:region:</span> <span class="string">eu-west-1</span></span><br></pre></td></tr></table></figure><p>Now we also want to import the existing resources such like QuickSight user Groups into the pulumi. But the AWS Quicksight user Groups resources all are located in the <code>us-east-1</code> region. The pulumi will give us the error if we try to import the other region resource direclty.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/pulumi/pulumi-import-other-region-resource-error.png" class="lazyload placeholder" data-srcset="/assets/images/pulumi/pulumi-import-other-region-resource-error.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><p>This is because the Pulumi is using default <code>provider</code> for the AWS resources. The default provider is set to the region which is specified in the <code>Pulumi.yaml</code> or <code>Pulumi.&lt;stack-name&gt;.yaml</code> file. So, if we want to import the resources from other region, we need to specify the provider for that region.</p><h2 id="Pulumi-Provider"><a href="#Pulumi-Provider" class="headerlink" title="Pulumi Provider"></a>Pulumi Provider</h2><p>A <code>Pulumi provider</code> is a plugin that enables Pulumi to interact with a specific cloud provider or service. These providers are responsible for translating the Pulumi code into the appropriate API calls for the target cloud platform. </p><p>By default, each provider uses its package‚Äôs global configuration settings, which are controlled by your stack‚Äôs configuration. You can set information such as your cloud provider credentials with environment variables and configuration files. If you store this data in standard locations, Pulumi knows how to retrieve them. For example, you can run below command to set the AWS region to <code>eu-west-1</code> region for the AWS provider configuration.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulumi config set aws:region eu-west-1</span><br></pre></td></tr></table></figure><p>This command actually will set the <code>aws:region</code> configuration value for the AWS provider in your Pulumi stack yaml file. You can also define the provider in your pulumi code, and create related resources in the specified region.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pulumi</span><br><span class="line"><span class="keyword">import</span> pulumi_aws <span class="keyword">as</span> aws</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a new provider for the us-east-1 region</span></span><br><span class="line">us_east_1_provider = aws.Provider(<span class="string">&#x27;us-east-1&#x27;</span>, region=<span class="string">&#x27;us-east-1&#x27;</span>)</span><br><span class="line"><span class="comment"># Create the Quicksight Groups resources in the us-east-1 region</span></span><br><span class="line">quicksight_group = aws.quicksight.Group(</span><br><span class="line">    <span class="string">&quot;dev&quot;</span>,</span><br><span class="line">    aws_account_id=<span class="string">&quot;&lt;aws-account-id&gt;&quot;</span>,</span><br><span class="line">    group_name=<span class="string">&quot;dev&quot;</span>,</span><br><span class="line">    opts=pulumi.ResourceOptions(</span><br><span class="line">        provider=us_east_1_provider</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>In above code, we create a new provider for the <code>us-east-1</code> region and then create the Quicksight user Groups resources in the <code>us-east-1</code> region. The <code>provider</code> option is used to specify the provider to use for the resource. Even we have global configuration for the <code>eu-west-1</code> region, we can still create the resources in the <code>us-east-1</code> region by specifying the provider.</p><h2 id="Importing-the-AWS-Resources-of-the-Other-Region"><a href="#Importing-the-AWS-Resources-of-the-Other-Region" class="headerlink" title="Importing the AWS Resources of the Other Region"></a>Importing the AWS Resources of the Other Region</h2><p>Back to previous topic, if we want to import the AWS Quicksight Users and Groups resources from the <code>us-east-1</code> region in current pulumi stack from the command line, we need to specify the provider for the pulumi command line. The Pulumi CLI import command takes an additional <code>--provider</code> option to specify the provider to use for the import.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulumi import aws:quicksight/group:Group dev xxxxxx/default/dev --provider name=urn</span><br></pre></td></tr></table></figure><p>In above command, we are importing the <code>aws:quicksight/group:Group</code> resource with the <code>dev</code> name in the provider. For the <code>--provider</code> option, The <code>name</code> is the name of the provider to use for the import, and <code>urn</code> is the URN of the provider to use for the import. Typically, the resource urns in pulumis is below format.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urn:pulumi:production::acmecorp-website::custom:resources:Resource$aws:s3/bucket:Bucket::my-bucket</span><br><span class="line">           ^^^^^^^^^^  ^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^^^^^^ ^^^^^^^^^^^^^^^^^^^^  ^^^^^^^^^</span><br><span class="line">           &lt;stack-name&gt; &lt;project-name&gt;   &lt;parent-type&gt;             &lt;resource-type&gt;       &lt;resource-name&gt;</span><br></pre></td></tr></table></figure><p>If there is no <code>parent-type</code> in the resource urn, the urns will be like below format.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urn:pulumi:production::acmecorp-website::aws:s3/bucket:Bucket::my-bucket</span><br><span class="line">           ^^^^^^^^^^  ^^^^^^^^^^^^^^^^  ^^^^^^^^^^^^^^^^^^^^  ^^^^^^^^^</span><br><span class="line">           &lt;stack-name&gt; &lt;project-name&gt;   &lt;resource-type&gt;       &lt;resource-name&gt;</span><br></pre></td></tr></table></figure><p>For the details of Pulumi Resources URNs, please refer to the <a href="https://www.pulumi.com/docs/concepts/resources/names/#urns">Pulumi URNs</a>.</p><p>In our scenario, we can import the Quicksight Groups resources from the <code>us-east-1</code> region by using the provider. <span class='pbg warning'>There is one thing is important to note</span> For example, we don‚Äôt have any <code>Provider</code> resources for the <code>us-east-1</code> region in our current stack. If we run below command to import the Quicksight Groups resources from the <code>us-east-1</code> region, it will fail. Below is an examle of the full import resource with <code>--provider</code> option</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pulumi import aws:quicksight/group:Group dev &lt;aws-account-id&gt;/default/dev --provider us_east_1_provider=urn:pulumi:&lt;pulumi-project-name&gt;::quicksight::pulumi:providers:aws::us_east_1_provider</span><br></pre></td></tr></table></figure><p>The <code>&lt;aws-account-id&gt;</code> and <code>&lt;pulumi-project-name&gt;</code> are placeholder just for example. Without the <code>Provider</code> resource for the <code>us-east-1</code> region, the import command will fail as below error message.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Preview failed: bad provider reference &#x27;us_east_1_provider=urn:pulumi:&lt;pulumi-project-name&gt;::quicksight::pulumi:providers:aws::us_east_1_provider&#x27; is not valid URN&#x27;</span><br></pre></td></tr></table></figure><p>The error full screenshot is below.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/pulumi/pulumi-import-without-provider-error.png" class="lazyload placeholder" data-srcset="/assets/images/pulumi/pulumi-import-without-provider-error.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><p>To fix this issue, we need to create the <code>Provider</code> resource for the <code>us-east-1</code> region in our current stack. We can do this by adding the <code>Provider</code> resource in in our Pulumi code and using <code>Pulumi up</code> command to create the resource.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pulumi</span><br><span class="line"><span class="keyword">import</span> pulumi_aws <span class="keyword">as</span> aws</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a new provider for the us-east-1 region</span></span><br><span class="line">us_east_1_provider = aws.Provider(<span class="string">&#x27;us-east-1&#x27;</span>, region=<span class="string">&#x27;us-east-1&#x27;</span>)</span><br></pre></td></tr></table></figure><p>After that, we can run the import command again to import the Quicksight Groups resources from the <code>us-east-1</code> region. And now you will see the Quicksight Groups resources of the <code>us-east-1</code> region in your pulumi stack.</p><div class="img-wrap"><div class="img-bg"><img class="img lazyload placeholder" src="/assets/images/pulumi/pulumi-import-provider-success.png" class="lazyload placeholder" data-srcset="/assets/images/pulumi/pulumi-import-provider-success.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp"/></div></div><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>To import the AWS resources of the other region, we need to specify the provider for the pulumi command line. The Pulumi CLI import command takes an additional <code>--provider</code> option to specify the provider to use for the import. The <code>provider</code> resource should be created in pulumi before importing the resources of the other region resource.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Context&quot;&gt;&lt;a href=&quot;#Context&quot; class=&quot;headerlink&quot; title=&quot;Context&quot;&gt;&lt;/a&gt;Context&lt;/h2&gt;&lt;p&gt;By default, the Pulumi import the resource in the </summary>
      
    
    
    
    <category term="Cloud" scheme="https://stonefishy.github.io/categories/Cloud/"/>
    
    
    <category term="Python" scheme="https://stonefishy.github.io/tags/Python/"/>
    
    <category term="Pulumi" scheme="https://stonefishy.github.io/tags/Pulumi/"/>
    
    <category term="Cloud" scheme="https://stonefishy.github.io/tags/Cloud/"/>
    
    <category term="AWS" scheme="https://stonefishy.github.io/tags/AWS/"/>
    
    <category term="IaC" scheme="https://stonefishy.github.io/tags/IaC/"/>
    
  </entry>
  
</feed>
